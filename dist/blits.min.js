var e={currentView:Symbol("currentView"),cursorTagStart:Symbol("cursorTagStart"),computedKeys:Symbol("computedKeys"),destroy:Symbol("destroy"),getChildren:Symbol("getChildren"),holder:Symbol("holder"),id:Symbol("id"),identifier:Symbol("identifier"),index:Symbol("index"),init:Symbol("init"),inputEvents:Symbol("inputEvents"),intervals:Symbol("intervals"),level:Symbol("level"),methodKeys:Symbol("methodKeys"),originalState:Symbol("originalState"),propKeys:Symbol("propKeys"),raw:Symbol("raw"),ready:Symbol("ready"),renderer:Symbol("renderer"),routes:Symbol("routes"),settings:Symbol("settings"),state:Symbol("state"),stateKeys:Symbol("stateKeys"),textnode:Symbol("textnode"),timeouts:Symbol("timeouts"),type:Symbol("type"),watchers:Symbol("watchers"),watchKeys:Symbol("watchKeys"),wrapper:Symbol("wrapper"),children:Symbol.for("children"),components:Symbol.for("components"),isSlot:Symbol.for("isSlot"),props:Symbol.for("props"),slots:Symbol.for("slots"),componentType:Symbol.for("componentType")};const t={[e.settings]:{},get(t,r=null){return t in this[e.settings]?this[e.settings][t]:r},set(t,r){"object"==typeof t?Object.keys(t).forEach((e=>{this.set(e,t[e])})):this[e.settings][t]=r}},r=()=>{},s=()=>(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),n=e=>{const n=t.get("debugLevel"),i={};return Object.defineProperty(i,"info",{get:()=>(n>=1||Array.isArray(n)&&n.indexOf("info")>-1)&&console.info.bind(window.console,`%c ⚡️ ${e} %c ${s()}`,"background-color: #0284c7; color: white; padding: 3px 6px 3px 1px; border-radius: 3px","color: ##94a3b8;")||r}),Object.defineProperty(i,"warn",{get:()=>(n>=1||Array.isArray(n)&&n.indexOf("warn")>-1)&&console.warn.bind(window.console,`%c ⚡️ ${e} %c ${s()}`,"background-color: #fbbf24; color: white; padding: 3px 6px 3px 1px; border-radius: 3px","color: ##94a3b8;")||r}),Object.defineProperty(i,"error",{get:()=>(n>=1||Array.isArray(n)&&n.indexOf("error")>-1)&&console.error.bind(window.console,`%c ⚡️ ${e} %c ${s()}`,"background-color: #dc2626; color: white; padding: 3px 6px 3px 1px; border-radius: 3px","color: ##94a3b8;")||r}),Object.defineProperty(i,"debug",{get:()=>(n>=2||Array.isArray(n)&&n.indexOf("debug")>-1)&&console.debug.bind(window.console,`%c ⚡️ ${e} %c (${(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})})`,"background-color: #e2e8f0; color: #334155; padding: 3px 6px 3px 1px; border-radius: 3px","color: ##94a3b8;")||r}),i};let i;var o={aliceblue:"0xf0f8ffff",antiquewhite:"0xfaebd7ff",aqua:"0xffffff00",aquamarine:"0x7fffd4ff",azure:"0xf0ffffff",beige:"0xf5f5dcff",bisque:"0xffe4c4ff",black:"0x000000ff",blanchedalmond:"0xffebcdff",blue:"0x0000ffff",blueviolet:"0x8a2be2ff",brown:"0xa52a2aff",burlywood:"0xdeb887ff",cadetblue:"0x5f9ea0ff",chartreuse:"0x7fff00ff",chocolate:"0xd2691eff",coral:"0xff7f50ff",cornflowerblue:"0x6495edff",cornsilk:"0xfff8dcff",crimson:"0xdc143cff",cyan:"0x00ffffff",darkblue:"0x00008bff",darkcyan:"0x008b8bff",darkgoldenrod:"0xb8860bff",darkgray:"0xa9a9a9ff",darkgreen:"0x006400ff",darkgrey:"0xa9a9a9ff",darkkhaki:"0xbdb76bff",darkmagenta:"0x8b008bff",darkolivegreen:"0x556b2fff",darkorange:"0xff8c00ff",darkorchid:"0x9932ccff",darkred:"0x8b0000ff",darksalmon:"0xe9967aff",darkseagreen:"0x8fbc8fff",darkslateblue:"0x483d8bff",darkslategray:"0x2f4f4fff",darkslategrey:"0x2f4f4fff",darkturquoise:"0x00ced1ff",darkviolet:"0x9400d3ff",deeppink:"0xff1493ff",deepskyblue:"0x00bfffff",dimgray:"0x696969ff",dimgrey:"0x696969ff",dodgerblue:"0x1e90ffff",firebrick:"0xb22222ff",floralwhite:"0xfffaf0ff",forestgreen:"0x228b22ff",fuchsia:"0xff00ffff",gainsboro:"0xdcdcdcff",ghostwhite:"0xf8f8ffff",gold:"0xffd700ff",goldenrod:"0xdaa520ff",gray:"0x808080ff",green:"0x008000ff",greenyellow:"0xadff2fff",grey:"0x808080ff",honeydew:"0xf0fff0ff",hotpink:"0xff69b4ff",indianred:"0xcd5c5cff",indigo:"0x4b0082ff",ivory:"0xfffff0ff",khaki:"0xf0e68cff",lavender:"0xe6e6faff",lavenderblush:"0xfff0f5ff",lawngreen:"0x7cfc00ff",lemonchiffon:"0xfffacdff",lightblue:"0xadd8e6ff",lightcoral:"0xf08080ff",lightcyan:"0xe0ffffff",lightgoldenrodyellow:"0xfafad2ff",lightgray:"0xd3d3d3ff",lightgreen:"0x90ee90ff",lightgrey:"0xd3d3d3ff",lightpink:"0xffb6c1ff",lightsalmon:"0xffa07aff",lightseagreen:"0x20b2aaff",lightskyblue:"0x87cefaff",lightslategray:"0x778899ff",lightslategrey:"0x778899ff",lightsteelblue:"0xb0c4deff",lightyellow:"0xffffe0ff",lime:"0x00ff00ff",limegreen:"0x32cd32ff",linen:"0xfaf0e6ff",magenta:"0xff00ffff",maroon:"0x800000ff",mediumaquamarine:"0x66cdaaff",mediumblue:"0x0000cdff",mediumorchid:"0xba55d3ff",mediumpurple:"0x9370dbff",mediumseagreen:"0x3cb371ff",mediumslateblue:"0x7b68eeff",mediumspringgreen:"0x00fa9aff",mediumturquoise:"0x48d1ccff",mediumvioletred:"0xc71585ff",midnightblue:"0x191970ff",mintcream:"0xf5fffaff",mistyrose:"0xffe4e1ff",moccasin:"0xffe4b5ff",navajowhite:"0xffdeadff",navy:"0x000080ff",oldlace:"0xfdf5e6ff",olive:"0x808000ff",olivedrab:"0x6b8e23ff",orange:"0xffa500ff",orangered:"0xff4500ff",orchid:"0xda70d6ff",palegoldenrod:"0xeee8aaff",palegreen:"0x98fb98ff",paleturquoise:"0xafeeeeff",palevioletred:"0xdb7093ff",papayawhip:"0xffefd5ff",peachpuff:"0xffdab9ff",peru:"0xcd853fff",pink:"0xffc0cbff",plum:"0xdda0ddff",powderblue:"0xb0e0e6ff",purple:"0x800080ff",rebeccapurple:"0x663399ff",red:"0xff0000ff",rosybrown:"0xbc8f8fff",royalblue:"0x4169e1ff",saddlebrown:"0x8b4513ff",salmon:"0xfa8072ff",sandybrown:"0xf4a460ff",seagreen:"0x2e8b57ff",seashell:"0xfff5eeff",sienna:"0xa0522dff",silver:"0xc0c0c0ff",skyblue:"0x87ceebff",slateblue:"0x6a5acdff",slategray:"0x708090ff",slategrey:"0x708090ff",snow:"0xfffafaff",springgreen:"0x00ff7fff",steelblue:"0x4682b4ff",tan:"0xd2b48cff",teal:"0x008080ff",thistle:"0xd8bfd8ff",tomato:"0xff6347ff",transparent:"0x00000000",turquoise:"0x40e0d0ff",violet:"0xee82eeff",wheat:"0xf5deb3ff",white:"0xffffffff",whitesmoke:"0xf5f5f5ff",yellow:"0xffff00ff",yellowgreen:"0x9acd32ff"};const a=/^#?([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i,l=/^(rgba?)\((\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\s*),(\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\s*),(\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\s*)(,(\s*(-?\d+(?:\.\d+)?)\s*))?\)$/,h=/^(hsla?)\((\s*(360|3[0-5][0-9]|[12]?[0-9]{1,2})\s*),(\s*(100|[1-9]?[0-9])\s*)%,(\s*(100|[1-9]?[0-9])\s*)%(,(\s*(1|0(?:\.\d+)?)\s*))?\)$/,c={},d=e=>{if(void 0!==c[e])return c[e];const t=parseInt(e).toString(16).padStart(2,"0");return c[e]=t,t};var u=(e="",t="0xffffffff")=>{if(e=e.toString(),void 0!==o[e])return o[e];if(e.startsWith("0x")&&10===e.length)return o[e]=e,e;if(a.test(e)){3===(e=e.replace("#","").toLowerCase()).length&&(e=e.split("").map((e=>e+e)).join(""));const t="0x"+e.padEnd(8,"f");return o[e]=t,t}const r=l.exec(e);if(r){const t=d(r[3]),s=d(r[5]),n=d(r[7]);let i="ff";if(r[10]&&"rgba"===r[1]){const e=Math.min(Math.max(Math.round(255*parseFloat(r[10])),0),255);i=d(e)}const a="0x"+t+s+n+i;return o[e]=a,a}return h.test(e)?(console.warn("HSL(A) color format is not supported yet"),"0xffffffff"):t};let p;function f(e={children:[]}){const t={renderCode:["const elms = []","let componentType","const rootComponent = component"],effectsCode:[],context:{props:[],components:this.components}};return p=-1,y.call(t,e),t.renderCode.push("return elms"),{render:new Function("parent","component","context","components",t.renderCode.join("\n")),effects:t.effectsCode.map((e=>new Function("component","elms","context","components","rootComponent","effect",e))),context:t.context}}const m=function(e,t=!1,r={key:!1,component:"component.",forceEffect:!1,forloop:!1}){const s=r.forceEffect?this.effectsCode:this.renderCode;t&&s.push(`parent = ${t}`),"key"in e&&(r.key=v(e.key,r.component));const n=r.key?`elms[${p}][${r.key}]`:`elms[${p}]`;r.key&&s.push(`\n      if(elms[${p}] === undefined) {\n        elms[${p}] = {}\n      }\n    `),s.push(`const elementConfig${p} = {}`),r.forloop&&s.push(`if(!${n}) {`),s.push(`\n    ${n} = this.element({parent: parent || 'root'}, component)\n  `),r.forloop&&s.push("}");const i=e.children;delete e.children,"Slot"===e[Symbol.for("componentType")]&&s.push(`elementConfig${p}[Symbol.for('isSlot')] = true`),Object.keys(e).forEach((t=>{if("slot"===t&&s.push(`\n        console.log(component, component[Symbol.for('slots')])\n        elementConfig${p}['parent'] = component[Symbol.for('slots')].filter(slot => slot.ref === '${e.slot}').shift() || component[Symbol.for('slots')][0] || parent\n      `),"key"!==t)if(b(t)){if(r.holder&&":color"===t)return;this.effectsCode.push(`${n}.set('${t.substring(1)}', ${v(e[t],r.component)})`),s.push(`elementConfig${p}['${t.substring(1)}'] = ${v(e[t],r.component)}`)}else s.push(`elementConfig${p}['${t}'] = ${T(e[t],t,r.component)}`)})),!0===r.holder&&s.push(`\n    if(typeof cmp${p} !== 'undefined') {\n      for(let key in cmp${p}.config.props) {\n        delete elementConfig${p}[cmp${p}.config.props[key]]\n      }\n    }\n    `),r.forloop&&s.push(`if(!${n}.nodeId) {`),s.push(`${n}.populate(elementConfig${p})`),r.forloop&&s.push("}"),i&&y.call(this,{children:i},`${n}`,r)},g=function(e,t=!1,r={key:!1,component:"component.",forceEffect:!1,holder:!1,forloop:!1}){const s=r.forceEffect?this.effectsCode:this.renderCode;s.push(`\n    const cmp${p} =\n      (context.components && context.components['${e[Symbol.for("componentType")]}']) || components['${e[Symbol.for("componentType")]}']\n  `),"key"in e&&(r.key=v(e.key,r.component));const n=e.children;delete e.children,m.call(this,e,t,{...r,holder:!0}),t=r.key?`elms[${p}][${r.key}]`:`elms[${p}]`,p++;const i=r.key?`elms[${p}][${r.key}]`:`elms[${p}]`;r.key&&s.push(`\n      if(elms[${p}] === undefined) {\n        elms[${p}] = {}\n      }\n    `),t&&s.push(`parent = ${t}`),s.push(`const props${p} = {}`),Object.keys(e).forEach((t=>{b(t)?(this.effectsCode.push(`\n        ${i}[Symbol.for('props')]['${t.substring(1)}'] = ${v(e[t],r.component)}`),s.push(`props${p}['${t.substring(1)}'] = ${v(e[t],r.component)}`)):s.push(`props${p}['${t}'] = ${T(e[t],t,r.component)}`)})),r.forloop&&s.push(`if(!${i}) {`),s.push(`\n    componentType = props${p}['is'] || '${e[Symbol.for("componentType")]}'\n\n    let component${p}\n    if(typeof componentType === 'string') {\n      component${p} = context.components && context.components[componentType] || components[componentType]\n      if(!component${p}) {\n        throw new Error('Component "${e[Symbol.for("componentType")]}" not found')\n      }\n    } else if(typeof componentType === 'function' && componentType.name === 'factory') {\n      component${p} = componentType\n    }\n\n    ${i} = component${p}.call(null, {props: props${p}}, ${t}, component)\n\n    if (${i}[Symbol.for('slots')][0]) {\n      parent = ${i}[Symbol.for('slots')][0]\n      component = ${i}\n    } else {\n      parent = ${i}[Symbol.for('children')][0]\n    }\n  `),r.forloop&&s.push("}"),n&&(p++,m.call(this,{children:n},!1,{...r}))},x=function(e,t){const r=e[":for"];delete e[":for"];const s=/(.+)\s+in\s+(.+)/gi.exec(r),[n,i="index"]=s[1].replace("(","").replace(")","").split(/\s*,\s*/),o={renderCode:["let componentType"],effectsCode:[],context:{props:[],components:this.components}};t&&o.renderCode.push(`let parent = ${t}`);const a=p;Object.keys(e).forEach((t=>{b(t)&&-1===e[t].indexOf("$"+n)&&o.renderCode.push(`\n        void ${v(e[t],"component.")}\n      `)})),o.renderCode.push(`\n    const collection = ${T(s[2],":for")} || []\n    const keys = new Set()\n    for(let __index = 0; __index < collection.length; __index++) {\n      parent = ${t}\n      const scope = Object.create(component)\n      scope['key'] = __index\n      scope['${i}'] = __index\n      scope['${n}'] = collection[__index]\n    `),"ref"in e&&-1===e.ref.indexOf("$")&&(o.renderCode.push(`\n      scope['__ref'] = '${e.ref}' + __index\n    `),e.ref="$__ref"),"key"in e&&o.renderCode.push(`\n      scope.key = '' + ${v(e.key,"scope.")}\n    `),o.renderCode.push("\n    keys.add(scope.key)\n  "),"Element"===e[Symbol.for("componentType")]||"Slot"===e[Symbol.for("componentType")]||"Text"===e[Symbol.for("componentType")]?m.call(o,e,t,{key:"scope.key",component:"scope.",forceEffect:!1,forloop:!0}):g.call(o,e,!1,{key:"scope.key",component:"scope.",forceEffect:!1,forloop:!0}),o.renderCode.push(`if(!elms[${p}][scope.key].___hasEffect) {`),o.effectsCode.forEach((e=>{o.renderCode.push(`\n        effect(() => {\n          ${e}\n        })\n    `)})),o.renderCode.push(`\n    elms[${p}][scope.key].___hasEffect = true\n  }\n  `),o.renderCode.push("}");const l=p;o.renderCode.push(`\n   component = rootComponent\n   if(elms[${a}]) {\n      const all = Object.keys(elms[${a}])\n      let i = all.length\n      while (i--) {\n        const key = all[i]\n        if (!keys.has(key)) {\n    `);for(let e=a;e<=l;e++)o.renderCode.push(`\n      elms[${e}][key] && elms[${e}][key].destroy()\n      delete elms[${e}][key]\n    `);o.renderCode.push(`\n        }\n      }\n      if(elms[${a}][0] && elms[${a}][0].forComponent && elms[${a}][0].forComponent.___layout) {\n        elms[${a}][0].forComponent.___layout()\n      }\n    }\n  `),this.effectsCode.push(o.renderCode.join("\n"))},y=function(e,t=!1,r={}){e.children&&e.children.forEach((e=>{p++,Object.keys(e).indexOf(":for")>-1?x.call(this,e,t):"Element"===e[Symbol.for("componentType")]||"Slot"===e[Symbol.for("componentType")]||"Text"===e[Symbol.for("componentType")]?("Text"===e[Symbol.for("componentType")]&&(e.__textnode="true"),m.call(this,e,t,r)):g.call(this,e,t,r)}))},v=(e,t="component.")=>{const r=e.matchAll(/('.*?')+/gi),s=[];let n=0;for(const t of r)s.push(t[0]),e=e.replace(t[0],`[@@REPLACEMENT${n}@@]`),n++;return e=e.replace(/\$/gi,t),s.forEach(((t,r)=>{e=e.replace(`[@@REPLACEMENT${r}@@]`,t)})),e},T=(e="",t=!1,r="component.")=>{let s;if("content"===t)if(e.startsWith("$"))s=`${r}${e.replace("$","")}`;else{const t=e.replace(/\\\\/g,"__DOUBLE_BACKSLASH__").replace(/(^|[^\\])'/g,"$1\\'").replace(/__DOUBLE_BACKSLASH__/g,"\\\\");s=`'${w(t,r)}'`}else if("color"===t||isNaN(parseFloat(e)))if("true"===e.toLowerCase())s=!0;else if("false"===e.toLowerCase())s=!1;else if(t.startsWith("@")&&e){const t=r.slice(0,-1);s=`${t}['${e.replace("$","")}'] && ${t}['${e.replace("$","")}'].bind(${t})`}else s=e.startsWith("$")?`${r}${e.replace("$","")}`:`"${e}"`;else if(s=parseFloat(e),e.endsWith("%")){const e={w:"width",width:"width",x:"width",h:"height",height:"height",y:"height"}[t];e&&(s=`parent.node.${e} * (${s} / 100)`)}return s},b=e=>e.startsWith(":"),w=(e,t)=>{const r=[...e.matchAll(/\{\{\s*(\$\S+)\s*\}\}/g)];if(r.length)for(let[s,n]of r)e=e.replace(s,`${n.replace("$",`'+${t}`)}+'`);return e},S={};let _=0;const R={},E=(e,t,r,s=[])=>{R[t]&&R[t][e]&&R[t][e].apply(r,s)};let C=null,A=!1;const M=new WeakMap,I=[],F=(e,t)=>{if(C){if(A)return void I.push({target:e,key:t,currentEffect:C});let r=M.get(e);r||(r=new Map,M.set(e,r));let s=r.get(t);s||(s=new Set,r.set(t,s)),s.add(C)}},L=(e,t,r=!1)=>{if(A)return;const s=M.get(e);if(!s)return;const n=s.get(t);if(n)for(let e of n)e(r)},P=e=>{C=e,C(),C=null},k=["push","pop","shift","unshift","splice"],B=new WeakMap,U=t=>{const r=t&&t[e.raw];return r?U(r):t},O=(t,r=null,s)=>{if("object"==typeof t&&t[e.id]||"_ImageTexture"===t.constructor.name)return t;const n=(i=t,B.get(i));var i;if(n)return n;const o=new Proxy(t,{get:(n,i,o)=>i===e.raw?t:Array.isArray(n)?k.indexOf(i)>-1?function(...e){A=!0;const t=n[i].apply(this,e);return(()=>{A=!1;for(let e=0;e<I.length;e++){const t=I[e];C=t.currentEffect,F(t.target,t.key)}I.length=0})(),L(r,s),t}:"object"==typeof n[i]&&null!==n[i]?(Array.isArray(n[i])&&F(n,i),O(n[i],n,i)):Reflect.get(n,i,o):"object"==typeof n[i]&&null!==n[i]?(Array.isArray(n[i])&&F(n,i),O(n[i],n,i)):(F(n,i),Reflect.get(n,i,o)),set(e,t,n,i){const o=U(e[t]),a=U(n);let l=!0;return o!==a&&(l=Reflect.set(e,t,n,i)),l&&o!==a&&(Array.isArray(e)&&t in e&&L(r,s,!0),L(e,t,!0)),l}});return B.set(t,o),o},$=e=>(Object.keys(e).forEach((t=>{let r=e[t];if(null!==e[t]&&"object"==typeof e[t]){if(Object.getPrototypeOf(e[t])===Object.prototype)return $(e[t]);if(Array.isArray(e[t]))for(let r=0;r<k.length-1;r++)e[t][k[r]]=function(s){Array.prototype[k[r]].call(this,s),L(e,t)}}Object.defineProperty(e,t,{enumerable:!0,configurable:!0,get:()=>(F(e,t),r),set(s){r!==s&&(r=s,L(e,t))}})})),e),D=(e,t="Proxy")=>"defineProperty"===t?$(e):O(e),N=["init","ready","focus","unfocus","destroy","attach","detach","enter","exit"];var z={previous:null,current:null,get state(){return this.current},set state(t){N.indexOf(t)>-1&&(t!==this.current||"focus"===t)&&(i.debug(`Setting lifecycle state from ${this.current} to ${t} for ${this.component.componentId}`),this.previous=this.current,this.current=t,((t,r,s)=>{const n=e[t];R[r]&&R[r][n]&&R[r][n].apply(s)})(t,this.component[e.identifier],this.component),E(t,this.component[e.identifier],this.component))}};function G(e,t){if(!j()&&!e)throw new Error(t||"Assertion failed")}function X(e,t,r){const s=Math.trunc(e>>>24),n=Math.trunc(e>>>16&255),i=Math.trunc(e>>>8&255),o=Math.trunc(255&e),a=Math.trunc(t>>>24),l=Math.trunc(t>>>16&255),h=Math.trunc(t>>>8&255),c=Math.trunc(255&t);return(Math.round(a*r+s*(1-r))<<24|Math.round(l*r+n*(1-r))<<16|Math.round(h*r+i*(1-r))<<8|Math.round(c*r+o*(1-r)))>>>0}function V(e,t){return(e>>>24<<24|(e>>>16&255)<<16|(e>>>8&255)<<8|Math.trunc((255&e)*t))>>>0}let W=!0;function Y(e,t,r=!1){const s=(255&e)/255*t,n=W?s:1,i=Math.trunc((e>>>24)*n),o=Math.trunc((e>>>16&255)*n),a=Math.trunc((e>>>8&255)*n),l=Math.trunc(255*s);return r?(l<<24|a<<16|o<<8|i)>>>0:(i<<24|o<<16|a<<8|l)>>>0}function H(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function j(){return import.meta.env&&import.meta.env.PROD}let K=1;class q{eventListeners={};on(e,t){let r=this.eventListeners[e];r||(r=[]),r.push(t),this.eventListeners[e]=r}off(e,t){const r=this.eventListeners[e];if(!r)return;if(!t)return void delete this.eventListeners[e];const s=r.indexOf(t);s>=0&&r.splice(s,1)}once(e,t){const r=(s,n)=>{this.off(e,r),t(s,n)};this.on(e,r)}emit(e,t){const r=this.eventListeners[e];r&&[...r].forEach((e=>{e(this,t)}))}removeAllListeners(){this.eventListeners={}}}const Z=/^(data|ftps?|https?):/,Q=e=>[(e>>>24)/255,(e>>>16&255)/255,(e>>>8&255)/255,(255&e)/255];function J(e){return(255&e)/255}function ee(e){return`rgba(${Math.floor(255*e[0])},${Math.floor(255*e[1])},${Math.floor(255*e[2])},${Math.floor(255*e[3]).toFixed(4)})`}function te(e,t,r,s,n){return n?(n.x1=e,n.y1=t,n.x2=r,n.y2=s,n):{x1:e,y1:t,x2:r,y2:s}}function re(e,t){return e.x1<t.x2&&e.x2>t.x1&&e.y1<t.y2&&e.y2>t.y1}function se(e,t,r){const s=Math.max(e.x,t.x),n=Math.max(e.y,t.y),i=Math.min(e.x+e.width,t.x+t.width)-s,o=Math.min(e.y+e.height,t.y+t.height)-n;return i>0&&o>0?r?(r.x=s,r.y=n,r.width=i,r.height=o,r):{x:s,y:n,width:i,height:o}:r?(r.x=0,r.y=0,r.width=0,r.height=0,r):{x:0,y:0,width:0,height:0}}function ne(e,t){return t?(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t):{x:e.x,y:e.y,width:e.width,height:e.height}}function ie(e,t){return e.x1<=t.x2&&e.y1<=t.y2&&e.x2>=t.x1&&e.y2>=t.y1}class oe{ta;tb;tx;tc;td;ty;_floatArr=null;mutation;constructor(){this.ta=0,this.tb=0,this.tx=0,this.tc=0,this.td=0,this.ty=0,this.mutation=!0}static get temp(){return ae}static multiply(e,t,r){const s=e.ta*t.ta+e.tb*t.tc,n=e.ta*t.tb+e.tb*t.td,i=e.ta*t.tx+e.tb*t.ty+e.tx,o=e.tc*t.ta+e.td*t.tc,a=e.tc*t.tb+e.td*t.td,l=e.tc*t.tx+e.td*t.ty+e.ty;return r||(r=new oe),r.ta=s,r.tb=n,r.tx=i,r.tc=o,r.td=a,r.ty=l,r.mutation=!0,r}static identity(e){return e||(e=new oe),e.ta=1,e.tb=0,e.tx=0,e.tc=0,e.td=1,e.ty=0,e.mutation=!0,e}static translate(e,t,r){return r||(r=new oe),r.ta=1,r.tb=0,r.tx=e,r.tc=0,r.td=1,r.ty=t,r.mutation=!0,r}static scale(e,t,r){return r||(r=new oe),r.ta=e,r.tb=0,r.tx=0,r.tc=0,r.td=t,r.ty=0,r.mutation=!0,r}static rotate(e,t){const r=Math.cos(e),s=Math.sin(e);return t||(t=new oe),t.ta=r,t.tb=-s,t.tx=0,t.tc=s,t.td=r,t.ty=0,t.mutation=!0,t}static copy(e,t){return t||(t=new oe),t.ta=e.ta,t.tc=e.tc,t.tb=e.tb,t.td=e.td,t.tx=e.tx,t.ty=e.ty,t.mutation=!0,t}translate(e,t){return this.tx=this.ta*e+this.tb*t+this.tx,this.ty=this.tc*e+this.td*t+this.ty,this.mutation=!0,this}scale(e,t){return this.ta=this.ta*e,this.tb=this.tb*t,this.tc=this.tc*e,this.td=this.td*t,this.mutation=!0,this}rotate(e){if(0===e||!(e%Math.PI*2))return this;const t=Math.cos(e),r=Math.sin(e),s=this.ta*t+this.tb*r,n=this.tb*t-this.ta*r,i=this.tc*t+this.td*r,o=this.td*t-this.tc*r;return this.ta=s,this.tb=n,this.tc=i,this.td=o,this.mutation=!0,this}multiply(e){return oe.multiply(this,e,this)}getFloatArr(){return this._floatArr||(this._floatArr=new Float32Array(9)),this.mutation&&(this._floatArr[0]=this.ta,this._floatArr[1]=this.tc,this._floatArr[2]=0,this._floatArr[3]=this.tb,this._floatArr[4]=this.td,this._floatArr[5]=0,this._floatArr[6]=this.tx,this._floatArr[7]=this.ty,this._floatArr[8]=1,this.mutation=!1),this._floatArr}}const ae=new oe;class le{data;constructor(e){this.data=new Float32Array(8),e&&(this.data[0]=e[0],this.data[2]=e[2],this.data[4]=e[4],this.data[6]=e[6],this.data[1]=e[1],this.data[3]=e[3],this.data[5]=e[5],this.data[7]=e[7])}static translate(e,t,r,s,n,i,o,a,l){return l||(l=new le),l.data[0]=e,l.data[2]=r,l.data[4]=n,l.data[6]=o,l.data[1]=t,l.data[3]=s,l.data[5]=i,l.data[7]=a,l}get x1(){return this.data[0]}get x2(){return this.data[2]}get x3(){return this.data[4]}get x4(){return this.data[6]}get y1(){return this.data[1]}get y2(){return this.data[3]}get y3(){return this.data[5]}get y4(){return this.data[7]}}const he=e=>e&&!(e&e-1),ce=(e,t,r,s)=>{const n=3*e,i=3*(r-e)-n,o=1-n-i,a=3*t,l=3*(s-t)-a,h=1-a-l;return function(e){if(e>=1)return 1;if(e<=0)return 0;let t,r,s,c=.5;for(let d=0;d<20;d++){if(t=c*(c*(c*o+i)+n),s=e-t,s>-1e-8&&s<1e-8)return c*(c*(c*h+l)+a);if(r=c*(c*(3*o)+2*i)+n,r>1e-10&&r<1e-10)break;c+=s/r}let d=0,u=1;for(let r=0;r<20;r++){if(c=.5*(d+u),t=c*(c*(c*o+i)+n),s=e-t,s>-1e-8&&s<1e-8)return c*(c*(c*h+l)+a);s<0?u=c:d=c}}},de={},ue={ease:[.25,.1,.25,1],"ease-in":[.42,0,1,1],"ease-out":[0,0,.58,1],"ease-in-out":[.42,0,.58,1],"ease-in-sine":[.12,0,.39,0],"ease-out-sine":[.12,0,.39,0],"ease-in-out-sine":[.37,0,.63,1],"ease-in-cubic":[.32,0,.67,0],"ease-out-cubic":[.33,1,.68,1],"ease-in-out-cubic":[.65,0,.35,1],"ease-in-circ":[.55,0,1,.45],"ease-out-circ":[0,.55,.45,1],"ease-in-out-circ":[.85,0,.15,1],"ease-in-back":[.36,0,.66,-.56],"ease-out-back":[.34,1.56,.64,1],"ease-in-out-back":[.68,-.6,.32,1.6]},pe=e=>e,fe=e=>{if("linear"===e)return pe;if(void 0!==de[e])return de[e]||pe;if("step-start"===e)return()=>1;if("step-end"===e)return e=>1===e?1:0;const t=ue[e];if(void 0!==t){const[r,s,n,i]=t,o=ce(r,s,n,i);return de[e]=o,o}return e.startsWith("cubic-bezier")?(e=>{const t=e.match(/-?\d*\.?\d+/g);if(t){const[r,s,n,i]=t,o=parseFloat(r||"0.42"),a=parseFloat(s||"0"),l=parseFloat(n||"1"),h=parseFloat(i||"1"),c=ce(o,a,l,h);return de[e]=c,c}return console.warn("Unknown cubic-bezier timing: "+e),pe})(e):(console.warn("Unknown timing function: "+e),pe)};function me(e){return(e/1024/1024).toFixed(2)}class ge extends q{node;props;settings;progress=0;delayFor=0;timingFunction;propValuesMap={};dynPropValuesMap=void 0;constructor(e,t,r){super(),this.node=e,this.props=t;for(const r in t)if("shaderProps"!==r)void 0===this.propValuesMap.props&&(this.propValuesMap.props={}),this.propValuesMap.props[r]={start:e[r],target:t[r]};else if("DynamicShader"!==e.shader.type){this.propValuesMap.shaderProps={};for(const r in t.shaderProps)this.propValuesMap.shaderProps[r]={start:e.shader.props[r],target:t.shaderProps[r]}}else{const r=Object.keys(t.shaderProps),s=r.length;this.dynPropValuesMap={};for(let n=0;n<s;n++){const s=r[n],i=t.shaderProps[s];this.dynPropValuesMap[s]={};const o=Object.entries(i),a=o.length;for(let t=0;t<a;t++){const[r,n]=o[t];this.dynPropValuesMap[s][r]={start:e.shader.props[s][r],target:n}}}}const s=r.easing||"linear",n=r.delay??0;this.settings={duration:r.duration??0,delay:n,easing:s,loop:r.loop??!1,repeat:r.repeat??0,repeatDelay:r.repeatDelay??0,stopMethod:r.stopMethod??!1},this.timingFunction=fe(s),this.delayFor=n}reset(){this.progress=0,this.delayFor=this.settings.delay||0,this.update(0)}restoreValues(e,t){const r=Object.entries(t),s=r.length;for(let t=0;t<s;t++){const[s,n]=r[t];e[s]=n.start}}restore(){if(this.reset(),void 0!==this.propValuesMap.props&&this.restoreValues(this.node,this.propValuesMap.props),void 0!==this.propValuesMap.shaderProps&&this.restoreValues(this.node.shader.props,this.propValuesMap.shaderProps),void 0!==this.dynPropValuesMap){const e=Object.keys(this.dynPropValuesMap),t=e.length;if(t>0)for(let r=0;r<t;r++){const t=e[r];this.restoreValues(this.node.shader.props[t],this.dynPropValuesMap[t])}}}reverseValues(e){const t=Object.entries(e),r=t.length;for(let s=0;s<r;s++){const[r,n]=t[s];e[r]={start:n.target,target:n.start}}}reverse(){if(this.progress=0,void 0!==this.propValuesMap.props&&this.reverseValues(this.propValuesMap.props),void 0!==this.propValuesMap.shaderProps&&this.reverseValues(this.propValuesMap.shaderProps),void 0!==this.dynPropValuesMap){const e=Object.keys(this.dynPropValuesMap),t=e.length;if(t>0)for(let r=0;r<t;r++){const t=e[r];this.reverseValues(this.dynPropValuesMap[t])}}this.settings.loop||(this.settings.stopMethod=!1)}applyEasing(e,t,r){return(this.timingFunction(e)||e)*(r-t)+t}updateValue(e,t,r,s){if(1===this.progress)return t;if(0===this.progress)return r;const n=t;if(-1!==e.indexOf("color")){if(r===n)return r;if(s){return X(r,n,this.timingFunction(this.progress)||this.progress)}return X(r,n,this.progress)}return s?this.applyEasing(this.progress,r,n):r+(n-r)*this.progress}updateValues(e,t,r){const s=Object.entries(t),n=s.length;for(let t=0;t<n;t++){const[n,i]=s[t];e[n]=this.updateValue(n,i.target,i.start,r)}}update(e){const{duration:t,loop:r,easing:s,stopMethod:n}=this.settings,{delayFor:i}=this;if(0!==t||0!==i){if(this.delayFor>0){if(this.delayFor-=e,this.delayFor>=0)return;e=-this.delayFor,this.delayFor=0}if(0!==t)if(0===this.progress&&this.emit("animating",{}),this.progress+=e/t,this.progress>1&&(this.progress=r?0:1,n))this.emit("finished",{});else{if(void 0!==this.propValuesMap.props&&this.updateValues(this.node,this.propValuesMap.props,s),void 0!==this.propValuesMap.shaderProps&&this.updateValues(this.node.shader.props,this.propValuesMap.shaderProps,s),void 0!==this.dynPropValuesMap){const e=Object.keys(this.dynPropValuesMap),t=e.length;if(t>0)for(let r=0;r<t;r++){const t=e[r];this.updateValues(this.node.shader.props[t],this.dynPropValuesMap[t],s)}}1===this.progress&&this.emit("finished",{})}else this.emit("finished",{})}else this.emit("finished",{})}}class xe extends q{manager;animation;stoppedPromise;stoppedResolve=null;state;constructor(e,t){super(),this.manager=e,this.animation=t,this.state="stopped",this.stoppedPromise=Promise.resolve(),this.onAnimating=this.onAnimating.bind(this),this.onFinished=this.onFinished.bind(this)}start(){return"running"!==this.state&&(this.makeStoppedPromise(),this.registerAnimation(),this.state="running"),this}stop(){return this.unregisterAnimation(),null!==this.stoppedResolve&&(this.stoppedResolve(),this.stoppedResolve=null,this.emit("stopped",this)),this.animation.reset(),this.state="stopped",this}pause(){return this.unregisterAnimation(),this.state="paused",this}restore(){return this.stoppedResolve=null,this.animation.restore(),this}waitUntilStopped(){return this.stoppedPromise}registerAnimation(){this.animation.once("finished",this.onFinished),this.animation.on("animating",this.onAnimating),this.manager.registerAnimation(this.animation)}unregisterAnimation(){this.manager.unregisterAnimation(this.animation),this.animation.off("finished",this.onFinished),this.animation.off("animating",this.onAnimating)}makeStoppedPromise(){null===this.stoppedResolve&&(this.stoppedPromise=new Promise((e=>{this.stoppedResolve=e})))}onFinished(){G(this.stoppedResolve);const{loop:e,stopMethod:t}=this.animation.settings;"reverse"!==t?e||(this.unregisterAnimation(),this.stoppedResolve(),this.stoppedResolve=null,this.emit("stopped",this),this.state="stopped"):this.animation.reverse()}onAnimating(){this.emit("animating",this)}}var ye;!function(e){e[e.Init=0]="Init",e[e.OutOfBounds=2]="OutOfBounds",e[e.InBounds=4]="InBounds",e[e.InViewport=8]="InViewport"}(ye||(ye={}));const ve=new Map;var Te;ve.set(ye.Init,"init"),ve.set(ye.OutOfBounds,"outOfBounds"),ve.set(ye.InBounds,"inBounds"),ve.set(ye.InViewport,"inViewport"),function(e){e[e.Children=1]="Children",e[e.ScaleRotate=2]="ScaleRotate",e[e.Local=4]="Local",e[e.Global=8]="Global",e[e.Clipping=16]="Clipping",e[e.CalculatedZIndex=32]="CalculatedZIndex",e[e.ZIndexSortedChildren=64]="ZIndexSortedChildren",e[e.PremultipliedColors=128]="PremultipliedColors",e[e.WorldAlpha=256]="WorldAlpha",e[e.RenderState=512]="RenderState",e[e.IsRenderable=1024]="IsRenderable",e[e.RenderTexture=2048]="RenderTexture",e[e.ParentRenderTexture=4096]="ParentRenderTexture",e[e.None=0]="None",e[e.All=8191]="All"}(Te||(Te={}));class be extends q{stage;children=[];_id=function(){return K++}();props;updateType=Te.All;globalTransform;scaleRotateTransform;localTransform;renderCoords;renderBound;strictBound;preloadBound;clippingRect={x:0,y:0,width:0,height:0,valid:!1};isRenderable=!1;renderState=ye.Init;worldAlpha=1;premultipliedColorTl=0;premultipliedColorTr=0;premultipliedColorBl=0;premultipliedColorBr=0;calcZIndex=0;hasRTTupdates=!1;parentHasRenderTexture=!1;constructor(e,t){super(),this.stage=e,this.props={...t,parent:null,texture:null,src:null,rtt:!1},this.parent=t.parent,this.texture=t.texture,this.src=t.src,this.rtt=t.rtt,this.updateScaleRotateTransform()}loadTexture(){const{texture:e}=this.props;G(e),queueMicrotask((()=>{this.textureOptions.preload&&e.ctxTexture.load(),"loaded"===e.state?(G(e.dimensions),this.onTextureLoaded(e,e.dimensions)):"failed"===e.state?(G(e.error),this.onTextureFailed(e,e.error)):"freed"===e.state&&this.onTextureFreed(e),e.on("loaded",this.onTextureLoaded),e.on("failed",this.onTextureFailed),e.on("freed",this.onTextureFreed)}))}unloadTexture(){this.texture&&(this.texture.off("loaded",this.onTextureLoaded),this.texture.off("failed",this.onTextureFailed),this.texture.off("freed",this.onTextureFreed),this.texture.setRenderableOwner(this,!1))}autosizeNode(e){this.autosize&&(this.width=e.width,this.height=e.height)}onTextureLoaded=(e,t)=>{this.autosizeNode(t),this.stage.requestRender(),this.parentHasRenderTexture&&this.setRTTUpdates(1),this.emit("loaded",{type:"texture",dimensions:t}),"contain"===this.props.textureOptions?.resizeMode?.type&&this.setUpdateType(Te.Local)};onTextureFailed=(e,t)=>{this.emit("failed",{type:"texture",error:t})};onTextureFreed=()=>{this.emit("freed",{type:"texture"})};setUpdateType(e){this.updateType|=e;const t=this.props.parent;!t||t.updateType&Te.Children||t.setUpdateType(Te.Children),this.parentHasRenderTexture&&this.setRTTUpdates(e)}sortChildren(){this.children.sort(((e,t)=>e.calcZIndex-t.calcZIndex))}updateScaleRotateTransform(){const{rotation:e,scaleX:t,scaleY:r}=this.props;this.scaleRotateTransform=0!==e||1!==t||1!==r?oe.rotate(e,this.scaleRotateTransform).scale(t,r):void 0}updateLocalTransform(){const{x:e,y:t,width:r,height:s}=this.props,n=this.props.mountX*r,i=this.props.mountY*s;if(this.scaleRotateTransform){const o=this.props.pivotX*r,a=this.props.pivotY*s;this.localTransform=oe.translate(e-n+o,t-i+a,this.localTransform).multiply(this.scaleRotateTransform).translate(-o,-a)}else this.localTransform=oe.translate(e-n,t-i,this.localTransform);const o=this.props.texture;if(o&&o.dimensions&&"contain"===this.props.textureOptions?.resizeMode?.type){let e=1,t=1,n=0,i=0;const{width:a,height:l}=o.dimensions;if(a/l>r/s){const e=l*(r/a);i=(s-e)/2,t=e/s}else{const t=a*(s/l);n=(r-t)/2,e=t/r}this.localTransform.translate(n,i).scale(e,t)}this.setUpdateType(Te.Global)}update(e,t){this.updateType&Te.ScaleRotate&&(this.updateScaleRotateTransform(),this.setUpdateType(Te.Local)),this.updateType&Te.Local&&(this.updateLocalTransform(),this.setUpdateType(Te.Global));const r=this.props.parent;let s=Te.None;if(this.updateType&Te.ParentRenderTexture){let e=this.parent;for(;e;)e.rtt&&(this.parentHasRenderTexture=!0),e=e.parent}this.updateType^Te.All&&this.updateType&Te.RenderTexture&&this.children.forEach((e=>{e.setUpdateType(Te.All)})),this.updateType&Te.Global&&(G(this.localTransform),this.globalTransform=oe.copy(r?.globalTransform||this.localTransform,this.globalTransform),this.parentHasRenderTexture&&this.props.parent?.rtt&&(this.globalTransform=oe.identity()),r&&this.globalTransform.multiply(this.localTransform),this.calculateRenderCoords(),this.updateBoundingRect(),this.setUpdateType(Te.Clipping|Te.RenderState|Te.Children),s|=Te.Global),this.updateType&Te.Clipping&&(this.calculateClippingRect(t),this.setUpdateType(Te.Children),s|=Te.Clipping),this.updateType&Te.WorldAlpha&&(this.worldAlpha=r?r.worldAlpha*this.props.alpha:this.props.alpha,this.setUpdateType(Te.Children|Te.PremultipliedColors|Te.IsRenderable),s|=Te.WorldAlpha),this.updateType&Te.PremultipliedColors&&(this.premultipliedColorTl=Y(this.props.colorTl,this.worldAlpha,!0),this.props.colorTl===this.props.colorTr&&this.props.colorBl===this.props.colorBr&&this.props.colorTl===this.props.colorBl?this.premultipliedColorTr=this.premultipliedColorBl=this.premultipliedColorBr=this.premultipliedColorTl:(this.premultipliedColorTr=Y(this.props.colorTr,this.worldAlpha,!0),this.premultipliedColorBl=Y(this.props.colorBl,this.worldAlpha,!0),this.premultipliedColorBr=Y(this.props.colorBr,this.worldAlpha,!0))),this.updateType&Te.RenderState&&(this.updateRenderState(t),this.setUpdateType(Te.IsRenderable)),this.updateType&Te.IsRenderable&&this.updateIsRenderable(),r&&this.updateType&Te.CalculatedZIndex&&(this.calculateZIndex(),r.setUpdateType(Te.ZIndexSortedChildren)),this.updateType&Te.Children&&this.children.length&&!this.rtt&&this.children.forEach((t=>{t.setUpdateType(s),0!==t.updateType&&t.update(e,this.clippingRect)})),this.updateType&Te.ZIndexSortedChildren&&this.sortChildren(),this.updateType=0}checkRenderProps(){return!!this.props.texture||!(!this.props.width||!this.props.height)&&(this.props.shader!==this.stage.defShaderCtr||(!!this.props.clipping||(0!==this.props.color||(0!==this.props.colorTop||(0!==this.props.colorBottom||(0!==this.props.colorLeft||(0!==this.props.colorRight||(0!==this.props.colorTl||(0!==this.props.colorTr||(0!==this.props.colorBl||0!==this.props.colorBr))))))))))}checkRenderBounds(e){G(this.renderBound);const t=e.width||this.stage.root.width,r=e.height||this.stage.root.height;if(this.strictBound=te(e.x,e.y,e.x+t,e.y+r,this.strictBound),ie(this.renderBound,this.strictBound))return ye.InViewport;const s=this.stage.boundsMargin;return this.preloadBound=te(this.strictBound.x1-s[3],this.strictBound.y1-s[0],this.strictBound.x2+s[1],this.strictBound.y2+s[2],this.preloadBound),ie(this.renderBound,this.preloadBound)?ye.InBounds:ye.OutOfBounds}updateRenderState(e){const t=this.checkRenderBounds(e);if(t===this.renderState)return;const r=this.renderState;this.renderState=t;const s=ve.get(t);G(s),this.emit(s,{previous:r,current:t})}updateIsRenderable(){let e;e=!(0===this.worldAlpha||!this.checkRenderProps())&&this.renderState>ye.OutOfBounds,this.isRenderable!==e&&(this.isRenderable=e,this.onChangeIsRenderable(e))}onChangeIsRenderable(e){this.texture?.setRenderableOwner(this,e)}calculateRenderCoords(){const{width:e,height:t,globalTransform:r}=this;G(r);const{tx:s,ty:n,ta:i,tb:o,tc:a,td:l}=r;if(0===o&&0===a){const r=s,o=s+e*i,a=n,h=n+t*l;this.renderCoords=le.translate(r,a,o,a,o,h,r,h,this.renderCoords)}else this.renderCoords=le.translate(s,n,s+e*i,n+e*a,s+e*i+t*o,n+e*a+t*l,s+t*o,n+t*l,this.renderCoords)}updateBoundingRect(){const{renderCoords:e,globalTransform:t}=this;G(t),G(e);const{tb:r,tc:s}=t,{x1:n,y1:i,x3:o,y3:a}=e;if(0===r||0===s)this.renderBound=te(n,i,o,a,this.renderBound);else{const{x2:t,x4:r,y2:s,y4:l}=e;this.renderBound=te(Math.min(n,t,o,r),Math.min(i,s,a,l),Math.max(n,t,o,r),Math.max(i,s,a,l),this.renderBound)}}calculateClippingRect(e){G(this.globalTransform);const{clippingRect:t,props:r,globalTransform:s}=this,{clipping:n}=r,i=0!==s.tb||0!==s.tc;n&&!i?(t.x=s.tx,t.y=s.ty,t.width=this.width*s.ta,t.height=this.height*s.td,t.valid=!0):t.valid=!1,e.valid&&t.valid?se(e,t,t):e.valid&&(ne(e,t),t.valid=!0)}calculateZIndex(){const e=this.props,t=e.zIndex||0,r=e.parent?.zIndex||0;let s=t;e.parent?.zIndexLocked&&(s=t<r?t:r),this.calcZIndex=s}destroy(){this.unloadTexture(),this.clippingRect.valid=!1,this.isRenderable=!1,delete this.renderCoords,delete this.renderBound,delete this.strictBound,delete this.preloadBound,delete this.globalTransform,delete this.scaleRotateTransform,delete this.localTransform,this.props.texture=null,this.props.shader=this.stage.defShaderCtr;const e=[...this.children];for(let t=0;t<e.length;t++)e[t].destroy();this.parent=null,this.rtt&&this.stage.renderer.removeRTTNode(this),this.removeAllListeners()}renderQuads(e){const{texture:t,width:r,height:s,textureOptions:n,rtt:i,shader:o}=this.props;if(this.parentHasRenderTexture){if(!e.renderToTextureActive)return;if(this.parentRenderTexture!==e.activeRttNode)return}const{premultipliedColorTl:a,premultipliedColorTr:l,premultipliedColorBl:h,premultipliedColorBr:c}=this,{zIndex:d,worldAlpha:u,globalTransform:p,clippingRect:f,renderCoords:m}=this;G(p),G(m),e.addQuad({width:r,height:s,colorTl:a,colorTr:l,colorBl:h,colorBr:c,texture:t,textureOptions:n,zIndex:d,shader:o.shader,shaderProps:o.getResolvedProps(),alpha:u,clippingRect:f,tx:p.tx,ty:p.ty,ta:p.ta,tb:p.tb,tc:p.tc,td:p.td,renderCoords:m,rtt:i,parentHasRenderTexture:this.parentHasRenderTexture,framebufferDimensions:this.framebufferDimensions})}get id(){return this._id}get x(){return this.props.x}set x(e){this.props.x!==e&&(this.props.x=e,this.setUpdateType(Te.Local))}get absX(){return this.props.x+(this.props.parent?.absX||this.props.parent?.globalTransform?.tx||0)}get absY(){return this.props.y+(this.props.parent?.absY??0)}get y(){return this.props.y}set y(e){this.props.y!==e&&(this.props.y=e,this.setUpdateType(Te.Local))}get width(){return this.props.width}set width(e){this.props.width!==e&&(this.props.width=e,this.setUpdateType(Te.Local),this.props.rtt&&(this.texture=this.stage.txManager.loadTexture("RenderTexture",{width:this.width,height:this.height}),this.textureOptions.preload=!0,this.setUpdateType(Te.RenderTexture)))}get height(){return this.props.height}set height(e){this.props.height!==e&&(this.props.height=e,this.setUpdateType(Te.Local),this.props.rtt&&(this.texture=this.stage.txManager.loadTexture("RenderTexture",{width:this.width,height:this.height}),this.textureOptions.preload=!0,this.setUpdateType(Te.RenderTexture)))}get scale(){return this.scaleX}set scale(e){this.scaleX=e,this.scaleY=e}get scaleX(){return this.props.scaleX}set scaleX(e){this.props.scaleX!==e&&(this.props.scaleX=e,this.setUpdateType(Te.ScaleRotate))}get scaleY(){return this.props.scaleY}set scaleY(e){this.props.scaleY!==e&&(this.props.scaleY=e,this.setUpdateType(Te.ScaleRotate))}get mount(){return this.props.mount}set mount(e){this.props.mountX===e&&this.props.mountY===e||(this.props.mountX=e,this.props.mountY=e,this.props.mount=e,this.setUpdateType(Te.Local))}get mountX(){return this.props.mountX}set mountX(e){this.props.mountX!==e&&(this.props.mountX=e,this.setUpdateType(Te.Local))}get mountY(){return this.props.mountY}set mountY(e){this.props.mountY!==e&&(this.props.mountY=e,this.setUpdateType(Te.Local))}get pivot(){return this.props.pivot}set pivot(e){this.props.pivotX===e&&this.props.pivotY===e||(this.props.pivotX=e,this.props.pivotY=e,this.props.pivot=e,this.setUpdateType(Te.Local))}get pivotX(){return this.props.pivotX}set pivotX(e){this.props.pivotX!==e&&(this.props.pivotX=e,this.setUpdateType(Te.Local))}get pivotY(){return this.props.pivotY}set pivotY(e){this.props.pivotY!==e&&(this.props.pivotY=e,this.setUpdateType(Te.Local))}get rotation(){return this.props.rotation}set rotation(e){this.props.rotation!==e&&(this.props.rotation=e,this.setUpdateType(Te.ScaleRotate))}get alpha(){return this.props.alpha}set alpha(e){this.props.alpha=e,this.setUpdateType(Te.PremultipliedColors|Te.WorldAlpha)}get autosize(){return this.props.autosize}set autosize(e){this.props.autosize=e}get clipping(){return this.props.clipping}set clipping(e){this.props.clipping=e,this.setUpdateType(Te.Clipping)}get color(){return this.props.color}set color(e){this.colorTop=e,this.colorBottom=e,this.colorLeft=e,this.colorRight=e,this.props.color=e,this.setUpdateType(Te.PremultipliedColors)}get colorTop(){return this.props.colorTop}set colorTop(e){this.props.colorTl===e&&this.props.colorTr===e||(this.colorTl=e,this.colorTr=e),this.props.colorTop=e,this.setUpdateType(Te.PremultipliedColors)}get colorBottom(){return this.props.colorBottom}set colorBottom(e){this.props.colorBl===e&&this.props.colorBr===e||(this.colorBl=e,this.colorBr=e),this.props.colorBottom=e,this.setUpdateType(Te.PremultipliedColors)}get colorLeft(){return this.props.colorLeft}set colorLeft(e){this.props.colorTl===e&&this.props.colorBl===e||(this.colorTl=e,this.colorBl=e),this.props.colorLeft=e,this.setUpdateType(Te.PremultipliedColors)}get colorRight(){return this.props.colorRight}set colorRight(e){this.props.colorTr===e&&this.props.colorBr===e||(this.colorTr=e,this.colorBr=e),this.props.colorRight=e,this.setUpdateType(Te.PremultipliedColors)}get colorTl(){return this.props.colorTl}set colorTl(e){this.props.colorTl=e,this.setUpdateType(Te.PremultipliedColors)}get colorTr(){return this.props.colorTr}set colorTr(e){this.props.colorTr=e,this.setUpdateType(Te.PremultipliedColors)}get colorBl(){return this.props.colorBl}set colorBl(e){this.props.colorBl=e,this.setUpdateType(Te.PremultipliedColors)}get colorBr(){return this.props.colorBr}set colorBr(e){this.props.colorBr=e,this.setUpdateType(Te.PremultipliedColors)}get zIndexLocked(){return this.props.zIndexLocked||0}set zIndexLocked(e){this.props.zIndexLocked=e,this.setUpdateType(Te.CalculatedZIndex|Te.Children),this.children.forEach((e=>{e.setUpdateType(Te.CalculatedZIndex)}))}get zIndex(){return this.props.zIndex}set zIndex(e){this.props.zIndex=e,this.setUpdateType(Te.CalculatedZIndex|Te.Children),this.children.forEach((e=>{e.setUpdateType(Te.CalculatedZIndex)}))}get parent(){return this.props.parent}set parent(e){const t=this.props.parent;if(t!==e){if(this.props.parent=e,t){const e=t.children.indexOf(this);G(-1!==e,"CoreNode.parent: Node not found in old parent's children!"),t.children.splice(e,1),t.setUpdateType(Te.Children|Te.ZIndexSortedChildren)}e&&(e.children.push(this),this.setUpdateType(Te.All),e.setUpdateType(Te.Children|Te.ZIndexSortedChildren),(e.rtt||e.parentHasRenderTexture)&&this.setRTTUpdates(Te.All)),this.updateScaleRotateTransform()}}get rtt(){return this.props.rtt}set rtt(e){if(!0===this.props.rtt&&(this.props.rtt=e,!1===e&&null!==this.texture))return this.unloadTexture(),this.setUpdateType(Te.All),this.children.forEach((e=>{e.parentHasRenderTexture=!1})),void this.stage.renderer?.removeRTTNode(this);!1!==e&&(this.texture=this.stage.txManager.loadTexture("RenderTexture",{width:this.width,height:this.height}),this.textureOptions.preload=!0,this.props.rtt=!0,this.hasRTTupdates=!0,this.setUpdateType(Te.All),this.children.forEach((e=>{e.setUpdateType(Te.All)})),this.stage.renderer?.renderToTexture(this))}get shader(){return this.props.shader}set shader(e){this.props.shader!==e&&(this.props.shader=e,this.setUpdateType(Te.IsRenderable))}get src(){return this.props.src}set src(e){this.props.src!==e&&(this.props.src=e,this.texture=e?this.stage.txManager.loadTexture("ImageTexture",{src:e}):null)}get framebufferDimensions(){return this.parentHasRenderTexture&&!this.rtt&&this.parent?this.parent.framebufferDimensions:{width:this.width,height:this.height}}get parentRenderTexture(){let e=this.parent;for(;e;){if(e.rtt)return e;e=e.parent}return null}get texture(){return this.props.texture}set texture(e){if(this.props.texture===e)return;const t=this.props.texture;t&&(t.setRenderableOwner(this,!1),this.unloadTexture()),this.props.texture=e,e&&(e.setRenderableOwner(this,this.isRenderable),this.loadTexture()),this.setUpdateType(Te.IsRenderable)}set textureOptions(e){this.props.textureOptions=e}get textureOptions(){return this.props.textureOptions}setRTTUpdates(e){this.hasRTTupdates=!0,this.parent?.setRTTUpdates(e)}animate(e,t){const r=new ge(this,e,t);return new xe(this.stage.animationManager,r)}flush(){}}const we={alpha:e=>1===e?null:{prop:"opacity",value:`${e}`},x:e=>({prop:"left",value:`${e}px`}),y:e=>({prop:"top",value:`${e}px`}),width:e=>0===e?null:{prop:"width",value:`${e}px`},height:e=>0===e?null:{prop:"height",value:`${e}px`},zIndex:()=>"zIndex",fontFamily:()=>"font-family",fontSize:()=>"font-size",fontStyle:()=>"font-style",fontWeight:()=>"font-weight",fontStretch:()=>"font-stretch",lineHeight:()=>"line-height",letterSpacing:()=>"letter-spacing",textAlign:()=>"text-align",overflowSuffix:()=>"overflow-suffix",maxLines:()=>"max-lines",contain:()=>"contain",verticalAlign:()=>"vertical-align",clipping:e=>!1===e?null:{prop:"overflow",value:e?"hidden":"visible"},rotation:e=>0===e?null:{prop:"transform",value:`rotate(${e}rad)`},scale:e=>1===e?null:{prop:"transform",value:`scale(${e})`},scaleX:e=>1===e?null:{prop:"transform",value:`scaleX(${e})`},scaleY:e=>1===e?null:{prop:"transform",value:`scaleY(${e})`},color:e=>0===e?null:{prop:"color",value:Se(e)}},Se=e=>`rgba(${e>>24&255},${e>>16&255},${e>>8&255},${(255&e)/255})`,_e={id:"id"};class Re{root=null;canvas=null;height=1080;width=1920;scaleX=1;scaleY=1;constructor(e,t){if(j())return;if(!t)throw new Error("settings is required");this.height=Math.ceil(t.appHeight??1080/(t.deviceLogicalPixelRatio??1)),this.width=Math.ceil(t.appWidth??1900/(t.deviceLogicalPixelRatio??1)),this.scaleX=t.deviceLogicalPixelRatio??1,this.scaleY=t.deviceLogicalPixelRatio??1,this.canvas=e,this.root=document.createElement("div"),this.setRootPosition(),document.body.appendChild(this.root);new MutationObserver(this.setRootPosition.bind(this)).observe(e,{attributes:!0,childList:!1,subtree:!1});new ResizeObserver(this.setRootPosition.bind(this)).observe(e),window.addEventListener("resize",this.setRootPosition.bind(this)),console.warn("Inspector is enabled, this will impact performance")}setRootPosition(){if(null===this.root||null===this.canvas)return;const e=this.canvas.getBoundingClientRect(),t=document.documentElement.scrollTop+e.top,r=document.documentElement.scrollLeft+e.left;this.root.id="root",this.root.style.left=`${r}px`,this.root.style.top=`${t}px`,this.root.style.width=`${this.width}px`,this.root.style.height=`${this.height}px`,this.root.style.position="absolute",this.root.style.transformOrigin="0 0 0",this.root.style.transform=`scale(${this.scaleX}, ${this.scaleY})`,this.root.style.overflow="hidden",this.root.style.zIndex="65534"}createDiv(e,t){const r=document.createElement("div");r.style.position="absolute",r.id=e.toString();for(const e in t)this.updateNodeProperty(r,e,t[e]);return r}createNode(e){const t=this.createDiv(e.id,e.props);return t.node=e,e.div=t,this.createProxy(e,t)}createTextNode(e){const t=this.createDiv(e.id,e.props);return t.node=e,e.div=t,this.createProxy(e,t)}createProxy(e,t){return new Proxy(e,{set:(e,r,s)=>(this.updateNodeProperty(t,r,s),Reflect.set(e,r,s)),get:(e,r,s)=>("destroy"===r&&this.destroyNode(e.id),"animate"===r?(r,s)=>{const n=e.animate(r,s);return new Proxy(n,{get:(e,n,i)=>("start"===n&&this.animateNode(t,r,s),Reflect.get(e,n,i))})}:Reflect.get(e,r,s))})}destroyNode(e){const t=document.getElementById(e.toString());t?.remove()}updateNodeProperty(e,t,r){if(null!==this.root&&null!=r)if("parent"!==t){if("text"===t)return e.innerHTML=String(r),void(e.style.visibility="hidden");if("src"===t&&r)e.setAttribute("data-src",String(r));else{if(we[t]){const s=we[t]?.(r);if(null===s)return;return"string"==typeof s?void e.style.setProperty(s,String(r)):void("object"==typeof s&&e.style.setProperty(s.prop,s.value))}if(_e[t]){const s=_e[t];if(!s)return;e.setAttribute(String(s),String(r))}else if("data"!==t);else for(const t in r){const s=r[t];void 0===s?e.removeAttribute(`data-${t}`):e.setAttribute(`data-${t}`,String(s))}}}else{const t=r.id;if(1===t)return void this.root.appendChild(e);const s=document.getElementById(t.toString());s?.appendChild(e)}}animateNode(e,t,r){const{duration:s=1e3,delay:n=0}=r,{x:i,y:o,width:a,height:l,alpha:h=1,rotation:c=0,scale:d=1,color:u}=t;setTimeout((function(){setTimeout((()=>{e.style.top=`${o}px`,e.style.left=`${i}px`,e.style.width=`${a}px`,e.style.height=`${l}px`,e.style.opacity=`${h}`,e.style.rotate=`${c}rad`,e.style.scale=`${d}`,e.style.color=Se(u)}),s)}),n)}}class Ee{textureSource;memManager;constructor(e,t){this.memManager=e,this.textureSource=t}setTextureMemUse(e){this.memManager.setTextureMemUse(this.textureSource,e)}get renderable(){return this.textureSource.renderable}}class Ce{options;mode;stage;txManager;txMemManager;shManager;rttNodes=[];constructor(e){this.options=e,this.stage=e.stage,this.txManager=e.txManager,this.txMemManager=e.txMemManager,this.shManager=e.shManager}}class Ae{}class Me{static makeCacheKey(e){return!1}static resolveDefaults(e){return{}}}function Ie(e,t,r){const s=e.createShader(t);if(!s)throw new Error;e.shaderSource(s,r),e.compileShader(s);if(e.getShaderParameter(s,e.COMPILE_STATUS))return s;console.log(e.getShaderInfoLog(s)),e.deleteShader(s)}class Fe extends Me{boundBufferCollection=null;buffersBound=!1;program;vao;renderer;glw;attributeBuffers;attributeLocations;attributeNames;uniformLocations;uniformTypes;supportsIndexedTextures;constructor(e){super();const t=this.renderer=e.renderer,r=this.glw=this.renderer.glw;this.supportsIndexedTextures=e.supportsIndexedTextures||!1;const s=r.isWebGl2(),n=s&&e.webgl2Extensions||!s&&e.webgl1Extensions||[],i=s?"2.0":"1.0";n.forEach((e=>{if(!r.getExtension(e))throw new Error(`Shader "${this.constructor.name}" requires extension "${e}" for WebGL ${i} but wasn't found`)}));const o=e.shaderSources||this.constructor.shaderSources;if(!o)throw new Error(`Shader "${this.constructor.name}" is missing shaderSources.`);s&&o?.webGl2&&(o.fragment=o.webGl2.fragment,o.vertex=o.webGl2.vertex,delete o.webGl2);const a=t.system.parameters.MAX_VERTEX_TEXTURE_IMAGE_UNITS,l=o.vertex instanceof Function?o.vertex(a):o.vertex,h=o.fragment instanceof Function?o.fragment(a):o.fragment,c=Ie(r,r.VERTEX_SHADER,l),d=Ie(r,r.FRAGMENT_SHADER,h);if(!c||!d)throw new Error;const u=function(e,t,r){const s=e.createProgram();if(!s)throw new Error;if(e.attachShader(s,t),e.attachShader(s,r),e.linkProgram(s),e.getProgramParameter(s,e.LINK_STATUS))return s;console.log(e.getProgramInfoLog(s)),e.deleteProgram(s)}(r,c,d);if(!u)throw new Error;if(this.program=u,s){const e=r.createVertexArray();if(!e)throw new Error;this.vao=e,r.bindVertexArray(this.vao)}this.attributeLocations={},this.attributeBuffers={},this.attributeNames=[],[...e.attributes].forEach((e=>{const t=r.getAttribLocation(this.program,e);if(t<0)throw new Error(`${this.constructor.name}: Vertex shader must have an attribute "${e}"!`);const s=r.createBuffer();if(!s)throw new Error(`${this.constructor.name}: Could not create buffer for attribute "${e}"`);this.attributeLocations[e]=t,this.attributeBuffers[e]=s,this.attributeNames.push(e)})),this.uniformLocations={},this.uniformTypes={},e.uniforms.forEach((e=>{const t=r.getUniformLocation(this.program,e.name);this.uniformTypes[e.name]=e.uniform,t?this.uniformLocations[e.name]=t:console.warn(`Shader "${this.constructor.name}" could not get uniform location for "${e.name}"`)}))}bindBufferAttribute(e,t,r){const{glw:s}=this;s.enableVertexAttribArray(e),s.vertexAttribPointer(t,e,r.size,r.type,r.normalized,r.stride,r.offset)}disableAttribute(e){this.glw.disableVertexAttribArray(e)}disableAttributes(){for(const e in this.attributeLocations)this.disableAttribute(this.attributeLocations[e]);this.boundBufferCollection=null}canBatchShaderProps(e,t){return!1}bindRenderOp(e,t){this.bindBufferCollection(e.buffers),e.textures.length>0&&this.bindTextures(e.textures);const{glw:r,parentHasRenderTexture:s,renderToTexture:n}=e;if(!n||!s){if(s){const{width:t,height:r}=e.framebufferDimensions||{};this.setUniform("u_pixelRatio",1),this.setUniform("u_resolution",new Float32Array([t??0,r??0]))}else this.setUniform("u_pixelRatio",e.options.pixelRatio),this.setUniform("u_resolution",new Float32Array([r.canvas.width,r.canvas.height]));if(t){if(H(t,"$dimensions")){let r=t.$dimensions;r||(r=e.dimensions),this.setUniform("u_dimensions",[r.width,r.height])}if(H(t,"$alpha")){let r=t.$alpha;r||(r=e.alpha),this.setUniform("u_alpha",r)}this.bindProps(t)}}}setUniform(e,...t){this.glw.setUniform(this.uniformTypes[e],this.uniformLocations[e],...t)}bindBufferCollection(e){if(this.boundBufferCollection!==e){for(const t in this.attributeLocations){const r=e.getBuffer(t),s=e.getAttributeInfo(t);G(r,`Buffer for "${t}" not found`),G(s),this.bindBufferAttribute(this.attributeLocations[t],r,s)}this.boundBufferCollection=e}}bindProps(e){}bindTextures(e){}attach(){this.glw.useProgram(this.program),this.glw.useProgram(this.program),this.glw.isWebGl2()&&this.vao&&this.glw.bindVertexArray(this.vao)}detach(){this.disableAttributes()}static shaderSources}class Le extends Ae{glw;options;buffers;shader;shaderProps;alpha;clippingRect;dimensions;bufferIdx;zIndex;renderToTexture;parentHasRenderTexture;framebufferDimensions;length=0;numQuads=0;textures=[];maxTextures;constructor(e,t,r,s,n,i,o,a,l,h,c,d,u){super(),this.glw=e,this.options=t,this.buffers=r,this.shader=s,this.shaderProps=n,this.alpha=i,this.clippingRect=o,this.dimensions=a,this.bufferIdx=l,this.zIndex=h,this.renderToTexture=c,this.parentHasRenderTexture=d,this.framebufferDimensions=u,this.maxTextures=s.supportsIndexedTextures?e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS):1}addTexture(e){const{textures:t,maxTextures:r}=this,s=t.findIndex((t=>t===e));if(-1!==s)return s;const n=t.length;return n>=r?4294967295:(this.textures.push(e),n)}draw(){const{glw:e,shader:t,shaderProps:r,options:s}=this,{shManager:n}=s;n.useShader(t),t.bindRenderOp(this,r);const i=this.bufferIdx/24*6*2;if(this.clippingRect.valid){const{x:t,y:r,width:n,height:i}=this.clippingRect,o=s.pixelRatio,a=s.canvas.height,l=Math.round(t*o),h=Math.round(n*o),c=Math.round(i*o),d=Math.round(a-c-r*o);e.setScissorTest(!0),e.scissor(l,d,h,c)}else e.setScissorTest(!1);e.drawElements(e.TRIANGLES,6*this.numQuads,e.UNSIGNED_SHORT,i)}}function Pe(e){const t={MAX_RENDERBUFFER_SIZE:0,MAX_TEXTURE_SIZE:0,MAX_VIEWPORT_DIMS:0,MAX_VERTEX_TEXTURE_IMAGE_UNITS:0,MAX_TEXTURE_IMAGE_UNITS:0,MAX_COMBINED_TEXTURE_IMAGE_UNITS:0,MAX_VERTEX_ATTRIBS:0,MAX_VARYING_VECTORS:0,MAX_VERTEX_UNIFORM_VECTORS:0,MAX_FRAGMENT_UNIFORM_VECTORS:0};return Object.keys(t).forEach((r=>{t[r]=e.getParameter(e[r])})),t}function ke(e){const t={ANGLE_instanced_arrays:null,WEBGL_compressed_texture_s3tc:null,WEBGL_compressed_texture_astc:null,WEBGL_compressed_texture_etc:null,WEBGL_compressed_texture_etc1:null,WEBGL_compressed_texture_pvrtc:null,WEBKIT_WEBGL_compressed_texture_pvrtc:null,WEBGL_compressed_texture_s3tc_srgb:null,OES_vertex_array_object:null};return Object.keys(t).forEach((r=>{t[r]=e.getExtension(r)})),t}const Be=new Uint8Array([0,0,0,0]);class Ue extends Ee{glw;_nativeCtxTexture=null;_state="freed";_w=0;_h=0;constructor(e,t,r){super(t,r),this.glw=e}get ctxTexture(){return"freed"===this._state&&this.load(),G(this._nativeCtxTexture),this._nativeCtxTexture}get w(){return this._w}get h(){return this._h}load(){"loading"!==this._state&&"loaded"!==this._state&&(this._state="loading",this.textureSource.setState("loading"),this._nativeCtxTexture=this.createNativeCtxTexture(),this.onLoadRequest().then((({width:e,height:t})=>{"freed"!==this._state&&(this._state="loaded",this._w=e,this._h=t,this.textureSource.setState("loaded",{width:e,height:t}))})).catch((e=>{"freed"!==this._state&&(this._state="failed",this.textureSource.setState("failed",e),console.error(e))})))}async onLoadRequest(){const{glw:e}=this;e.texImage2D(0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,null),this.setTextureMemUse(Be.byteLength);const t=await(this.textureSource?.getTextureData());if(!this._nativeCtxTexture)return G("freed"===this._state),{width:0,height:0};let r=0,s=0;if(G(this._nativeCtxTexture),e.activeTexture(0),t.data instanceof ImageBitmap||t.data instanceof ImageData||null!==(n=t.data)&&"object"==typeof n&&n.constructor&&"HTMLImageElement"===n.constructor.name){const n=t.data;r=n.width,s=n.height,e.bindTexture(this._nativeCtxTexture),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!t.premultiplyAlpha),e.texImage2D(0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),this.setTextureMemUse(r*s*4),(e.isWebGl2()||he(r)&&he(s))&&e.generateMipmap()}else if(null===t.data)r=0,s=0,e.bindTexture(this._nativeCtxTexture),e.texImage2D(0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,Be),this.setTextureMemUse(Be.byteLength);else if("mipmaps"in t.data&&t.data.mipmaps){const{mipmaps:r,width:s=0,height:n=0,type:i,glInternalFormat:o}=t.data,a="ktx"===i?new DataView(r[0]??new ArrayBuffer(0)):r[0];e.bindTexture(this._nativeCtxTexture),e.compressedTexImage2D(0,o,s,n,0,a),e.texParameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_MIN_FILTER,e.LINEAR),this.setTextureMemUse(a.byteLength)}else console.error("WebGlCoreCtxTexture.onLoadRequest: Unexpected textureData returned",t);var n;return{width:r,height:s}}free(){if("freed"===this._state)return;if(this._state="freed",this.textureSource.setState("freed"),this._w=0,this._h=0,!this._nativeCtxTexture)return;const{glw:e}=this;e.deleteTexture(this._nativeCtxTexture),this.setTextureMemUse(0),this._nativeCtxTexture=null}createNativeCtxTexture(){const{glw:e}=this,t=e.createTexture();if(!t)throw new Error("Could not create WebGL Texture");return e.activeTexture(0),e.bindTexture(t),e.texParameteri(e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t}}class Oe extends q{txManager;dimensions=null;error=null;state="freed";renderableOwners=new Set;renderable=!1;lastRenderableChangeTime=0;constructor(e){super(),this.txManager=e}setRenderableOwner(e,t){const r=this.renderableOwners.size;if(t){this.renderableOwners.add(e);const t=this.renderableOwners.size;t>r&&1===t&&(this.renderable=!0,this.lastRenderableChangeTime=this.txManager.frameTime,this.onChangeIsRenderable?.(!0))}else{this.renderableOwners.delete(e);const t=this.renderableOwners.size;t<r&&0===t&&(this.renderable=!1,this.lastRenderableChangeTime=this.txManager.frameTime,this.onChangeIsRenderable?.(!1))}}get ctxTexture(){const e=this.txManager.renderer.createCtxTexture(this);return Object.defineProperty(this,"ctxTexture",{value:e}),e}setState(e,...t){if(this.state!==e){if(this.state=e,"loaded"===e){const e=t;this.dimensions=e[0]}else if("failed"===e){const e=t;this.error=e[0]}this.emit(e,...t)}}static makeCacheKey(e){return!1}static resolveDefaults(e){return{}}}class $e extends Oe{props;constructor(e,t){super(e),this.props=$e.resolveDefaults(t||{})}get color(){return this.props.color}set color(e){this.props.color=e}async getTextureData(){const e=new Uint32Array([this.color]),t=new Uint8ClampedArray(e.buffer);return{data:new ImageData(t,1,1),premultiplyAlpha:!0}}static makeCacheKey(e){return`ColorTexture,${$e.resolveDefaults(e).color}`}static resolveDefaults(e){return{color:e.color||4294967295}}static z$__type__Props}class De extends Oe{props;parentTexture;constructor(e,t){super(e),this.props=De.resolveDefaults(t||{}),this.parentTexture=this.props.texture,queueMicrotask((()=>{const e=this.parentTexture;"loaded"===e.state?this.onParentTxLoaded(e,e.dimensions):"failed"===e.state&&this.onParentTxFailed(e,e.error),e.on("loaded",this.onParentTxLoaded),e.on("failed",this.onParentTxFailed)}))}onParentTxLoaded=()=>{this.setState("loaded",{width:this.props.width,height:this.props.height})};onParentTxFailed=(e,t)=>{this.setState("failed",t)};onChangeIsRenderable(e){this.parentTexture.setRenderableOwner(this,e)}async getTextureData(){return{data:this.props}}static makeCacheKey(e){return!1}static resolveDefaults(e){return{texture:e.texture,x:e.x||0,y:e.y||0,width:e.width||0,height:e.height||0}}static z$__type__Props}class Ne extends Ue{constructor(e,t,r){super(e,t,r)}async onLoadRequest(){const e=await this.textureSource.getTextureData();return{width:e.data?.width||0,height:e.data?.height||0}}}class ze extends Fe{constructor(e){super({renderer:e,attributes:["a_position","a_textureCoordinate","a_color"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_texture",uniform:"uniform2fv"}]})}bindTextures(e){const{glw:t}=this;t.activeTexture(0),t.bindTexture(e[0].ctxTexture)}static shaderSources={vertex:"\n      # ifdef GL_FRAGMENT_PRESICISON_HIGH\n      precision highp float;\n      # else\n      precision mediump float;\n      # endif\n\n      attribute vec2 a_position;\n      attribute vec2 a_textureCoordinate;\n      attribute vec4 a_color;\n\n      uniform vec2 u_resolution;\n      uniform float u_pixelRatio;\n\n\n      varying vec4 v_color;\n      varying vec2 v_textureCoordinate;\n\n      void main() {\n        vec2 normalized = a_position * u_pixelRatio;\n        vec2 screenSpace = vec2(2.0 / u_resolution.x, -2.0 / u_resolution.y);\n\n        v_color = a_color;\n        v_textureCoordinate = a_textureCoordinate;\n\n        gl_Position = vec4(normalized.x * screenSpace.x - 1.0, normalized.y * -abs(screenSpace.y) + 1.0, 0.0, 1.0);\n        gl_Position.y = -sign(screenSpace.y) * gl_Position.y;\n      }\n    ",fragment:"\n      # ifdef GL_FRAGMENT_PRESICISON_HIGH\n      precision highp float;\n      # else\n      precision mediump float;\n      # endif\n\n      uniform vec2 u_resolution;\n      uniform sampler2D u_texture;\n\n      varying vec4 v_color;\n      varying vec2 v_textureCoordinate;\n\n      void main() {\n          vec4 color = texture2D(u_texture, v_textureCoordinate);\n          gl_FragColor = vec4(v_color) * texture2D(u_texture, v_textureCoordinate);\n      }\n    "}}class Ge extends Fe{supportsIndexedTextures=!0;constructor(e){super({renderer:e,attributes:["a_position","a_textureCoordinate","a_color","a_textureIndex"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_textures[0]",uniform:"uniform1iv"}]})}bindTextures(e){const{renderer:t,glw:r}=this;if(e.length>t.system.parameters.MAX_VERTEX_TEXTURE_IMAGE_UNITS)throw new Error(`DefaultShaderBatched: Cannot bind more than ${t.system.parameters.MAX_VERTEX_TEXTURE_IMAGE_UNITS} textures`);e.forEach(((e,t)=>{r.activeTexture(t),r.bindTexture(e.ctxTexture)}));const s=Array.from(Array(e.length).keys());this.setUniform("u_textures[0]",s)}static shaderSources={vertex:"\n      # ifdef GL_FRAGMENT_PRESICISON_HIGH\n      precision highp float;\n      # else\n      precision mediump float;\n      # endif\n\n      attribute vec2 a_textureCoordinate;\n      attribute vec2 a_position;\n      attribute vec4 a_color;\n      attribute float a_textureIndex;\n      attribute float a_depth;\n\n      uniform vec2 u_resolution;\n      uniform float u_pixelRatio;\n\n      varying vec4 v_color;\n      varying vec2 v_textureCoordinate;\n      varying float v_textureIndex;\n\n      void main(){\n        vec2 normalized = a_position * u_pixelRatio / u_resolution;\n        vec2 zero_two = normalized * 2.0;\n        vec2 clip_space = zero_two - 1.0;\n\n        // pass to fragment\n        v_color = a_color;\n        v_textureCoordinate = a_textureCoordinate;\n        v_textureIndex = a_textureIndex;\n\n        // flip y\n        gl_Position = vec4(clip_space * vec2(1.0, -1.0), 0, 1);\n      }\n    ",fragment:e=>`\n      #define txUnits ${e}\n      # ifdef GL_FRAGMENT_PRESICISON_HIGH\n      precision highp float;\n      # else\n      precision mediump float;\n      # endif\n\n      uniform vec2 u_resolution;\n      uniform sampler2D u_image;\n      uniform sampler2D u_textures[txUnits];\n\n      varying vec4 v_color;\n      varying vec2 v_textureCoordinate;\n      varying float v_textureIndex;\n\n      vec4 sampleFromTexture(sampler2D textures[${e}], int idx, vec2 uv) {\n        ${Array.from(Array(e).keys()).map((e=>`\n          ${0!==e?"else ":""}if (idx == ${e}) {\n            return texture2D(textures[${e}], uv);\n          }\n        `)).join("")}\n        return texture2D(textures[0], uv);\n      }\n\n      void main(){\n        gl_FragColor = vec4(v_color) * sampleFromTexture(u_textures, int(v_textureIndex), v_textureCoordinate);\n      }\n    `}}class Xe{priority=1;name="";ref;target;passParameters="";declaredUniforms="";uniformInfo={};static uniforms={};static methods;static onShaderMask;static onColorize;static onEffectMask;static getEffectKey(e){return""}static getMethodParameters(e,t){const r=[];for(const s in e){const n=e[s];let i="";n.size&&(i=`[${n.size(t)}]`),r.push(`${n.type} ${s}${i}`)}return r.join(",")}constructor(e){const{ref:t,target:r,props:s={}}=e;this.ref=t,this.target=r;const n={},i=[];let o="";const a=this.constructor.uniforms||{};for(const e in a){const r=a[e],l=r.type,h=`${t}_${e}`;let c="";r.size&&(c=`[${r.size(s)}]`),i.push(h),o+=`uniform ${l} ${h}${c};`,n[e]={name:h,uniform:a[e].method}}this.passParameters=i.join(","),this.declaredUniforms=o,this.uniformInfo=n}static resolveDefaults(e){return{}}static makeEffectKey(e){return!1}}const Ve=new Map,We=(e,t)=>{const r=JSON.stringify(e);if(Ve.has(r))return Ve.get(r);const s=[],n=(e=e??[]).length;let i=0;for(;i<n;i++){const{name:r,type:n,props:o}=e[i],a={name:r,type:n,props:{}},l=t[n],h=l.resolveDefaults(o),c=l.uniforms,d=Object.keys(c),u=d.length;let p=0;for(;p<u;p++){const e=d[p],t=c[e],r={value:h[e],programValue:void 0,updateOnBind:t.updateOnBind||!1,hasValidator:void 0!==t.validator,hasProgramValueUpdater:void 0!==t.updateProgramValue},s=r.hasValidator&&t.validator(h[e],h)||h[e];h[e]!==s&&(r.validatedValue=s),r.hasProgramValueUpdater&&t.updateProgramValue(r),void 0===r.programValue&&(r.programValue=r.value),a.props[e]=r}s.push(a)}return Ve.set(r,s),s};class Ye extends Fe{effects=[];constructor(e,t,r){const s=Ye.createShader(t,r);super({renderer:e,attributes:["a_position","a_textureCoordinate","a_color"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_texture",uniform:"uniform2fv"},{name:"u_dimensions",uniform:"uniform2fv"},{name:"u_alpha",uniform:"uniform1f"},...s.uniforms],shaderSources:{vertex:s.vertex,fragment:s.fragment}}),this.effects=s.effects}bindTextures(e){const{glw:t}=this;t.activeTexture(0),t.bindTexture(e[0].ctxTexture)}bindProps(e){const t=e.effects,r=t.length;let s=0;for(;s<r;s++){const r=t[s],n=this.effects[s].uniformInfo,i=Object.keys(r.props),o=i.length;let a=0;for(;a<o;a++){const t=i[a];if(!0===r.props[t].updateOnBind){const s=this.renderer.shManager.getRegisteredEffects()[r.type]?.uniforms[t];s?.updateProgramValue(r.props[t],e)}this.setUniform(n[t].name,r.props[t].programValue)}}}canBatchShaderProps(e,t){if(e.$dimensions.width!==t.$dimensions.width||e.$dimensions.height!==t.$dimensions.height||e.effects.length!==t.effects.length)return!1;const r=e.effects.length;let s=0;for(;s<r;s++){const r=e.effects[s],n=t.effects[s];if(r.type!==n.type)return!1;for(const e in r.props)if(n.props&&!n.props[e]||r.props[e].value!==n.props[e].value)return!1}return!0}static createShader(e,t){const r={},s={};let n="";const i=[],o=[],a=e.effects.map((e=>{const s=t[e.type],a=s.getEffectKey(e.props||{});r[a]=r[a]?++r[a]:1;const l=r[a];1===l&&o.push({key:a,type:e.type,props:e.props});const h=new s({ref:`${a}${1===l?"":l}`,target:a,props:e.props});return n+=h.declaredUniforms,i.push(...Object.values(h.uniformInfo)),h}));let l="";o?.forEach((e=>{const r=t[e.type],n=r.resolveDefaults(e.props??{}),i=[];for(const e in r.methods){let t=e;const n=r.methods[e];s[e]&&s[e]!==n&&(t=Ye.resolveMethodDuplicate(e,n,s)),s[t]=n.replace("function",t),i.push({m:e,cm:t})}let o=r.onShaderMask instanceof Function?r.onShaderMask(n):r.onShaderMask,a=r.onColorize instanceof Function?r.onColorize(n):r.onColorize,h=r.onEffectMask instanceof Function?r.onEffectMask(n):r.onEffectMask;i.forEach((e=>{const{m:t,cm:r}=e,s=new RegExp(`\\$${t}`,"g");o&&(o=o.replace(s,r)),a&&(a=a.replace(s,r)),h&&(h=h.replace(s,r))}));const c=r.getMethodParameters(r.uniforms,n),d=c.length>0?`, ${c}`:"";o&&(l+=`\n        float fx_${e.key}_onShaderMask(float shaderMask ${d}) {\n          ${o}\n        }\n        `),a&&(l+=`\n          vec4 fx_${e.key}_onColorize(float shaderMask, vec4 maskColor, vec4 shaderColor${d}) {\n            ${a}\n          }\n        `),h&&(l+=`\n          vec4 fx_${e.key}_onEffectMask(float shaderMask, vec4 maskColor, vec4 shaderColor${d}) {\n            ${h}\n          }\n        `)}));let h="";for(const e in s)h+=s[e];let c="mix(shaderColor, maskColor, clamp(-(lng_DefaultMask), 0.0, 1.0))",d="\n\n    ";for(let e=0;e<a.length;e++){const r=a[e],s=r.passParameters.length>0?`, ${r.passParameters}`:"",n=t[r.name];n.onShaderMask&&(d+=`\n        shaderMask = fx_${r.target}_onShaderMask(shaderMask ${s});\n        `),n.onColorize&&(d+=`\n        maskColor = fx_${r.target}_onColorize(shaderMask, maskColor, shaderColor${s});\n        `),n.onEffectMask&&(c=`fx_${r.target}_onEffectMask(shaderMask, maskColor, shaderColor${s})`);const i=a[e+1];(void 0===i||t[i.name].onEffectMask)&&(d+=`\n          shaderColor = ${c};\n        `)}return{effects:a,uniforms:i,fragment:Ye.fragment(n,h,l,d),vertex:Ye.vertex()}}static resolveMethodDuplicate(e,t,r,s=0){const n=e+(s>0?s:"");return r[n]&&r[n]!==t?this.resolveMethodDuplicate(e,t,r,++s):n}static resolveDefaults(e,t){return G(t),{effects:We(e.effects??[],t),$dimensions:{width:0,height:0},$alpha:0}}static makeCacheKey(e,t){let r="";return e.effects?.forEach((e=>{const s=t[e.type].getEffectKey(e.props||{});r+=`,${s}`})),`DynamicShader${r}`}static z$__type__Props;static vertex=()=>"\n    # ifdef GL_FRAGMENT_PRESICISON_HIGH\n    precision highp float;\n    # else\n    precision mediump float;\n    # endif\n\n    attribute vec2 a_textureCoordinate;\n    attribute vec2 a_position;\n    attribute vec4 a_color;\n    attribute float a_textureIndex;\n\n    uniform vec2 u_resolution;\n    uniform float u_pixelRatio;\n\n    varying vec4 v_color;\n    varying vec2 v_textureCoordinate;\n    varying float v_textureIndex;\n\n    void main(){\n      vec2 normalized = a_position * u_pixelRatio / u_resolution;\n      vec2 zero_two = normalized * 2.0;\n      vec2 clip_space = zero_two - 1.0;\n\n      // pass to fragment\n      v_color = a_color;\n      v_textureCoordinate = a_textureCoordinate;\n      v_textureIndex = a_textureIndex;\n\n      // flip y\n      gl_Position = vec4(clip_space * vec2(1.0, -1.0), 0, 1);\n    }\n  ";static fragment=(e,t,r,s)=>`\n    # ifdef GL_FRAGMENT_PRESICISON_HIGH\n    precision highp float;\n    # else\n    precision mediump float;\n    # endif\n\n    #define PI 3.14159265359\n\n    uniform vec2 u_resolution;\n    uniform vec2 u_dimensions;\n    uniform float u_alpha;\n    uniform float u_radius;\n    uniform sampler2D u_texture;\n    uniform float u_pixelRatio;\n\n    ${e}\n\n    varying vec4 v_color;\n    varying vec2 v_textureCoordinate;\n\n    ${t}\n\n    ${r}\n\n    void main() {\n      vec2 p = v_textureCoordinate.xy * u_dimensions - u_dimensions * 0.5;\n      vec2 d = abs(p) - (u_dimensions) * 0.5;\n      float lng_DefaultMask = min(max(d.x, d.y), 0.0) + length(max(d, 0.0));\n\n      vec4 shaderColor = vec4(0.0);\n      float shaderMask = lng_DefaultMask;\n\n      vec4 maskColor = texture2D(u_texture, v_textureCoordinate) * v_color;\n\n      shaderColor = mix(shaderColor, maskColor, clamp(-(lng_DefaultMask + 0.5), 0.0, 1.0));\n\n      ${s}\n\n      gl_FragColor = shaderColor * u_alpha;\n    }\n  `}class He extends Fe{constructor(e){super({renderer:e,attributes:["a_position","a_textureCoordinate","a_color"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_texture",uniform:"uniform2f"},{name:"u_dimensions",uniform:"uniform2fv"},{name:"u_radius",uniform:"uniform1f"}]})}static z$__type__Props;static resolveDefaults(e){return{radius:e.radius||10,$dimensions:{width:0,height:0}}}bindTextures(e){const{glw:t}=this;t.activeTexture(0),t.bindTexture(e[0].ctxTexture)}bindProps(e){this.setUniform("u_radius",e.radius)}canBatchShaderProps(e,t){return e.radius===t.radius&&e.$dimensions.width===t.$dimensions.width&&e.$dimensions.height===t.$dimensions.height}static shaderSources={vertex:"\n      # ifdef GL_FRAGMENT_PRESICISON_HIGH\n      precision highp float;\n      # else\n      precision mediump float;\n      # endif\n\n      attribute vec2 a_position;\n      attribute vec2 a_textureCoordinate;\n      attribute vec4 a_color;\n      attribute float a_textureIndex;\n      attribute float a_depth;\n\n      uniform vec2 u_resolution;\n      uniform float u_pixelRatio;\n\n      varying vec4 v_color;\n      varying vec2 v_textureCoordinate;\n\n      void main() {\n        vec2 normalized = a_position * u_pixelRatio / u_resolution;\n        vec2 zero_two = normalized * 2.0;\n        vec2 clip_space = zero_two - 1.0;\n\n        // pass to fragment\n        v_color = a_color;\n        v_textureCoordinate = a_textureCoordinate;\n\n        // flip y\n        gl_Position = vec4(clip_space * vec2(1.0, -1.0), 0, 1);\n      }\n    ",fragment:"\n      # ifdef GL_FRAGMENT_PRESICISON_HIGH\n      precision highp float;\n      # else\n      precision mediump float;\n      # endif\n\n      uniform vec2 u_resolution;\n      uniform vec2 u_dimensions;\n      uniform float u_radius;\n      uniform sampler2D u_texture;\n\n      varying vec4 v_color;\n      varying vec2 v_textureCoordinate;\n\n      float boxDist(vec2 p, vec2 size, float radius){\n        size -= vec2(radius);\n        vec2 d = abs(p) - size;\n        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0)) - radius;\n      }\n\n      float fillMask(float dist) {\n        return clamp(-dist, 0.0, 1.0);\n      }\n\n      void main() {\n        vec4 color = texture2D(u_texture, v_textureCoordinate) * v_color;\n        vec2 halfDimensions = u_dimensions * 0.5;\n\n        float d = boxDist(v_textureCoordinate.xy * u_dimensions - halfDimensions, halfDimensions + 0.5, u_radius);\n        gl_FragColor = mix(vec4(0.0), color, fillMask(d));\n      }\n    "}}const je=new Float32Array([1,0,0,0,1,0,0,0,1]);class Ke extends Fe{constructor(e){super({renderer:e,attributes:["a_position","a_textureCoordinate"],uniforms:[{name:"u_resolution",uniform:"uniform2fv"},{name:"u_transform",uniform:"uniformMatrix3fv"},{name:"u_scrollY",uniform:"uniform1f"},{name:"u_pixelRatio",uniform:"uniform1f"},{name:"u_texture",uniform:"uniform2f"},{name:"u_color",uniform:"uniform4fv"},{name:"u_size",uniform:"uniform1f"},{name:"u_distanceRange",uniform:"uniform1f"},{name:"u_debug",uniform:"uniform1i"}]})}bindTextures(e){const{glw:t}=this;t.activeTexture(0),t.bindTexture(e[0].ctxTexture)}bindProps(e){const t=Ke.resolveDefaults(e);for(const e in t)if("transform"===e)this.setUniform("u_transform",!1,t[e]);else if("scrollY"===e)this.setUniform("u_scrollY",t[e]);else if("color"===e){const e=Q(t.color);this.setUniform("u_color",e)}else"size"===e?this.setUniform("u_size",t[e]):"distanceRange"===e?this.setUniform("u_distanceRange",t[e]):"debug"===e&&this.setUniform("u_debug",t[e]?1:0)}static resolveDefaults(e={}){return{transform:e.transform??je,scrollY:e.scrollY??0,color:e.color??4294967295,size:e.size??16,distanceRange:e.distanceRange??1,debug:e.debug??!1}}static shaderSources={vertex:"\n      // an attribute is an input (in) to a vertex shader.\n      // It will receive data from a buffer\n      attribute vec2 a_position;\n      attribute vec2 a_textureCoordinate;\n\n      uniform vec2 u_resolution;\n      uniform mat3 u_transform;\n      uniform float u_scrollY;\n      uniform float u_pixelRatio;\n      uniform float u_size;\n\n      varying vec2 v_texcoord;\n\n      void main() {\n        vec2 scrolledPosition = a_position * u_size - vec2(0, u_scrollY);\n        vec2 transformedPosition = (u_transform * vec3(scrolledPosition, 1)).xy;\n\n        // Calculate screen space with pixel ratio\n        vec2 screenSpace = (transformedPosition * u_pixelRatio / u_resolution * 2.0 - 1.0) * vec2(1, -1);\n\n        gl_Position = vec4(screenSpace, 0.0, 1.0);\n        v_texcoord = a_textureCoordinate;\n\n      }\n    ",fragment:"\n      precision highp float;\n\n      uniform vec4 u_color;\n      uniform sampler2D u_texture;\n      uniform float u_distanceRange;\n      uniform float u_pixelRatio;\n      uniform int u_debug;\n\n      varying vec2 v_texcoord;\n\n      float median(float r, float g, float b) {\n          return max(min(r, g), min(max(r, g), b));\n      }\n\n      void main() {\n          vec3 sample = texture2D(u_texture, v_texcoord).rgb;\n          if (u_debug == 1) {\n            gl_FragColor = vec4(sample.r, sample.g, sample.b, 1.0);\n            return;\n          }\n          float scaledDistRange = u_distanceRange * u_pixelRatio;\n          float sigDist = scaledDistRange * (median(sample.r, sample.g, sample.b) - 0.5);\n          float opacity = clamp(sigDist + 0.5, 0.0, 1.0) * u_color.a;\n\n          // Build the final color.\n          // IMPORTANT: We must premultiply the color by the alpha value before returning it.\n          gl_FragColor = vec4(u_color.r * opacity, u_color.g * opacity, u_color.b * opacity, opacity);\n      }\n    "}}const qe=e=>{void 0===e.programValue&&(e.programValue=new Float32Array(4));const t=e.value,r=e.programValue;r[0]=(t>>>24)/255,r[1]=(t>>>16&255)/255,r[2]=(t>>>8&255)/255,r[3]=(255&t)/255},Ze=e=>{const t=e.validatedValue||e.value;if(e.programValue instanceof Float32Array){const r=e.programValue;r[0]=t[0],r[1]=t[1]}else e.programValue=new Float32Array(t)},Qe=e=>{const t=e.validatedValue||e.value;if(e.programValue instanceof Float32Array){const r=e.programValue;r[0]=t[0],r[1]=t[1],r[2]=t[1],r[3]=t[1]}else e.programValue=new Float32Array(t)},Je=e=>{const t=e.validatedValue||e.value;if(e.programValue instanceof Float32Array){const r=t.length,s=e.programValue;for(let e=0;e<r;e++)s[e]=t[e]}else e.programValue=new Float32Array(t)},et=e=>{const t=Array.isArray(e);return t?t&&4===e.length?e:t&&2===e.length?[e[0],e[1],e[0],e[1]]:t&&3===e.length?[e[0],e[1],e[2],e[0]]:[e[0],e[0],e[0],e[0]]:[e,e,e,e]},tt=(e,t)=>{void 0===e.programValue&&(e.programValue=new Float32Array(4));const r=e.programValue,s=e.validatedValue||e.value;if(void 0===t&&void 0===e.$dimensions)return r[0]=s[0],r[1]=s[1],r[2]=s[2],void(r[3]=s[3]);let n=e.$dimensions;if(void 0!==t){const{$dimensions:r}=t;if(void 0!==n&&(n.width===r.width||n.height===r.height))return;void 0===n&&(n={width:r?.width,height:r?.height},e.$dimensions=n)}const{width:i,height:o}=n,[a,l,h,c]=s,d=Math.min(Math.min(Math.min(i/Math.max(i,a+l),i/Math.max(i,h+c)),Math.min(o/Math.max(o,a+h),o/Math.max(o,l+c))),1);r[0]=a*d,r[1]=l*d,r[2]=h*d,r[3]=c*d};class rt extends Xe{static z$__type__Props;name="radius";static getEffectKey(){return"radius"}static uniforms={radius:{value:0,method:"uniform4fv",type:"vec4",updateOnBind:!0,validator:et,updateProgramValue:tt}};static methods={fillMask:"\n      float function(float dist) {\n        return clamp(-dist, 0.0, 1.0);\n      }\n    ",boxDist:"\n      float function(vec2 p, vec2 size, float radius) {\n        size -= vec2(radius);\n        vec2 d = abs(p) - size;\n        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0)) - radius;\n      }\n    "};static resolveDefaults(e){return{radius:e.radius??10}}static onShaderMask="\n  vec2 halfDimensions = u_dimensions * 0.5;\n  float r = radius[0] * step(v_textureCoordinate.x, 0.5) * step(v_textureCoordinate.y, 0.5);\n  r = r + radius[1] * step(0.5, v_textureCoordinate.x) * step(v_textureCoordinate.y, 0.5);\n  r = r + radius[2] * step(0.5, v_textureCoordinate.x) * step(0.5, v_textureCoordinate.y);\n  r = r + radius[3] * step(v_textureCoordinate.x, 0.5) * step(0.5, v_textureCoordinate.y);\n  return $boxDist(v_textureCoordinate.xy * u_dimensions - halfDimensions, halfDimensions, r);\n  ";static onEffectMask="\n  return mix(vec4(0.0), maskColor, $fillMask(shaderMask));\n  "}class st extends Xe{static z$__type__Props;name="border";static getEffectKey(){return"border"}static resolveDefaults(e){return{width:e.width??10,color:e.color??4294967295}}static uniforms={width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:qe,method:"uniform4fv",type:"vec4"}};static onEffectMask="\n  float intR = shaderMask + 1.0;\n  float mask = clamp(intR + width, 0.0, 1.0) - clamp(intR, 0.0, 1.0);\n  return mix(shaderColor, mix(shaderColor, maskColor, maskColor.a), mask);\n  ";static onColorize="\n    return color;\n  "}class nt extends Xe{static z$__type__Props;name="linearGradient";static getEffectKey(e){return`linearGradient${e.colors.length}`}static resolveDefaults(e){const t=e.colors??[4278190080,4294967295];let r=e.stops||[];if(0===r.length||r.length!==t.length){const e=t.length;let s=0;const n=r;for(;s<e;s++)r[s]?(n[s]=r[s],void 0===r[s-1]&&void 0!==n[s-2]&&(n[s-1]=n[s-2]+(r[s]-n[s-2])/2)):n[s]=s*(1/(t.length-1));r=n}return{colors:t,stops:r,angle:e.angle??0}}static uniforms={angle:{value:0,method:"uniform1f",type:"float"},colors:{value:4294967295,validator:e=>e.reduce(((e,t)=>e.concat(Q(t))),[]),updateProgramValue:Je,size:e=>e.colors.length,method:"uniform4fv",type:"vec4"},stops:{value:[],size:e=>e.colors.length,method:"uniform1fv",type:"float"}};static methods={fromLinear:"\n      vec4 function(vec4 linearRGB) {\n        vec4 higher = vec4(1.055)*pow(linearRGB, vec4(1.0/2.4)) - vec4(0.055);\n        vec4 lower = linearRGB * vec4(12.92);\n        return mix(higher, lower, 1.0);\n      }\n    ",toLinear:"\n      vec4 function(vec4 sRGB) {\n        vec4 higher = pow((sRGB + vec4(0.055))/vec4(1.055), vec4(2.4));\n        vec4 lower = sRGB/vec4(12.92);\n        return mix(higher, lower, 1.0);\n      }\n    ",calcPoint:"\n      vec2 function(float d, float angle) {\n        return d * vec2(cos(angle), sin(angle)) + (u_dimensions * 0.5);\n      }\n    "};static ColorLoop=e=>{let t="";for(let r=2;r<e;r++)t+=`colorOut = mix(colorOut, colors[${r}], clamp((dist - stops[${r-1}]) / (stops[${r}] - stops[${r-1}]), 0.0, 1.0));`;return t};static onColorize=e=>{const t=e.colors.length||1;return`\n      float a = angle - (PI / 180.0 * 90.0);\n      float lineDist = abs(u_dimensions.x * cos(a)) + abs(u_dimensions.y * sin(a));\n      vec2 f = $calcPoint(lineDist * 0.5, a);\n      vec2 t = $calcPoint(lineDist * 0.5, a + PI);\n      vec2 gradVec = t - f;\n      float dist = dot(v_textureCoordinate.xy * u_dimensions - f, gradVec) / dot(gradVec, gradVec);\n\n      float stopCalc = (dist - stops[0]) / (stops[1] - stops[0]);\n      vec4 colorOut = $fromLinear(mix($toLinear(colors[0]), $toLinear(colors[1]), stopCalc));\n      ${this.ColorLoop(t)}\n      return mix(maskColor, colorOut, clamp(colorOut.a, 0.0, 1.0));\n    `}}class it extends Xe{name="grayscale";static getEffectKey(){return"grayscale"}static resolveDefaults(e){return{amount:e.amount??1}}static uniforms={amount:{value:1,method:"uniform1f",type:"float"}};static onColorize="\n    float grayness = 0.2 * maskColor.r + 0.6 * maskColor.g + 0.2 * maskColor.b;\n    return vec4(amount * vec3(grayness) + (1.0 - amount) * maskColor.rgb, maskColor.a);\n  "}class ot extends Xe{static z$__type__Props;name="borderRight";static getEffectKey(){return"borderRight"}static resolveDefaults(e){return{width:e.width??10,color:e.color??4294967295}}static uniforms={width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:qe,method:"uniform4fv",type:"vec4"}};static methods={fillMask:"\n      float function(float dist) {\n        return clamp(-dist, 0.0, 1.0);\n      }\n    ",rectDist:"\n      float function(vec2 p, vec2 size) {\n        vec2 d = abs(p) - size;\n        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));\n      }\n    "};static onEffectMask="\n  vec2 pos = vec2(u_dimensions.x - width * 0.5, 0.0);\n  float mask = $rectDist(v_textureCoordinate.xy * u_dimensions - pos, vec2(width*0.5, u_dimensions.y));\n  return mix(shaderColor, maskColor, $fillMask(mask));\n  ";static onColorize="\n    return color;\n  "}class at extends Xe{static z$__type__Props;name="borderTop";static getEffectKey(){return"borderTop"}static resolveDefaults(e){return{width:e.width??10,color:e.color??4294967295}}static uniforms={width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:qe,method:"uniform4fv",type:"vec4"}};static methods={fillMask:"\n      float function(float dist) {\n        return clamp(-dist, 0.0, 1.0);\n      }\n    ",rectDist:"\n      float function(vec2 p, vec2 size) {\n        vec2 d = abs(p) - size;\n        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));\n      }\n    "};static onEffectMask="\n  vec2 pos = vec2(0.0, width * 0.5);\n  float mask = $rectDist(v_textureCoordinate.xy * u_dimensions - pos, vec2(u_dimensions.x, width*0.5));\n  return mix(shaderColor, maskColor, $fillMask(mask));\n  ";static onColorize="\n    return color;\n  "}class lt extends Xe{static z$__type__Props;name="borderBottom";static getEffectKey(){return"borderBottom"}static resolveDefaults(e){return{width:e.width??10,color:e.color??4294967295}}static uniforms={width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:qe,method:"uniform4fv",type:"vec4"}};static methods={fillMask:"\n      float function(float dist) {\n        return clamp(-dist, 0.0, 1.0);\n      }\n    ",rectDist:"\n      float function(vec2 p, vec2 size) {\n        vec2 d = abs(p) - size;\n        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));\n      }\n    "};static onEffectMask="\n  vec2 pos = vec2(0.0, u_dimensions.y - width * 0.5);\n  float mask = $rectDist(v_textureCoordinate.xy * u_dimensions - pos, vec2(u_dimensions.x, width*0.5));\n  return mix(shaderColor, maskColor, $fillMask(mask));\n  ";static onColorize="\n    return color;\n  "}class ht extends Xe{static z$__type__Props;name="borderLeft";static getEffectKey(){return"borderLeft"}static resolveDefaults(e){return{width:e.width??10,color:e.color??4294967295}}static uniforms={width:{value:0,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:qe,method:"uniform4fv",type:"vec4"}};static methods={fillMask:"\n      float function(float dist) {\n        return clamp(-dist, 0.0, 1.0);\n      }\n    ",rectDist:"\n      float function(vec2 p, vec2 size) {\n        vec2 d = abs(p) - size;\n        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));\n      }\n    "};static onEffectMask="\n  vec2 pos = vec2(width * 0.5, 0.0);\n  float mask = $rectDist(v_textureCoordinate.xy * u_dimensions - pos, vec2(width*0.5, u_dimensions.y));\n  return mix(shaderColor, maskColor, $fillMask(mask));\n  ";static onColorize="\n    return color;\n  "}class ct extends Xe{static z$__type__Props;name="glitch";static getEffectKey(e){return"glitch"}static resolveDefaults(e){return{amplitude:e.amplitude??.2,narrowness:e.narrowness??4,blockiness:e.blockiness??2,minimizer:e.minimizer??8,time:e.time??Date.now()}}static uniforms={amplitude:{value:0,method:"uniform1f",type:"float"},narrowness:{value:0,method:"uniform1f",type:"float"},blockiness:{value:0,method:"uniform1f",type:"float"},minimizer:{value:0,method:"uniform1f",type:"float"},time:{value:0,method:"uniform1f",updateOnBind:!0,updateProgramValue:e=>{const t=e.value=(Date.now()-e.value)%1e3;e.programValue=t},type:"float"}};static methods={rand:"\n      float function(vec2 p, float time) {\n        float t = floor(time * 20.) / 10.;\n        return fract(sin(dot(p, vec2(t * 12.9898, t * 78.233))) * 43758.5453);\n      }\n    ",noise:"\n      float function(vec2 uv, float blockiness, float time) {\n        vec2 lv = fract(uv);\n        vec2 id = floor(uv);\n\n        float n1 = rand(id, time);\n        float n2 = rand(id+vec2(1,0), time);\n        float n3 = rand(id+vec2(0,1), time);\n        float n4 = rand(id+vec2(1,1), time);\n        vec2 u = smoothstep(0.0, 1.0 + blockiness, lv);\n        return mix(mix(n1, n2, u.x), mix(n3, n4, u.x), u.y);\n      }\n    ",fbm:"\n      float function(vec2 uv, int count, float blockiness, float complexity, float time) {\n        float val = 0.0;\n        float amp = 0.5;\n        const int MAX_ITERATIONS = 10;\n\n        for(int i = 0; i < MAX_ITERATIONS; i++) {\n          if(i >= count) {break;}\n          val += amp * noise(uv, blockiness, time);\n          amp *= 0.5;\n          uv *= complexity;\n        }\n        return val;\n      }\n    "};static onColorize="\n    vec2 uv = v_textureCoordinate.xy;\n    float aspect = u_dimensions.x / u_dimensions.y;\n    vec2 a = vec2(uv.x * aspect , uv.y);\n    vec2 uv2 = vec2(a.x / u_dimensions.x, exp(a.y));\n\n    float shift = amplitude * pow($fbm(uv2, 4, blockiness, narrowness, time), minimizer);\n    float colR = texture2D(u_texture, vec2(uv.x + shift, uv.y)).r * (1. - shift);\n    float colG = texture2D(u_texture, vec2(uv.x - shift, uv.y)).g * (1. - shift);\n    float colB = texture2D(u_texture, vec2(uv.x - shift, uv.y)).b * (1. - shift);\n\n    vec3 f = vec3(colR, colG, colB);\n    return vec4(f, texture2D(u_texture, vec2(uv.x - shift, uv.y)).a);\n  "}class dt extends Xe{static z$__type__Props;name="fadeOut";static getEffectKey(){return"fadeOut"}static uniforms={fade:{value:0,method:"uniform4fv",type:"vec4",validator:et,updateProgramValue:Qe}};static resolveDefaults(e){return{fade:e.fade??10}}static onColorize="\n  vec2 point = v_textureCoordinate.xy * u_dimensions.xy;\n  vec2 pos1;\n  vec2 pos2;\n  vec2 d;\n  float c;\n  vec4 result = maskColor;\n\n\n  if(fade[0] > 0.0) {\n    pos1 = vec2(point.x, point.y);\n    pos2 = vec2(point.x, point.y + fade[0]);\n    d = pos2 - pos1;\n    c = dot(pos1, d) / dot(d, d);\n    result = mix(vec4(0.0), result, smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0)));\n  }\n\n  if(fade[1] > 0.0) {\n    pos1 = vec2(point.x - u_dimensions.x - fade[1], v_textureCoordinate.y);\n    pos2 = vec2(point.x - u_dimensions.x, v_textureCoordinate.y);\n    d = pos1 - pos2;\n    c = dot(pos2, d) / dot(d, d);\n    result = mix(vec4(0.0), result, smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0)));\n  }\n\n  if(fade[2] > 0.0) {\n    pos1 = vec2(v_textureCoordinate.x, point.y - u_dimensions.y - fade[2]);\n    pos2 = vec2(v_textureCoordinate.x, point.y - u_dimensions.y);\n    d = pos1 - pos2;\n    c = dot(pos2, d) / dot(d, d);\n    result = mix(vec4(0.0), result, smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0)));\n  }\n\n  if(fade[3] > 0.0) {\n    pos1 = vec2(point.x, point.y);\n    pos2 = vec2(point.x + fade[3], point.y);\n    d = pos2 - pos1;\n    c = dot(pos1, d) / dot(d, d);\n    result = mix(vec4(0.0), result, smoothstep(0.0, 1.0, clamp(c, 0.0, 1.0)));\n  }\n\n  return result;\n  "}class ut extends Xe{static z$__type__Props;name="radialGradient";static getEffectKey(e){return`radialGradient${e.colors.length}`}static resolveDefaults(e){const t=e.colors??[4278190080,4294967295];let r=e.stops||[];if(0===r.length||r.length!==t.length){const e=t.length;let s=0;const n=r;for(;s<e;s++)r[s]?(n[s]=r[s],void 0===r[s-1]&&void 0!==n[s-2]&&(n[s-1]=n[s-2]+(r[s]-n[s-2])/2)):n[s]=s*(1/(t.length-1));r=n}return{colors:t,stops:r,width:e.width??0,height:e.height??e.width??0,pivot:e.pivot??[.5,.5]}}static uniforms={width:{value:0,method:"uniform1f",type:"float"},height:{value:0,method:"uniform1f",type:"float"},pivot:{value:[.5,.5],updateProgramValue:Ze,method:"uniform2fv",type:"vec2"},colors:{value:4294967295,validator:e=>e.reduce(((e,t)=>e.concat(Q(t))),[]),updateProgramValue:Je,size:e=>e.colors.length,method:"uniform4fv",type:"vec4"},stops:{value:[],size:e=>e.colors.length,method:"uniform1fv",type:"float"}};static ColorLoop=e=>{let t="";for(let r=2;r<e;r++)t+=`colorOut = mix(colorOut, colors[${r}], clamp((dist - stops[${r-1}]) / (stops[${r}] - stops[${r-1}]), 0.0, 1.0));`;return t};static onColorize=e=>{const t=e.colors.length||1;return`\n      vec2 point = v_textureCoordinate.xy * u_dimensions;\n      vec2 projection = vec2(pivot.x * u_dimensions.x, pivot.y * u_dimensions.y);\n\n      float dist = length((point - projection) / vec2(width, height));\n\n      float stopCalc = (dist - stops[0]) / (stops[1] - stops[0]);\n      vec4 colorOut = mix(colors[0], colors[1], stopCalc);\n      ${this.ColorLoop(t)}\n      return mix(maskColor, colorOut, clamp(colorOut.a, 0.0, 1.0));\n    `}}class pt extends Xe{static z$__type__Props;name="radialProgress";static getEffectKey(){return"radialProgress"}static resolveDefaults(e){return{width:e.width??10,progress:e.progress??.5,offset:e.offset??0,range:e.range??2*Math.PI,rounded:e.rounded??!1,radius:e.radius??1,color:e.color??4294967295}}static uniforms={width:{value:0,method:"uniform1f",type:"float"},progress:{value:.5,method:"uniform1f",type:"float"},offset:{value:0,method:"uniform1f",type:"float"},range:{value:0,method:"uniform1f",type:"float"},rounded:{value:0,method:"uniform1f",type:"float",validator:e=>e?1:0},radius:{value:1,method:"uniform1f",type:"float"},color:{value:4294967295,updateProgramValue:qe,method:"uniform4fv",type:"vec4"}};static methods={rotateUV:"\n    vec2 function(vec2 uv, float d) {\n      float s = sin(d);\n      float c = cos(d);\n      mat2 rotMatrix = mat2(c, -s, s, c);\n      return uv * rotMatrix;\n    }\n    ",drawDot:"\n    float function(vec2 uv, vec2 p, float r) {\n      uv += p;\n      float circle = length(uv) - r;\n      return clamp(-circle, 0.0, 1.0);\n    }\n    "};static onEffectMask="\n    float outerRadius = radius * u_dimensions.y * 0.5;\n\n    float endAngle = range * progress - 0.0005;\n\n    vec2 uv = v_textureCoordinate.xy * u_dimensions.xy - u_dimensions * 0.5;\n\n    uv = $rotateUV(uv, -(offset));\n    float linewidth = width * u_pixelRatio;\n    float circle = length(uv) - (outerRadius - linewidth) ;\n    circle = abs(circle) - linewidth;\n    circle = clamp(-circle, 0.0, 1.0);\n\n    float angle = (atan(uv.x, -uv.y) / 3.14159265359 * 0.5);\n    float p = endAngle / (PI * 2.);\n\n    circle *= step(fract(angle), fract(p));\n\n    circle = rounded < 1. ? circle : max(circle, $drawDot(uv, vec2(0, outerRadius - linewidth), linewidth));\n    circle = rounded < 1. ? circle : max(circle, $drawDot($rotateUV(uv, -(endAngle)), vec2(0, outerRadius - linewidth), linewidth));\n\n    return mix(shaderColor, maskColor, circle);\n  ";static onColorize="\n    return color;\n  "}class ft extends Xe{static z$__type__Props;name="holePunch";static getEffectKey(){return"holePunch"}static uniforms={x:{value:0,method:"uniform1f",type:"float"},y:{value:0,method:"uniform1f",type:"float"},width:{value:0,method:"uniform1f",type:"float"},height:{value:0,method:"uniform1f",type:"float"},radius:{value:0,method:"uniform4fv",type:"vec4",updateOnBind:!0,validator:et,updateProgramValue:tt}};static resolveDefaults(e){return{x:e.x||0,y:e.y||0,width:e.width||50,height:e.height||50,radius:e.radius??0}}static methods={fillMask:"\n      float function(float dist) {\n        return clamp(-dist, 0.0, 1.0);\n      }\n    ",boxDist:"\n      float function(vec2 p, vec2 size, float radius) {\n        size -= vec2(radius);\n        vec2 d = abs(p) - size;\n        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0)) - radius;\n      }\n    "};static onShaderMask="\n  vec2 halfDimensions = u_dimensions * 0.5;\n  vec2 size = vec2(width, height) * 0.5;\n  vec2 basePos = v_textureCoordinate.xy * u_dimensions.xy - vec2(x, y);\n  vec2 pos = basePos - size;\n  float r = radius[0] * step(pos.x, 0.5) * step(pos.y, 0.5);\n  r = r + radius[1] * step(0.5, pos.x) * step(pos.y, 0.5);\n  r = r + radius[2] * step(0.5, pos.x) * step(0.5, pos.y);\n  r = r + radius[3] * step(pos.x, 0.5) * step(0.5, pos.y);\n  return $boxDist(pos, size, r);\n  ";static onEffectMask="\n  return mix(maskColor, vec4(0.0), $fillMask(shaderMask));\n  "}const mt="RoundedRectangle";class gt extends Me{shType;constructor(e){super(),this.shType=e,e!==mt&&console.warn("Unsupported shader:",e)}bindRenderOp(){}bindProps(){}attach(){}detach(){}}class xt{type;shader;resolvedProps;props;constructor(e,t,r,s){this.type=e,this.shader=t,this.resolvedProps=r;const n=Object.keys(r),i=n.length,o={};for(let e=0;e<i;e++){const t=n[e];Object.defineProperty(o,t,{get:()=>this.resolvedProps[t],set:e=>{this.resolvedProps[t]=e,s.requestRender()}})}this.props=o}getResolvedProps(){return this.resolvedProps}}class yt{shader;resolvedProps;props;type;constructor(e,t,r){this.shader=e,this.type="DynamicShader",this.resolvedProps=t;const s=r.getRegisteredEffects(),n={},i=t.effects,o=i.length;for(let e=0;e<o;e++){const{name:t,props:o,type:a}=i[e];if(void 0===t)continue;const l={},h=Object.keys(o),c=h.length;for(let t=0;t<c;t++){const n=h[t];Object.defineProperty(l,n,{get:()=>this.resolvedProps.effects[e].props[n].value,set:t=>{const i=this.resolvedProps.effects[e].props[n];i.value=t,i.hasValidator&&(t=i.validatedValue=s[a].uniforms[n]?.validator(t,o)),i.hasProgramValueUpdater?s[a].uniforms[n]?.updateProgramValue(i):i.programValue=t,r.renderer.stage.requestRender()}})}Object.defineProperty(n,t,{get:()=>l})}this.props=n}getResolvedProps(){return this.resolvedProps}}class vt{shCache=new Map;shConstructors={};attachedShader=null;effectConstructors={};renderer;constructor(){this.registerShaderType("DefaultShader",ze),this.registerShaderType("DefaultShaderBatched",Ge),this.registerShaderType("RoundedRectangle",He),this.registerShaderType("DynamicShader",Ye),this.registerShaderType("SdfShader",Ke),this.registerEffectType("border",st),this.registerEffectType("borderBottom",lt),this.registerEffectType("borderLeft",ht),this.registerEffectType("borderRight",ot),this.registerEffectType("borderTop",at),this.registerEffectType("fadeOut",dt),this.registerEffectType("linearGradient",nt),this.registerEffectType("radialGradient",ut),this.registerEffectType("grayscale",it),this.registerEffectType("glitch",ct),this.registerEffectType("radius",rt),this.registerEffectType("radialProgress",pt),this.registerEffectType("holePunch",ft)}registerShaderType(e,t){this.shConstructors[e]=t}registerEffectType(e,t){this.effectConstructors[e]=t}getRegisteredEffects(){return this.effectConstructors}getRegisteredShaders(){return this.shConstructors}loadShader(e,t){if(!this.renderer)throw new Error("Renderer is not been defined");const r=this.shConstructors[e];if(!r)throw new Error(`Shader type "${e}" is not registered`);if("canvas"===this.renderer.mode&&r.prototype instanceof Fe)return this._createShaderCtr(e,new gt(e),t);if("DynamicShader"===e)return this.loadDynamicShader(t);const s=r.resolveDefaults(t),n=r.makeCacheKey(s)||r.name;if(n&&this.shCache.has(n))return this._createShaderCtr(e,this.shCache.get(n),s);const i=new r(this.renderer,t);return n&&this.shCache.set(n,i),this._createShaderCtr(e,i,s)}loadDynamicShader(e){if(!this.renderer)throw new Error("Renderer is not been defined");const t=Ye.resolveDefaults(e,this.effectConstructors),r=Ye.makeCacheKey(t,this.effectConstructors);if(r&&this.shCache.has(r))return this._createDynShaderCtr(this.shCache.get(r),t);const s=new Ye(this.renderer,e,this.effectConstructors);return r&&this.shCache.set(r,s),this._createDynShaderCtr(s,t)}_createShaderCtr(e,t,r){return new xt(e,t,r,this.renderer.stage)}_createDynShaderCtr(e,t){return new yt(e,t,this)}useShader(e){this.attachedShader!==e&&(this.attachedShader&&this.attachedShader.detach(),e.attach(),this.attachedShader=e)}}class Tt{config;constructor(e){this.config=e}getBuffer(e){return this.config.find((t=>t.attributes[e]))?.buffer}getAttributeInfo(e){return this.config.find((t=>t.attributes[e]))?.attributes[e]}}class bt{gl;activeTextureUnit=0;texture2dUnits;texture2dParams=new WeakMap;scissorEnabled;scissorX;scissorY;scissorWidth;scissorHeight;blendEnabled;blendSrcRgb;blendDstRgb;blendSrcAlpha;blendDstAlpha;boundArrayBuffer;boundElementArrayBuffer;curProgram;programUniforms=new WeakMap;canvas;MAX_RENDERBUFFER_SIZE;MAX_TEXTURE_SIZE;MAX_VIEWPORT_DIMS;MAX_VERTEX_TEXTURE_IMAGE_UNITS;MAX_TEXTURE_IMAGE_UNITS;MAX_COMBINED_TEXTURE_IMAGE_UNITS;MAX_VERTEX_ATTRIBS;MAX_VARYING_VECTORS;MAX_VERTEX_UNIFORM_VECTORS;MAX_FRAGMENT_UNIFORM_VECTORS;TEXTURE_MAG_FILTER;TEXTURE_MIN_FILTER;TEXTURE_WRAP_S;TEXTURE_WRAP_T;LINEAR;CLAMP_TO_EDGE;RGBA;UNSIGNED_BYTE;UNPACK_PREMULTIPLY_ALPHA_WEBGL;UNPACK_FLIP_Y_WEBGL;FLOAT;TRIANGLES;UNSIGNED_SHORT;ONE;ONE_MINUS_SRC_ALPHA;VERTEX_SHADER;FRAGMENT_SHADER;STATIC_DRAW;COMPILE_STATUS;LINK_STATUS;DYNAMIC_DRAW;COLOR_ATTACHMENT0;constructor(e){this.gl=e,this.activeTextureUnit=e.getParameter(e.ACTIVE_TEXTURE)-e.TEXTURE0;const t=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);this.texture2dUnits=new Array(t).fill(void 0).map(((t,r)=>(this.activeTexture(r),e.getParameter(e.TEXTURE_BINDING_2D)))),this.activeTexture(this.activeTextureUnit),this.scissorEnabled=e.isEnabled(e.SCISSOR_TEST);const r=e.getParameter(e.SCISSOR_BOX);this.scissorX=r[0],this.scissorY=r[1],this.scissorWidth=r[2],this.scissorHeight=r[3],this.blendEnabled=e.isEnabled(e.BLEND),this.blendSrcRgb=e.getParameter(e.BLEND_SRC_RGB),this.blendDstRgb=e.getParameter(e.BLEND_DST_RGB),this.blendSrcAlpha=e.getParameter(e.BLEND_SRC_ALPHA),this.blendDstAlpha=e.getParameter(e.BLEND_DST_ALPHA),this.boundArrayBuffer=e.getParameter(e.ARRAY_BUFFER_BINDING),this.boundElementArrayBuffer=e.getParameter(e.ELEMENT_ARRAY_BUFFER_BINDING),this.curProgram=e.getParameter(e.CURRENT_PROGRAM),this.canvas=e.canvas,this.MAX_RENDERBUFFER_SIZE=e.MAX_RENDERBUFFER_SIZE,this.MAX_TEXTURE_SIZE=e.MAX_TEXTURE_SIZE,this.MAX_VIEWPORT_DIMS=e.MAX_VIEWPORT_DIMS,this.MAX_VERTEX_TEXTURE_IMAGE_UNITS=e.MAX_VERTEX_TEXTURE_IMAGE_UNITS,this.MAX_TEXTURE_IMAGE_UNITS=e.MAX_TEXTURE_IMAGE_UNITS,this.MAX_COMBINED_TEXTURE_IMAGE_UNITS=e.MAX_COMBINED_TEXTURE_IMAGE_UNITS,this.MAX_VERTEX_ATTRIBS=e.MAX_VERTEX_ATTRIBS,this.MAX_VARYING_VECTORS=e.MAX_VARYING_VECTORS,this.MAX_VERTEX_UNIFORM_VECTORS=e.MAX_VERTEX_UNIFORM_VECTORS,this.MAX_FRAGMENT_UNIFORM_VECTORS=e.MAX_FRAGMENT_UNIFORM_VECTORS,this.TEXTURE_MAG_FILTER=e.TEXTURE_MAG_FILTER,this.TEXTURE_MIN_FILTER=e.TEXTURE_MIN_FILTER,this.TEXTURE_WRAP_S=e.TEXTURE_WRAP_S,this.TEXTURE_WRAP_T=e.TEXTURE_WRAP_T,this.LINEAR=e.LINEAR,this.CLAMP_TO_EDGE=e.CLAMP_TO_EDGE,this.RGBA=e.RGBA,this.UNSIGNED_BYTE=e.UNSIGNED_BYTE,this.UNPACK_PREMULTIPLY_ALPHA_WEBGL=e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.UNPACK_FLIP_Y_WEBGL=e.UNPACK_FLIP_Y_WEBGL,this.FLOAT=e.FLOAT,this.TRIANGLES=e.TRIANGLES,this.UNSIGNED_SHORT=e.UNSIGNED_SHORT,this.ONE=e.ONE,this.ONE_MINUS_SRC_ALPHA=e.ONE_MINUS_SRC_ALPHA,this.MAX_VERTEX_TEXTURE_IMAGE_UNITS=e.MAX_VERTEX_TEXTURE_IMAGE_UNITS,this.TRIANGLES=e.TRIANGLES,this.UNSIGNED_SHORT=e.UNSIGNED_SHORT,this.VERTEX_SHADER=e.VERTEX_SHADER,this.FRAGMENT_SHADER=e.FRAGMENT_SHADER,this.STATIC_DRAW=e.STATIC_DRAW,this.COMPILE_STATUS=e.COMPILE_STATUS,this.LINK_STATUS=e.LINK_STATUS,this.DYNAMIC_DRAW=e.DYNAMIC_DRAW,this.COLOR_ATTACHMENT0=e.COLOR_ATTACHMENT0}isWebGl2(){return e=this.gl,self.WebGL2RenderingContext&&e instanceof self.WebGL2RenderingContext;var e}activeTexture(e){const{gl:t}=this;this.activeTextureUnit!==e&&(t.activeTexture(e+t.TEXTURE0),this.activeTextureUnit=e)}bindTexture(e){const{gl:t,activeTextureUnit:r,texture2dUnits:s}=this;s[r]!==e&&(s[r]=e,t.bindTexture(this.gl.TEXTURE_2D,e))}_getActiveTexture(){const{activeTextureUnit:e,texture2dUnits:t}=this;return t[e]}texParameteri(e,t){const{gl:r,texture2dParams:s}=this,n=this._getActiveTexture();if(!n)throw new Error("No active texture");let i=s.get(n);i||(i={},s.set(n,i)),i[e]!==t&&(i[e]=t,r.texParameteri(r.TEXTURE_2D,e,t))}texImage2D(e,t,r,s,n,i,o,a){const{gl:l}=this;i?l.texImage2D(l.TEXTURE_2D,e,t,r,s,n,i,o,a):l.texImage2D(l.TEXTURE_2D,e,t,r,s,n)}compressedTexImage2D(e,t,r,s,n,i){const{gl:o}=this;o.compressedTexImage2D(o.TEXTURE_2D,e,t,r,s,n,i)}pixelStorei(e,t){const{gl:r}=this;r.pixelStorei(e,t)}generateMipmap(){const{gl:e}=this;e.generateMipmap(e.TEXTURE_2D)}createTexture(){const{gl:e}=this;return e.createTexture()}deleteTexture(e){const{gl:t}=this;e&&this.texture2dParams.delete(e),t.deleteTexture(e)}viewport(e,t,r,s){const{gl:n}=this;n.viewport(e,t,r,s)}clearColor(e,t,r,s){const{gl:n}=this;n.clearColor(e,t,r,s)}setScissorTest(e){const{gl:t,scissorEnabled:r}=this;e!==r&&(e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),this.scissorEnabled=e)}scissor(e,t,r,s){const{gl:n,scissorX:i,scissorY:o,scissorWidth:a,scissorHeight:l}=this;e===i&&t===o&&r===a&&s===l||(n.scissor(e,t,r,s),this.scissorX=e,this.scissorY=t,this.scissorWidth=r,this.scissorHeight=s)}setBlend(e){const{gl:t,blendEnabled:r}=this;e!==r&&(e?t.enable(t.BLEND):t.disable(t.BLEND),this.blendEnabled=e)}blendFunc(e,t){const{gl:r,blendSrcRgb:s,blendDstRgb:n,blendSrcAlpha:i,blendDstAlpha:o}=this;e===s&&t===n&&e===i&&t===o||(r.blendFunc(e,t),this.blendSrcRgb=e,this.blendDstRgb=t,this.blendSrcAlpha=e,this.blendDstAlpha=t)}createBuffer(){const{gl:e}=this;return e.createBuffer()}createFramebuffer(){const{gl:e}=this;return e.createFramebuffer()}bindFramebuffer(e){const{gl:t}=this;t.bindFramebuffer(t.FRAMEBUFFER,e)}framebufferTexture2D(e,t,r){const{gl:s}=this;s.framebufferTexture2D(s.FRAMEBUFFER,e,s.TEXTURE_2D,t,r)}clear(){const{gl:e}=this;e.clear(e.COLOR_BUFFER_BIT)}arrayBufferData(e,t,r){const{gl:s,boundArrayBuffer:n}=this;n!==e&&(s.bindBuffer(s.ARRAY_BUFFER,e),this.boundArrayBuffer=e),s.bufferData(s.ARRAY_BUFFER,t,r)}elementArrayBufferData(e,t,r){const{gl:s,boundElementArrayBuffer:n}=this;n!==e&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,e),this.boundElementArrayBuffer=e),s.bufferData(s.ELEMENT_ARRAY_BUFFER,t,r)}vertexAttribPointer(e,t,r,s,n,i,o){const{gl:a,boundArrayBuffer:l}=this;l!==e&&(a.bindBuffer(a.ARRAY_BUFFER,e),this.boundArrayBuffer=e),a.vertexAttribPointer(t,r,s,n,i,o)}useProgram(e){const{gl:t,curProgram:r}=this;r!==e&&(t.useProgram(e),this.curProgram=e)}setUniform(e,t,...r){const{gl:s,programUniforms:n}=this;let i=n.get(this.curProgram);i||(i=new Map,n.set(this.curProgram,i));const o=i.get(t);o&&function(e,t){if(e.length!==t.length)return!1;return e.every(((e,r)=>!(Array.isArray(e)||e instanceof Float32Array)&&e===t[r]))}(o,r)||(i.set(t,r),s[e](t,...r))}getParameter(e){const{gl:t}=this;return t.getParameter(e)}drawElements(e,t,r,s){const{gl:n}=this;n.drawElements(e,t,r,s)}getExtension(e){const{gl:t}=this;return t.getExtension(e)}createVertexArray(){const{gl:e}=this;return G(e instanceof WebGL2RenderingContext),e.createVertexArray()}bindVertexArray(e){const{gl:t}=this;G(t instanceof WebGL2RenderingContext),t.bindVertexArray(e)}getAttribLocation(e,t){const{gl:r}=this;return r.getAttribLocation(e,t)}getUniformLocation(e,t){const{gl:r}=this;return r.getUniformLocation(e,t)}enableVertexAttribArray(e){const{gl:t}=this;t.enableVertexAttribArray(e)}disableVertexAttribArray(e){const{gl:t}=this;t.disableVertexAttribArray(e)}createShader(e){const{gl:t}=this;return t.createShader(e)}compileShader(e){const{gl:t}=this;t.compileShader(e)}attachShader(e,t){const{gl:r}=this;r.attachShader(e,t)}linkProgram(e){const{gl:t}=this;t.linkProgram(e)}deleteProgram(e){const{gl:t}=this;t.deleteProgram(e)}getShaderParameter(e,t){const{gl:r}=this;return r.getShaderParameter(e,t)}getShaderInfoLog(e){const{gl:t}=this;return t.getShaderInfoLog(e)}createProgram(){const{gl:e}=this;return e.createProgram()}getProgramParameter(e,t){const{gl:r}=this;return r.getProgramParameter(e,t)}getProgramInfoLog(e){const{gl:t}=this;return t.getProgramInfoLog(e)}shaderSource(e,t){const{gl:r}=this;r.shaderSource(e,t)}deleteShader(e){const{gl:t}=this;t.deleteShader(e)}}class wt extends Oe{props;constructor(e,t){super(e),this.props=wt.resolveDefaults(t||{})}get width(){return this.props.width}set width(e){this.props.width=e}get height(){return this.props.height}set height(e){this.props.height=e}async getTextureData(){return{data:null,premultiplyAlpha:null}}static resolveDefaults(e){return{width:e.width||256,height:e.height||256}}static z$__type__Props}class St extends Ue{framebuffer;constructor(e,t,r){super(e,t,r);const s=e.createFramebuffer();G(s,"Unable to create framebuffer"),this.framebuffer=s}async onLoadRequest(){const{glw:e}=this,t=this._nativeCtxTexture=this.createNativeCtxTexture(),{width:r,height:s}=this.textureSource;return e.texImage2D(0,e.RGBA,r,s,0,e.RGBA,e.UNSIGNED_BYTE,null),this.setTextureMemUse(r*s*4),e.bindFramebuffer(this.framebuffer),e.framebufferTexture2D(e.COLOR_ATTACHMENT0,t,0),e.bindFramebuffer(null),{width:r,height:s}}}const _t=async e=>{const t=new DataView(e),r=16909060===t.getUint32(12),s=[],n={glInternalFormat:t.getUint32(28,r),pixelWidth:t.getUint32(36,r),pixelHeight:t.getUint32(40,r),numberOfMipmapLevels:t.getUint32(56,r),bytesOfKeyValueData:t.getUint32(60,r)};let i=64;i+=n.bytesOfKeyValueData;for(let e=0;e<n.numberOfMipmapLevels;e++){const e=t.getUint32(i);i+=4,s.push(t.buffer.slice(i,e)),i+=e}return{data:{glInternalFormat:n.glInternalFormat,mipmaps:s,width:n.pixelWidth||0,height:n.pixelHeight||0,type:"ktx"},premultiplyAlpha:!1}},Rt=async e=>{const t=e,r=new Int32Array(t,0,13),s=r[12]+52,n=new Uint8Array(t,s),i=[],o={pixelWidth:r[7],pixelHeight:r[6],numberOfMipmapLevels:r[11]||0};let a=0,l=o.pixelWidth||0,h=o.pixelHeight||0;for(let e=0;e<o.numberOfMipmapLevels;e++){const e=(l+3>>2)*(h+3>>2)*8,r=new Uint8Array(t,n.byteOffset+a,e);i.push(r),a+=e,l>>=1,h>>=1}return{data:{glInternalFormat:36196,mipmaps:i,width:o.pixelWidth||0,height:o.pixelHeight||0,type:"pvr"},premultiplyAlpha:!1}};class Et extends Oe{props;constructor(e,t){super(e),this.props=Et.resolveDefaults(t)}hasAlphaChannel(e){return-1!==e.indexOf("image/png")}async getTextureData(){const{src:e,premultiplyAlpha:t}=this.props;if(!e)return{data:null};if("string"!=typeof e)return e instanceof ImageData?{data:e,premultiplyAlpha:t}:{data:e(),premultiplyAlpha:t};if(/\.(ktx|pvr)$/.test(e))return(async e=>{const t=await fetch(e),r=await t.arrayBuffer();return-1!==e.indexOf(".ktx")?_t(r):Rt(r)})(e);const r=function(e){if("file:"===self.location.protocol&&!Z.test(e)){const t=self.location.pathname.split("/");t.pop();const r=t.join("/"),s=self.location.protocol+"//"+r;return"."===e.charAt(0)&&(e=e.slice(1)),"/"===e.charAt(0)&&(e=e.slice(1)),s+"/"+e}return new URL(e,self.location.href).href}(e);if(this.txManager.imageWorkerManager)return await this.txManager.imageWorkerManager.getImage(r,t);if(this.txManager.hasCreateImageBitmap){const e=await fetch(r),s=await e.blob(),n=t??this.hasAlphaChannel(s.type);return{data:await createImageBitmap(s,{premultiplyAlpha:n?"premultiply":"none",colorSpaceConversion:"none",imageOrientation:"none"}),premultiplyAlpha:n}}{const s=new Image;return"data:"!==e.substr(0,5)&&(s.crossOrigin="Anonymous"),s.src=r,await new Promise(((e,t)=>{s.onload=()=>e(),s.onerror=()=>t(new Error("Failed to load image"))})).catch((e=>{console.error(e)})),{data:s,premultiplyAlpha:t??!0}}}static makeCacheKey(e){const t=Et.resolveDefaults(e),r=t.key||t.src;return"string"==typeof r&&`ImageTexture,${r},${t.premultiplyAlpha??"true"}`}static resolveDefaults(e){return{src:e.src??"",premultiplyAlpha:e.premultiplyAlpha??!0,key:e.key??null}}static z$__type__Props}class Ct extends Ce{glw;system;quadBuffer=new ArrayBuffer(4194304);fQuadBuffer=new Float32Array(this.quadBuffer);uiQuadBuffer=new Uint32Array(this.quadBuffer);renderOps=[];curBufferIdx=0;curRenderOp=null;rttNodes=[];activeRttNode=null;defShaderCtrl;defaultShader;quadBufferCollection;defaultTexture;renderToTextureActive=!1;constructor(e){super(e),this.mode="webgl";const{canvas:t,clearColor:r,bufferMemory:s}=e;this.defaultTexture=new $e(this.txManager),this.defaultTexture.setRenderableOwner(this,!0),this.defaultTexture.once("loaded",(()=>{this.stage.requestRender()}));const n=function(e,t){const r={alpha:!0,antialias:!1,depth:!1,stencil:!0,desynchronized:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!1},s=e.getContext("webgl",r)||e.getContext("experimental-webgl",r);if(!s)throw new Error("Unable to create WebGL context");return t?new Proxy(s,{get(e,r){const s=e[r];return"function"==typeof s?(t.increment(String(r)),s.bind(e)):s}}):s}(t,e.contextSpy),i=this.glw=new bt(n),o=Q(r);i.viewport(0,0,t.width,t.height),i.clearColor(o[0],o[1],o[2],o[3]),i.setBlend(!0),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),function(e,t){const r=~~(t/80),s=new Uint16Array(6*r);for(let e=0,t=0;e<r;e+=6,t+=4)s[e]=t,s[e+1]=t+1,s[e+2]=t+2,s[e+3]=t+2,s[e+4]=t+1,s[e+5]=t+3;const n=e.createBuffer();e.elementArrayBufferData(n,s,e.STATIC_DRAW)}(i,s),this.system={parameters:Pe(this.glw),extensions:ke(this.glw)},this.shManager.renderer=this,this.defShaderCtrl=this.shManager.loadShader("DefaultShader"),this.defaultShader=this.defShaderCtrl.shader;const a=i.createBuffer();G(a);const l=6*Float32Array.BYTES_PER_ELEMENT;this.quadBufferCollection=new Tt([{buffer:a,attributes:{a_position:{name:"a_position",size:2,type:i.FLOAT,normalized:!1,stride:l,offset:0},a_textureCoordinate:{name:"a_textureCoordinate",size:2,type:i.FLOAT,normalized:!1,stride:l,offset:2*Float32Array.BYTES_PER_ELEMENT},a_color:{name:"a_color",size:4,type:i.UNSIGNED_BYTE,normalized:!0,stride:l,offset:4*Float32Array.BYTES_PER_ELEMENT},a_textureIndex:{name:"a_textureIndex",size:1,type:i.FLOAT,normalized:!1,stride:l,offset:5*Float32Array.BYTES_PER_ELEMENT}}}])}reset(){const{glw:e}=this;this.curBufferIdx=0,this.curRenderOp=null,this.renderOps.length=0,e.setScissorTest(!1),e.clear()}getShaderManager(){return this.shManager}createCtxTexture(e){return e instanceof De?new Ne(this.glw,this.txMemManager,e):e instanceof wt?new St(this.glw,this.txMemManager,e):new Ue(this.glw,this.txMemManager,e)}addQuad(e){const{fQuadBuffer:t,uiQuadBuffer:r}=this,{width:s,height:n,colorTl:i,colorTr:o,colorBl:a,colorBr:l,textureOptions:h,shader:c,shaderProps:d,alpha:u,clippingRect:p,tx:f,ty:m,ta:g,tb:x,tc:y,td:v,renderCoords:T,rtt:b,parentHasRenderTexture:w,framebufferDimensions:S}=e;let{texture:_}=e;if(d&&H(d,"$dimensions")){const e=d.$dimensions;e.width=s,e.height=n}_=_??this.defaultTexture,G(_ instanceof Oe,"Invalid texture type");let{curBufferIdx:R,curRenderOp:E}=this;const C={width:s,height:n},A=c||this.defaultShader;G(A instanceof Fe),this.reuseRenderOp(e)||(this.newRenderOp(A,d,u,C,p,R,b,w,S),E=this.curRenderOp,G(E));const M=h?.flipX??!1;let I=h?.flipY??!1;_ instanceof wt&&(I=!I);let F=0,L=0,P=1,k=1;if(_ instanceof De){const{x:e,y:t,width:r,height:s}=_.props,{width:n=0,height:i=0}=_.parentTexture.dimensions||{width:0,height:0};F=e/n,P=F+r/n,L=t/i,k=L+s/i,_=_.parentTexture}const B=h?.resizeMode??!1;if(_ instanceof Et&&B&&_.dimensions){const{width:e,height:t}=_.dimensions;if("cover"===B.type){const r=s/e,i=n/t,o=Math.max(r,i),a=1/o;if(o&&r&&r<o){const t=a*s;F=(1-t/e)*(B.clipX??.5),P=F+t/e}if(o&&i&&i<o){const e=a*n;L=(1-e/t)*(B.clipY??.5),k=L+e/t}}}M&&([F,P]=[P,F]),I&&([L,k]=[k,L]);const U=_.ctxTexture;G(U instanceof Ue);const O=this.addTexture(U,R);if(E=this.curRenderOp,G(E),T){const{x1:e,y1:s,x2:n,y2:h,x3:c,y3:d,x4:u,y4:p}=T;t[R++]=e,t[R++]=s,t[R++]=F,t[R++]=L,r[R++]=i,t[R++]=O,t[R++]=n,t[R++]=h,t[R++]=P,t[R++]=L,r[R++]=o,t[R++]=O,t[R++]=u,t[R++]=p,t[R++]=F,t[R++]=k,r[R++]=a,t[R++]=O,t[R++]=c,t[R++]=d,t[R++]=P,t[R++]=k,r[R++]=l,t[R++]=O}else if(0!==x||0!==y)t[R++]=f,t[R++]=m,t[R++]=F,t[R++]=L,r[R++]=i,t[R++]=O,t[R++]=f+s*g,t[R++]=m+s*y,t[R++]=P,t[R++]=L,r[R++]=o,t[R++]=O,t[R++]=f+n*x,t[R++]=m+n*v,t[R++]=F,t[R++]=k,r[R++]=a,t[R++]=O,t[R++]=f+s*g+n*x,t[R++]=m+s*y+n*v,t[R++]=P,t[R++]=k,r[R++]=l,t[R++]=O;else{const e=f+s*g,h=m+n*v;t[R++]=f,t[R++]=m,t[R++]=F,t[R++]=L,r[R++]=i,t[R++]=O,t[R++]=e,t[R++]=m,t[R++]=P,t[R++]=L,r[R++]=o,t[R++]=O,t[R++]=f,t[R++]=h,t[R++]=F,t[R++]=k,r[R++]=a,t[R++]=O,t[R++]=e,t[R++]=h,t[R++]=P,t[R++]=k,r[R++]=l,t[R++]=O}E.length+=24,E.numQuads++,this.curBufferIdx=R}newRenderOp(e,t,r,s,n,i,o,a,l){const h=new Le(this.glw,this.options,this.quadBufferCollection,e,t,r,n,s,i,0,o,a,l);this.curRenderOp=h,this.renderOps.push(h)}addTexture(e,t,r){const{curRenderOp:s}=this;G(s);const n=s.addTexture(e);if(4294967295===n){if(r)throw new Error("Unable to add texture to render op");const{shader:n,shaderProps:i,dimensions:o,clippingRect:a,alpha:l}=s;return this.newRenderOp(n,i,l,o,a,t),this.addTexture(e,t,!0)}return n}reuseRenderOp(e){const{shader:t,shaderProps:r,parentHasRenderTexture:s,rtt:n,clippingRect:i}=e,o=t||this.defaultShader;return this.curRenderOp?.shader===o&&(((a=this.curRenderOp.clippingRect)===(l=i)||null!==a&&null!==l&&a.x===l.x&&a.y===l.y&&a.width===l.width&&a.height===l.height)&&(!s&&!n&&!!(this.curRenderOp.shader===this.defaultShader||r&&this.curRenderOp.shader.canBatchShaderProps(this.curRenderOp.shaderProps,r))));var a,l}addRenderOp(e){this.renderOps.push(e),this.curRenderOp=null}render(e="screen"){const{glw:t,quadBuffer:r}=this,s=new Float32Array(r,0,this.curBufferIdx),n=this.quadBufferCollection.getBuffer("a_position")??null;t.arrayBufferData(n,s,t.STATIC_DRAW),this.renderOps.forEach(((e,t)=>{e.draw()}))}renderToTexture(e){for(let t=0;t<this.rttNodes.length;t++)if(this.rttNodes[t]===e)return;this.rttNodes.unshift(e)}renderRTTNodes(){const{glw:e}=this;this.stage;for(let t=0;t<this.rttNodes.length;t++){const r=this.rttNodes[t];if(!r||!r.hasRTTupdates)continue;this.activeRttNode=r,G(r.texture,"RTT node missing texture");const s=r.texture.ctxTexture;G(s instanceof St),this.renderToTextureActive=!0,e.bindFramebuffer(s.framebuffer),e.viewport(0,0,s.w,s.h),e.clear();for(let e=0;e<r.children.length;e++){const t=r.children[e];t&&(t.update(this.stage.deltaTime,{x:0,y:0,width:0,height:0,valid:!1}),this.stage.addQuads(t),t.hasRTTupdates=!1)}this.render(),this.renderOps.length=0,r.hasRTTupdates=!1}e.bindFramebuffer(null),e.viewport(0,0,this.glw.canvas.width,this.glw.canvas.height),this.renderToTextureActive=!1}removeRTTNode(e){const t=this.rttNodes.indexOf(e);-1!==t&&this.rttNodes.splice(t,1)}getDefShaderCtr(){return this.defShaderCtrl}}class At{activeAnimations=new Set;registerAnimation(e){this.activeAnimations.add(e)}unregisterAnimation(e){this.activeAnimations.delete(e)}update(e){this.activeAnimations.forEach((t=>{t.update(e)}))}}const Mt=function(){self.onmessage=e=>{var t=e.data.src,r=e.data.id,s=e.data.premultiplyAlpha;(function(e,t){return new Promise((function(r,s){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="blob",n.onload=function(){if(200!==n.status)return s(new Error("Failed to load image: "+n.statusText));var e=n.response,i=void 0!==t?t:-1!==e.type.indexOf("image/png");createImageBitmap(e,{premultiplyAlpha:i?"premultiply":"none",colorSpaceConversion:"none",imageOrientation:"none"}).then((function(e){r({data:e,premultiplyAlpha:t})})).catch((function(e){s(e)}))},n.onerror=function(){s(new Error("Network error occurred while trying to fetch the image."))},n.send()}))})(t,s).then((function(e){self.postMessage({id:r,src:t,data:e})})).catch((function(e){self.postMessage({id:r,src:t,error:e.message})}))}};class It{imageWorkersEnabled=!0;messageManager={};workers=[];workerIndex=0;nextId=0;constructor(e){this.workers=this.createWorkers(e),this.workers.forEach((e=>{e.onmessage=this.handleMessage.bind(this)}))}handleMessage(e){const{id:t,data:r,error:s}=e.data,n=this.messageManager[t];if(n){const[e,i]=n;delete this.messageManager[t],s?i(new Error(s)):e(r)}}createWorkers(e=1){const t=`${Mt.toString()} worker()`,r=new Blob([t.replace('"use strict";',"")],{type:"application/javascript"}),s=(self.URL?URL:webkitURL).createObjectURL(r),n=[];for(let t=0;t<e;t++)n.push(new Worker(s));return n}getNextWorker(){const e=this.workers[this.workerIndex];return this.workerIndex=(this.workerIndex+1)%this.workers.length,e}getImage(e,t){return new Promise(((r,s)=>{try{if(this.workers){const n=this.nextId++;this.messageManager[n]=[r,s];const i=this.getNextWorker();i&&i.postMessage({id:n,src:e,premultiplyAlpha:t})}}catch(e){s(e)}}))}}class Ft extends Oe{props;constructor(e,t){super(e),this.props=Ft.resolveDefaults(t)}async getTextureData(){const{width:e,height:t}=this.props,r=e*t*4,s=new Uint8ClampedArray(r);for(let e=0;e<r;e+=4){const t=Math.floor(256*Math.random());s[e]=t,s[e+1]=t,s[e+2]=t,s[e+3]=255}return{data:new ImageData(s,e,t)}}static makeCacheKey(e){if(void 0===e.cacheId)return!1;const t=Ft.resolveDefaults(e);return`NoiseTexture,${t.width},${t.height},${t.cacheId}`}static resolveDefaults(e){return{width:e.width??128,height:e.height??128,cacheId:e.cacheId??0}}static z$__type__Props}class Lt{keyCache=new Map;inverseKeyCache=new WeakMap;txConstructors={};imageWorkerManager=null;hasCreateImageBitmap=!!self.createImageBitmap;hasWorker=!!self.Worker;renderer;frameTime=0;constructor(e){this.hasCreateImageBitmap&&this.hasWorker&&e>0&&(this.imageWorkerManager=new It(e)),this.hasCreateImageBitmap||console.warn("[Lightning] createImageBitmap is not supported on this browser. ImageTexture will be slower."),this.registerTextureType("ImageTexture",Et),this.registerTextureType("ColorTexture",$e),this.registerTextureType("NoiseTexture",Ft),this.registerTextureType("SubTexture",De),this.registerTextureType("RenderTexture",wt)}registerTextureType(e,t){this.txConstructors[e]=t}loadTexture(e,t){let r;const s=this.txConstructors[e];if(!s)throw new Error(`Texture type "${e}" is not registered`);if(!r){const e=s.makeCacheKey(t);e&&this.keyCache.has(e)?r=this.keyCache.get(e):(r=new s(this,t),e&&this.initTextureToCache(r,e))}return r}initTextureToCache(e,t){const{keyCache:r,inverseKeyCache:s}=this;r.set(t,e),s.set(e,t)}removeTextureFromCache(e){const{inverseKeyCache:t,keyCache:r}=this,s=t.get(e);s&&r.delete(s)}}const Pt={normal:400,bold:700,bolder:900,lighter:100},kt=e=>"number"==typeof e?e:Pt[e]||400;const Bt=function(e,t){var r,s,n=0;function i(){var i,o,a=r,l=arguments.length;e:for(;a;){if(a.args.length===arguments.length){for(o=0;o<l;o++)if(a.args[o]!==arguments[o]){a=a.next;continue e}return a!==r&&(a===s&&(s=a.prev),a.prev.next=a.next,a.next&&(a.next.prev=a.prev),a.next=r,a.prev=null,r.prev=a,r=a),a.val}a=a.next}for(i=new Array(l),o=0;o<l;o++)i[o]=arguments[o];return a={args:i,val:e.apply(null,i)},r?(r.prev=a,a.next=r):s=a,n===t.maxSize?(s=s.prev).next=null:n++,r=a,a.val}return t=t||{},i.clear=function(){r=null,s=null,n=0},i}((function(e,t,r,s,n){let i=kt(r);for(const r of e){const e=r[t];if(!e)continue;if(1===e.size)return console.warn(`TrFontManager: Only one font face found for family: '${t}' - will be used for all weights and styles`),e.values().next().value;const o=new Map;for(const t of e){const e=kt(t.descriptors.weight);if(e===i&&t.descriptors.style===s&&t.descriptors.stretch===n)return t;o.set(e,t)}const a=`TrFontManager: No exact match: '${t} Weight: ${i} Style: ${s} Stretch: ${n}'`;if(console.error(a),400===i&&o.has(500))return o.get(500);if(500===i&&o.has(400))return o.get(400);if(i<400){for(;i>0;){if(o.has(i))return o.get(i);i-=100}i=600}for(;i<1e3;){if(o.has(i))return o.get(i);i+=100}for(i=500;i>0;){if(o.has(i))return o.get(i);i-=100}}}));class Ut{textRenderers;constructor(e){this.textRenderers=e}addFontFace(e){for(const t in this.textRenderers){const r=this.textRenderers[t];r&&r.isFontFaceSupported(e)&&r.addFontFace(e)}}static resolveFontFace(e,t){const{fontFamily:r,fontWeight:s,fontStyle:n,fontStretch:i}=t;return Bt(e,r,s,n,i)}}const Ot={x:(e,t)=>{e.props.x=t},y:(e,t)=>{e.props.y=t},width:(e,t)=>{e.props.width=t},height:(e,t)=>{e.props.height=t},color:(e,t)=>{e.props.color=t},zIndex:(e,t)=>{e.props.zIndex=t},fontFamily:(e,t)=>{e.props.fontFamily=t},fontWeight:(e,t)=>{e.props.fontWeight=t},fontStyle:(e,t)=>{e.props.fontStyle=t},fontStretch:(e,t)=>{e.props.fontStretch=t},fontSize:(e,t)=>{e.props.fontSize=t},text:(e,t)=>{e.props.text=t},textAlign:(e,t)=>{e.props.textAlign=t},contain:(e,t)=>{e.props.contain=t},offsetY:(e,t)=>{e.props.offsetY=t},scrollable:(e,t)=>{e.props.scrollable=t},scrollY:(e,t)=>{e.props.scrollY=t},letterSpacing:(e,t)=>{e.props.letterSpacing=t},lineHeight:(e,t)=>{e.props.lineHeight=t},maxLines:(e,t)=>{e.props.maxLines=t},textBaseline:(e,t)=>{e.props.textBaseline=t},verticalAlign:(e,t)=>{e.props.verticalAlign=t},overflowSuffix:(e,t)=>{e.props.overflowSuffix=t},debug:(e,t)=>{e.props.debug=t}};class $t{stage;set;constructor(e){this.stage=e;const t={...Ot,...this.getPropertySetters()};this.set=Object.freeze(Object.fromEntries(Object.entries(t).map((([e,t])=>[e,(r,s)=>{r.props[e]!==s&&(t(r,s),this.stage.requestRender())}]))))}setStatus(e,t,r){e.status!==t&&(e.status=t,e.emitter.emit(t,r))}setIsRenderable(e,t){e.isRenderable=t}destroyState(e){this.setStatus(e,"destroyed"),e.emitter.removeAllListeners()}scheduleUpdateState(e){e.updateScheduled||(e.updateScheduled=!0,queueMicrotask((()=>{"destroyed"!==e.status&&(e.updateScheduled=!1,this.updateState(e))})))}}class Dt extends q{fontFamily;descriptors;loaded=!1;metrics=null;constructor(e){super();const{fontFamily:t,descriptors:r,metrics:s}=e;s&&(this.metrics={ascender:s.ascender/s.unitsPerEm,descender:s.descender/s.unitsPerEm,lineGap:s.lineGap/s.unitsPerEm}),this.fontFamily=t,this.descriptors={style:"normal",weight:"normal",stretch:"normal",...r}}static convertToCssFontFaceDescriptors(e){return{style:e.style,weight:"number"==typeof e.weight?`${e.weight}`:e.weight,stretch:e.stretch,unicodeRange:e.unicodeRange,featureSettings:e.featureSettings,display:e.display}}}const Nt=10;class zt{}class Gt extends zt{data;glyphMap;kernings;constructor(e,t){super(),this.data=e,this.glyphMap=t;const r=this.kernings={};e.kernings.forEach((e=>{const t=e.second;(r[t]=r[t]||{})[e.first]=e.amount})),this.kernings=r}*shapeText(e,t){let r,s;for(;(r=t.peek())&&!r.done;){const n=r.value,i=this.glyphMap.get(n);if(t.next(),void 0!==i){const r=void 0!==s?(this.kernings[i.id]?.[s]||0)+e.letterSpacing:0;s=i.id,yield{mapped:!0,glyphId:i.id,codepoint:n,cluster:t.lastIndex,xAdvance:i.xadvance+r,yAdvance:0,xOffset:i.xoffset+r,yOffset:i.yoffset,xBearing:0,yBearing:0,width:i.width,height:i.height}}else n===Nt&&(s=void 0),yield{mapped:!1,codepoint:n,cluster:t.lastIndex}}}}class Xt extends Dt{type;texture;maxCharHeight=0;data;shaper;glyphMap=new Map;constructor(e,t){super(t);const{atlasUrl:r,atlasDataUrl:s,stage:n}=t;this.type=e;G(n.renderer instanceof Ct,"SDF Font Faces can only be used with the WebGL Renderer"),this.texture=n.txManager.loadTexture("ImageTexture",{src:r,premultiplyAlpha:!1}),this.texture.on("loaded",(()=>{this.checkLoaded(),n.requestRender()})),this.texture.ctxTexture.load(),fetch(s).then((async e=>{this.data=await e.json(),G(this.data);let t=0;if(this.data.chars.forEach((e=>{this.glyphMap.set(e.id,e);const r=e.yoffset+e.height;r>t&&(t=r)})),this.maxCharHeight=t,this.shaper=new Gt(this.data,this.glyphMap),!this.metrics){if(!this.data?.lightningMetrics)throw new Error(`Font metrics not found in ${this.type} font ${this.fontFamily}. Make sure you are using the latest version of the Lightning 3 \`msdf-generator\` tool to generate your SDF fonts.`);{const{ascender:e,descender:t,lineGap:r,unitsPerEm:s}=this.data.lightningMetrics;this.metrics={ascender:e/s,descender:t/s,lineGap:r/s}}}this.checkLoaded()})).catch(console.error)}getAtlasEntry(e){const t=this.glyphMap.get(e);if(void 0===t)throw new Error(`Glyph ${e} not found in font ${this.fontFamily}`);return{x:t.x,y:t.y,width:t.width,height:t.height}}checkLoaded(){this.loaded||"loaded"===this.texture.state&&this.data&&(this.loaded=!0,this.emit("loaded"))}}class Vt{iterator;peekBuffer=[];_lastIndex;constructor(e,t=0){this.iterator=e,this.iterator=e,this._lastIndex=t-1,this.peekBuffer=[]}next(){const e=this.peekBuffer.length>0?this.peekBuffer.pop():this.iterator.next();return e.done?this._lastIndex=-1:this._lastIndex++,e}peek(){if(this.peekBuffer.length>0)return this.peekBuffer[0];const e=this.iterator.next();return this.peekBuffer.push(e),e}get lastIndex(){return this._lastIndex}}function*Wt(e,t=0){let r=t;for(;r<e.length;){const t=e.codePointAt(r);if(void 0===t)throw new Error("Invalid Unicode code point");yield t,r+=t<=65535?1:2}}function Yt(e,t,r,s,n,i,o,a,l,h,c,d,u,p,f,m,g,x,y){G(f,"Font face must be loaded"),G(f.loaded,"Font face must be loaded"),G(f.data,"Font face must be loaded"),G(f.shaper,"Font face must be loaded");const v=a/f.data.info.size,T=l/v,b=i/v,w=h/v,S=u[e],_=S?.codepointIndex||0;let R=S?.maxX||0,E=S?.maxY||0,C=t,A=r,M=0;const I={codepointIndex:-1,bufferOffset:-1,xStart:-1},F=f.shaper,L={letterSpacing:w};let P,k=F.shapeText(L,new Vt(Wt(s,_),_)),B=-1;const U=[],O=o/v,$=function(e,t,r){const s=r.shapeText(t,new Vt(Wt(e,0),0));let n=0;for(const e of s)e.mapped&&(n+=e.xAdvance);return n}(x,L,F);let D=!0;for(;D;){const t=(0===y||e+1<y)&&("both"!==d||g||A+T+f.maxCharHeight<=O),r=t?b:b-$;let n=0;const i=A+f.maxCharHeight>=p.y1,o=A<=p.y2,a=i&&o;for(;(P=k.next())&&!P.done;){const i=P.value;if(e===u.length)u.push({codepointIndex:i.cluster,maxY:E,maxX:R});else if(e>u.length)throw new Error("Unexpected lineCache length");if(32===i.codepoint||10===i.codepoint?-1!==I.codepointIndex&&(I.codepointIndex=-1,n=C):-1===I.codepointIndex&&(I.codepointIndex=i.cluster,I.bufferOffset=M,I.xStart=n),i.mapped){const e=C+i.xOffset+i.width;if("none"!==d&&e>=r&&-1!==I.codepointIndex&&I.xStart>0){if(t){k=F.shapeText(L,new Vt(Wt(s,I.codepointIndex),I.codepointIndex)),M=I.bufferOffset;break}k=F.shapeText(L,new Vt(Wt(x,0),0)),C=I.xStart,M=I.bufferOffset,d="none"}else{const e=C+i.xOffset,t=A+i.yOffset;if(a){-1===B&&(B=M);const r=f.getAtlasEntry(i.glyphId),s=r.x/f.data.common.scaleW,n=r.y/f.data.common.scaleH,o=r.width/f.data.common.scaleW,a=r.height/f.data.common.scaleH;c[M++]=e,c[M++]=t,c[M++]=s,c[M++]=n,c[M++]=e+i.width,c[M++]=t,c[M++]=s+o,c[M++]=n,c[M++]=e,c[M++]=t+i.height,c[M++]=s,c[M++]=n+a,c[M++]=e+i.width,c[M++]=t+i.height,c[M++]=s+o,c[M++]=n+a}E=Math.max(E,t+i.height),R=Math.max(R,e+i.width),C+=i.xAdvance}}else if(10===i.codepoint){if(t)break;k=F.shapeText(L,new Vt(Wt(x,0),0)),d="none"}}-1!==B&&(U.push({bufferStart:B,bufferEnd:M}),B=-1),C=0,A+=T,e++,I.codepointIndex=-1,n=0,!m&&"both"===d&&A>p.y2||P&&P.done?D=!1:t||(D=!1)}if("center"===n){const e="none"===d?R:b;for(let t=0;t<U.length;t++){const r=U[t],s=(e-(c[r.bufferEnd-4]-c[r.bufferStart]))/2;for(let e=r.bufferStart;e<r.bufferEnd;e+=4)c[e]+=s}}else if("right"===n){const e="none"===d?R:b;for(let t=0;t<U.length;t++){const r=U[t],s=e-(r.bufferEnd===r.bufferStart?0:c[r.bufferEnd-4]-c[r.bufferStart]);for(let e=r.bufferStart;e<r.bufferEnd;e+=4)c[e]+=s}}return G(P),{bufferNumFloats:M,bufferNumQuads:M/16,layoutNumCharacters:P.done?s.length-_:P.value.cluster-_+1,fullyProcessed:!!P.done,maxX:R,maxY:E,numLines:u.length}}function Ht(e,t,r,s,n,i,o,a){const{screen:l,sdf:h}=e;if((u=o).x1<u.x2&&u.y1<u.y2){const u=o.x1-t,p=u+(o.x2-o.x1),f=o.y1-r+s,m=(c=f-i,d=n||1,Math.floor(c/d)*d),g=function(e,t){return Math.ceil(e/t)*t}(f+(o.y2-o.y1)+i,n||1);l.x1=u,l.y1=m,l.x2=p,l.y2=g,h.x1=u/a,h.y1=m/a,h.x2=p/a,h.y2=g/a,e.numLines=Math.ceil((g-m)/n),e.firstLineIdx=n?Math.floor(m/n):0}else l.x1=0,l.y1=0,l.x2=0,l.y2=0,h.x1=0,h.y1=0,h.x2=0,h.y2=0,e.numLines=0,e.firstLineIdx=0;var c,d,u;e.valid=!0}function jt(e,t){return t*(e.ascender-e.descender+e.lineGap)}const Kt={x:0,y:0,width:0,height:0};class qt extends $t{ssdfFontFamilies={};msdfFontFamilies={};fontFamilyArray=[this.ssdfFontFamilies,this.msdfFontFamilies];sdfShader;rendererBounds;constructor(e){super(e),this.sdfShader=this.stage.shManager.loadShader("SdfShader").shader,this.rendererBounds={x1:0,y1:0,x2:this.stage.options.appWidth,y2:this.stage.options.appHeight}}getPropertySetters(){return{fontFamily:(e,t)=>{e.props.fontFamily=t,this.releaseFontFace(e),this.invalidateLayoutCache(e)},fontWeight:(e,t)=>{e.props.fontWeight=t,this.releaseFontFace(e),this.invalidateLayoutCache(e)},fontStyle:(e,t)=>{e.props.fontStyle=t,this.releaseFontFace(e),this.invalidateLayoutCache(e)},fontStretch:(e,t)=>{e.props.fontStretch=t,this.releaseFontFace(e),this.invalidateLayoutCache(e)},fontSize:(e,t)=>{e.props.fontSize=t,this.invalidateLayoutCache(e)},text:(e,t)=>{e.props.text=t,this.invalidateLayoutCache(e)},textAlign:(e,t)=>{e.props.textAlign=t,this.invalidateLayoutCache(e)},color:(e,t)=>{e.props.color=t},x:(e,t)=>{e.props.x=t,e.elementBounds.valid&&(this.setElementBoundsX(e),!e.renderWindow.valid&&re(e.elementBounds,this.rendererBounds)&&this.scheduleUpdateState(e))},y:(e,t)=>{e.props.y=t,e.elementBounds.valid&&(this.setElementBoundsY(e),!e.renderWindow.valid&&re(e.elementBounds,this.rendererBounds)&&this.scheduleUpdateState(e))},contain:(e,t)=>{e.props.contain=t,this.invalidateLayoutCache(e)},width:(e,t)=>{e.props.width=t,"none"!==e.props.contain&&this.invalidateLayoutCache(e)},height:(e,t)=>{e.props.height=t,"both"===e.props.contain&&this.invalidateLayoutCache(e)},offsetY:(e,t)=>{e.props.offsetY=t,this.invalidateLayoutCache(e)},scrollable:(e,t)=>{e.props.scrollable=t,this.invalidateLayoutCache(e)},scrollY:(e,t)=>{e.props.scrollY=t,this.scheduleUpdateState(e)},letterSpacing:(e,t)=>{e.props.letterSpacing=t,this.invalidateLayoutCache(e)},lineHeight:(e,t)=>{e.props.lineHeight=t,e.resLineHeight=void 0,this.invalidateLayoutCache(e)},maxLines:(e,t)=>{e.props.maxLines=t,this.invalidateLayoutCache(e)},textBaseline:(e,t)=>{e.props.textBaseline=t,this.invalidateLayoutCache(e)},verticalAlign:(e,t)=>{e.props.verticalAlign=t,this.invalidateLayoutCache(e)},overflowSuffix:(e,t)=>{e.props.overflowSuffix=t,this.invalidateLayoutCache(e)},debug:(e,t)=>{e.props.debug=t}}}canRenderFont(e){const{fontFamily:t}=e;return t in this.ssdfFontFamilies||t in this.msdfFontFamilies||"$$SDF_FAILURE_TEST$$"===t}isFontFaceSupported(e){return e instanceof Xt}addFontFace(e){G(e instanceof Xt);const t=e.fontFamily,r="ssdf"===e.type?this.ssdfFontFamilies:"msdf"===e.type?this.msdfFontFamilies:void 0;if(!r)return void console.warn(`Invalid font face type: ${e.type}`);let s=r[t];s||(s=new Set,r[t]=s),s.add(e)}createState(e){return{props:e,status:"initialState",updateScheduled:!1,emitter:new q,lineCache:[],forceFullLayoutCalc:!1,renderWindow:{screen:{x1:0,y1:0,x2:0,y2:0},sdf:{x1:0,y1:0,x2:0,y2:0},firstLineIdx:0,numLines:0,valid:!1},elementBounds:{x1:0,y1:0,x2:0,y2:0,valid:!1},clippingRect:{x:0,y:0,width:0,height:0,valid:!1},bufferNumFloats:0,bufferNumQuads:0,vertexBuffer:void 0,webGlBuffers:null,bufferUploaded:!1,textH:void 0,textW:void 0,distanceRange:0,trFontFace:void 0,isRenderable:!1,resLineHeight:void 0,debugData:{updateCount:0,layoutCount:0,lastLayoutNumCharacters:0,layoutSum:0,drawSum:0,drawCount:0,bufferSize:0}}}updateState(e){let{trFontFace:t}=e;const{textH:r,lineCache:s,debugData:n,forceFullLayoutCalc:i}=e;if(n.updateCount++,"initialState"===e.status&&this.setStatus(e,"loading"),!t){if(t=this.resolveFontFace(e.props),e.trFontFace=t,!t){const t=`SdfTextRenderer: Could not resolve font face for family: '${e.props.fontFamily}'`;return console.error(t),void this.setStatus(e,"failed",new Error(t))}t.texture.setRenderableOwner(e,!0)}if(!t.loaded)return void t.once("loaded",(()=>{this.scheduleUpdateState(e)}));G(t.data,"Font face data should be loaded"),G(t.metrics,"Font face metrics should be loaded");const{text:o,fontSize:a,x:l,y:h,contain:c,width:d,height:u,verticalAlign:p,scrollable:f,overflowSuffix:m,maxLines:g}=e.props,x="both"===c&&f?e.props.scrollY:0,{renderWindow:y}=e,v=t.data.info.size,T=a/v;let b=e.resLineHeight;if(void 0===b){const r=e.props.lineHeight;b=void 0===r?jt(t.metrics,a):r,e.resLineHeight=b}const w=b/T;e.distanceRange=T*t.data.distanceField.distanceRange;const S=24*o.length;let _=e.vertexBuffer;(!_||_.length<S)&&(_=new Float32Array(2*S));const R=e.elementBounds;if(R.valid||(this.setElementBoundsX(e),this.setElementBoundsY(e),R.valid=!0),!i&&y.valid){const t=y.screen;if(l+t.x1<=R.x1&&l+t.x2>=R.x2&&h-x+t.y1<=R.y1&&h-x+t.y2>=R.y2)return void this.setStatus(e,"loaded");y.valid=!1,this.setStatus(e,"loading")}const{offsetY:E,textAlign:C}=e.props;if(!y.valid){if(!re(R,this.rendererBounds))return;Ht(y,l,h,x,b,"both"===c?R.y2-R.y1:0,R,T)}const A=function(e,t,r,s,n,i,o,a,l){const h=Math.min(Math.max(o.firstLineIdx,0),a.length),{metrics:c}=r;G(c,"Font metrics not loaded"),G(r.data,"Font data not loaded");const d=(c.ascender-c.descender)*e;let u=0;"middle"===s?u=(t-d)/2:"bottom"===s&&(u=t-d);const p=n/i,f=r.data.common.base,m=p+(c.ascender*e-f)+h*t+u;if(!(l&&m>=l/i))return{sdfX:0,sdfY:m,lineIndex:h}}(v,w,t,p,E,T,y,s,r);if(!A)return void this.setStatus(e,"loaded");const{letterSpacing:M}=e.props,I=Yt(A.lineIndex,A.sdfX,A.sdfY,o,C,d,u,a,b,M,_,c,s,y.sdf,t,i,f,m,g);e.bufferUploaded=!1,e.bufferNumFloats=I.bufferNumFloats,e.bufferNumQuads=I.bufferNumQuads,e.vertexBuffer=_,e.renderWindow=y,n.lastLayoutNumCharacters=I.layoutNumCharacters,n.bufferSize=_.byteLength,I.fullyProcessed&&(e.textW=I.maxX*T,e.textH=I.numLines*w*T),this.setStatus(e,"loaded")}renderQuads(e,t,r,s,n,i){if(!e.vertexBuffer)return;const o=this.stage.renderer;G(o instanceof Ct);const{fontSize:a,color:l,contain:h,scrollable:c,zIndex:d,debug:u}=e.props,p="both"===h&&c?e.props.scrollY:0,{textW:f=0,textH:m=0,distanceRange:g,vertexBuffer:x,bufferUploaded:y,trFontFace:v,elementBounds:T}=e;let{webGlBuffers:b}=e;if(!b){const t=o.glw,r=4*Float32Array.BYTES_PER_ELEMENT,s=t.createBuffer();G(s),e.webGlBuffers=new Tt([{buffer:s,attributes:{a_position:{name:"a_position",size:2,type:t.FLOAT,normalized:!1,stride:r,offset:0},a_textureCoordinate:{name:"a_textureCoordinate",size:2,type:t.FLOAT,normalized:!1,stride:r,offset:2*Float32Array.BYTES_PER_ELEMENT}}}]),e.bufferUploaded=!1,G(e.webGlBuffers),b=e.webGlBuffers}if(!y){const t=o.glw,r=b?.getBuffer("a_textureCoordinate")??null;t.arrayBufferData(r,x,t.STATIC_DRAW),e.bufferUploaded=!0}if(G(v),c&&"both"===h){G(T.valid);const t=(w=T,(S=Kt)?(S.x=w.x1,S.y=w.y1,S.width=w.x2-w.x1,S.height=w.y2-w.y1,S):{x:w.x1,y:w.y1,width:w.x2-w.x1,height:w.y2-w.y1});r.valid?(e.clippingRect.valid=!0,r=se(r,t,e.clippingRect)):(e.clippingRect.valid=!0,r=ne(t,e.clippingRect))}var w,S;const _=new Le(o.glw,o.options,b,this.sdfShader,{transform:t.getFloatArr(),color:V(l,s),size:a/(v.data?.info.size||0),scrollY:p,distanceRange:g,debug:u.sdfShaderDebug},s,r,{height:m,width:f},0,d,!1,n,i),R=e.trFontFace?.texture;G(R);const E=R.ctxTexture;_.addTexture(E),_.length=e.bufferNumFloats,_.numQuads=e.bufferNumQuads,o.addRenderOp(_)}setIsRenderable(e,t){super.setIsRenderable(e,t),e.trFontFace?.texture.setRenderableOwner(e,t)}destroyState(e){super.destroyState(e),e.trFontFace?.texture.setRenderableOwner(e,!1)}resolveFontFace(e){return Ut.resolveFontFace(this.fontFamilyArray,e)}releaseFontFace(e){e.resLineHeight=void 0,e.trFontFace&&(e.trFontFace.texture.setRenderableOwner(e,!1),e.trFontFace=void 0)}invalidateLayoutCache(e){e.renderWindow.valid=!1,e.elementBounds.valid=!1,e.textH=void 0,e.textW=void 0,e.lineCache=[],this.setStatus(e,"loading"),this.scheduleUpdateState(e)}setElementBoundsX(e){const{x:t,contain:r,width:s}=e.props,{elementBounds:n}=e;n.x1=t,n.x2="none"!==r?t+s:1/0}setElementBoundsY(e){const{y:t,contain:r,height:s}=e.props,{elementBounds:n}=e;n.y1=t,n.y2="both"===r?t+s:1/0}}class Zt extends Dt{fontFace;fontUrl;constructor(e){super(e);const{fontFamily:t,fontUrl:r}=e,s=r.replace(/\(|\)/g,""),n=this.descriptors,i={style:n.style,weight:"number"==typeof n.weight?`${n.weight}`:n.weight,stretch:n.stretch,unicodeRange:n.unicodeRange,featureSettings:n.featureSettings,display:n.display},o=new FontFace(t,`url(${s})`,i);o.load().then((()=>{this.loaded=!0,this.emit("loaded")})).catch(console.error),this.fontFace=o,this.fontUrl=r}}function Qt(e,t,r,s,n){return r*(s-1)+("bottom"!==e?.5*t:0)+Math.max(r,t)+(n||0)}class Jt{_canvas;_context;_settings;constructor(e,t){this._canvas=e,this._context=t,this._settings=this.mergeDefaults({})}set settings(e){this._settings=this.mergeDefaults(e)}get settings(){return this._settings}getPrecision(){return this._settings.precision}setFontProperties(){this._context.font=this._getFontSetting(),this._context.textBaseline=this._settings.textBaseline}_getFontSetting(){const e=[this._settings.fontFamily],t=[];for(let r=0,s=e.length;r<s;r++)"serif"===e[r]||"sans-serif"===e[r]?t.push(e[r]):t.push(`"${e[r]}"`);return`${this._settings.fontStyle} ${this._settings.fontSize*this.getPrecision()}px ${t.join(",")}`}_load(){if(document.fonts){const e=this._getFontSetting();try{if(!document.fonts.check(e,this._settings.text))return document.fonts.load(e,this._settings.text).catch((t=>{console.warn("[Lightning] Font load error",t,e)})).then((()=>{document.fonts.check(e,this._settings.text)||console.warn("[Lightning] Font not found",e)}))}catch(t){console.warn("[Lightning] Can't check font loading for "+e)}}}calculateRenderInfo(){const e={},t=this.getPrecision(),r=this._settings.paddingLeft*t,s=this._settings.paddingRight*t,n=this._settings.fontSize*t;let i=null===this._settings.offsetY?null:this._settings.offsetY*t;const o=this._settings.w*t,a=this._settings.h*t;let l=this._settings.wordWrapWidth*t;const h=this._settings.cutSx*t,c=this._settings.cutEx*t,d=this._settings.cutSy*t,u=this._settings.cutEy*t,p=(this._settings.letterSpacing||0)*t,f=this._settings.textIndent*t,m=this._settings.trFontFace;this.setFontProperties(),G(m);const g=function(e,t,r){if(t.metrics)return t.metrics;const s=e.measureText("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz");let n;return console.warn(`Font metrics not provided for Canvas Web font ${t.fontFamily}. Using fallback values. It is HIGHLY recommended you use the latest version of the Lightning 3 \`msdf-generator\` tool to extract the default metrics for the font and provide them in the Canvas Web font definition.`),n=s.actualBoundingBoxDescent&&s.actualBoundingBoxAscent?{ascender:s.actualBoundingBoxAscent/r,descender:-s.actualBoundingBoxDescent/r,lineGap:.2}:{ascender:.8,descender:-.2,lineGap:.2},t.metrics=n,n}(this._context,m,n),x=jt(g,n)*t,y=null!==this._settings.lineHeight?this._settings.lineHeight*t:x,v=this._settings.maxHeight,T=null!==v&&y>0?Math.floor(v/y):0,b=this._settings.maxLines,w=T>0&&b>0?Math.min(T,b):Math.max(T,b);let S,_=o||2048/this.getPrecision(),R=_-r;if(R<10&&(_+=10-R,R=10),l||(l=R),this._settings.textOverflow&&!this._settings.wordWrap){let e;switch(this._settings.textOverflow){case"clip":e="";break;case"ellipsis":e=this._settings.overflowSuffix;break;default:e=this._settings.textOverflow}this._settings.text=this.wrapWord(this._settings.text,l-f,e)}if(this._settings.wordWrap)S=this.wrapText(this._settings.text,l,p,f);else{S={l:this._settings.text.split(/(?:\r\n|\r|\n)/),n:[]};const e=S.l.length;for(let t=0;t<e-1;t++)S.n.push(t)}let E=S.l;if(w&&E.length>w){const t=E.slice(0,w);let r,s=null;if(this._settings.overflowSuffix){const e=this._settings.overflowSuffix?this.measureText(this._settings.overflowSuffix):0,r=this.wrapText(t[t.length-1],l-e,p,f);t[t.length-1]=`${r.l[0]}${this._settings.overflowSuffix}`,s=[r.l.length>1?r.l[1]:""]}else s=[""];const n=E.length;let i=0;const o=S.n.length;for(r=w;r<n;r++)s[i]+=`${s[i]?" ":""}${E[r]}`,r+1<o&&S.n[r+1]&&i++;e.remainingText=s.join("\n"),e.moreTextLines=!0,E=t}else e.moreTextLines=!1,e.remainingText="";let C=0;const A=[];for(let e=0;e<E.length;e++){const t=this.measureText(E[e],p)+(0===e?f:0);A.push(t),C=Math.max(C,t)}let M;return e.lineWidths=A,o||(_=C+r+s,R=C),M=a||Qt(this._settings.textBaseline,n,y,E.length,i),null===i&&(i=n),e.w=_,e.h=M,e.lines=E,e.precision=t,_||(_=1),M||(M=1),(h||c)&&(_=Math.min(_,c-h)),(d||u)&&(M=Math.min(M,u-d)),e.width=_,e.innerWidth=R,e.height=M,e.fontSize=n,e.cutSx=h,e.cutSy=d,e.cutEx=c,e.cutEy=u,e.lineHeight=y,e.defLineHeight=x,e.lineWidths=A,e.offsetY=i,e.paddingLeft=r,e.paddingRight=s,e.letterSpacing=p,e.textIndent=f,e.metrics=g,e}draw(e,t){const r=this.getPrecision(),s=t?.lines||e.lines,n=t?.lineWidths||e.lineWidths,i=t?Qt(this._settings.textBaseline,e.fontSize,e.lineHeight,t.lines.length,null===this._settings.offsetY?null:this._settings.offsetY*r):e.height;let o,a;this._canvas.width=Math.min(Math.ceil(e.width+this._settings.textRenderIssueMargin),2048),this._canvas.height=Math.min(Math.ceil(i),2048),this.setFontProperties(),e.fontSize>=128&&(this._context.globalAlpha=.01,this._context.fillRect(0,0,.01,.01),this._context.globalAlpha=1),(e.cutSx||e.cutSy)&&this._context.translate(-e.cutSx,-e.cutSy);const l=[],{metrics:h}=e,c=h?h.ascender*e.fontSize:e.fontSize,d=(h.ascender-h.descender)*e.fontSize;for(let t=0,r=s.length;t<r;t++)o=0===t?e.textIndent:0,a=t*e.lineHeight+c,"middle"==this._settings.verticalAlign?a+=(e.lineHeight-d)/2:"bottom"==this._settings.verticalAlign&&(a+=e.lineHeight-d),"right"===this._settings.textAlign?o+=e.innerWidth-n[t]:"center"===this._settings.textAlign&&(o+=(e.innerWidth-n[t])/2),o+=e.paddingLeft,l.push({text:s[t],x:o,y:a,w:n[t]});if(this._settings.highlight){const t=this._settings.highlightColor,s=this._settings.highlightHeight*r||1.5*e.fontSize,n=this._settings.highlightOffset*r,i=null!==this._settings.highlightPaddingLeft?this._settings.highlightPaddingLeft*r:e.paddingLeft,o=null!==this._settings.highlightPaddingRight?this._settings.highlightPaddingRight*r:e.paddingRight;this._context.fillStyle=ee(t);for(let t=0;t<l.length;t++){const r=l[t];this._context.fillRect(r.x-i,r.y-e.offsetY+n,r.w+o+i,s)}}let u=null;this._settings.shadow&&(u=[this._context.shadowColor,this._context.shadowOffsetX,this._context.shadowOffsetY,this._context.shadowBlur],this._context.shadowColor=ee(this._settings.shadowColor),this._context.shadowOffsetX=this._settings.shadowOffsetX*r,this._context.shadowOffsetY=this._settings.shadowOffsetY*r,this._context.shadowBlur=this._settings.shadowBlur*r),this._context.fillStyle=ee(this._settings.textColor);for(let t=0,r=l.length;t<r;t++){const r=l[t];if(0===e.letterSpacing)this._context.fillText(r.text,r.x,r.y);else{const t=r.text.split("");let s=r.x;for(let n=0,i=t.length;n<i;n++)this._context.fillText(t[n],s,r.y),s+=this.measureText(t[n],e.letterSpacing)}}u&&(this._context.shadowColor=u[0],this._context.shadowOffsetX=u[1],this._context.shadowOffsetY=u[2],this._context.shadowBlur=u[3]),(e.cutSx||e.cutSy)&&this._context.translate(e.cutSx,e.cutSy)}wrapWord(e,t,r){const s=this._context.measureText(r).width,n=e.length,i=this._context.measureText(e).width;if(i<=t)return e;let o=Math.floor(t*n/i),a=this._context.measureText(e.substring(0,o)).width+s;if(a>t)for(;o>0&&(a=this._context.measureText(e.substring(0,o)).width+s,a>t);)o-=1;else for(;o<n;){if(a=this._context.measureText(e.substring(0,o)).width+s,!(a<t)){o-=1;break}o+=1}return e.substring(0,o)+(t>=s?r:"")}wrapText(e,t,r,s=0){const n=e.split(/\r?\n/g);let i=[];const o=[];for(let e=0;e<n.length;e++){const a=[];let l="",h=t-s;const c=n[e].split(" ");for(let e=0;e<c.length;e++){const n=this.measureText(c[e],r),i=n+this.measureText(" ",r);0===e||i>h?(e>0&&(a.push(l),l=""),l+=c[e],h=t-n-(0===e?s:0)):(h-=i,l+=` ${c[e]}`)}a.push(l),l="",i=i.concat(a),e<n.length-1&&o.push(i.length)}return{l:i,n:o}}measureText(e,t=0){return t?e.split("").reduce(((e,r)=>e+this._context.measureText(r).width+t),0):this._context.measureText(e).width}mergeDefaults(e){return{text:"",w:0,h:0,fontStyle:"normal",fontSize:40,fontFamily:null,trFontFace:null,wordWrap:!0,wordWrapWidth:0,wordBreak:!1,textOverflow:"",lineHeight:null,textBaseline:"alphabetic",textAlign:"left",verticalAlign:"top",offsetY:null,maxLines:0,maxHeight:null,overflowSuffix:"...",textColor:[1,1,1,1],paddingLeft:0,paddingRight:0,shadow:!1,shadowColor:[0,0,0,1],shadowOffsetX:0,shadowOffsetY:0,shadowBlur:5,highlight:!1,highlightHeight:0,highlightColor:[0,0,0,1],highlightOffset:0,highlightPaddingLeft:0,highlightPaddingRight:0,letterSpacing:0,textIndent:0,cutSx:0,cutEx:0,cutSy:0,cutEy:0,advancedRenderer:!1,fontBaselineRatio:0,precision:1,textRenderIssueMargin:0,...e}}}const er="undefined"==typeof self?globalThis:self,tr=er.document?.fonts||er.fonts;class rr extends $t{canvas;context;fontFamilies={};fontFamilyArray=[this.fontFamilies];constructor(e){super(e),"undefined"!=typeof OffscreenCanvas?this.canvas=new OffscreenCanvas(0,0):this.canvas=document.createElement("canvas");let t=this.canvas.getContext("2d",{willReadFrequently:!0});t||(this.canvas=document.createElement("canvas"),t=this.canvas.getContext("2d",{willReadFrequently:!0})),G(t),this.context=t,this.addFontFace(new Zt({fontFamily:"sans-serif",descriptors:{},fontUrl:""}))}getPropertySetters(){return{fontFamily:(e,t)=>{e.props.fontFamily=t,e.fontInfo=void 0,this.invalidateLayoutCache(e)},fontWeight:(e,t)=>{e.props.fontWeight=t,e.fontInfo=void 0,this.invalidateLayoutCache(e)},fontStyle:(e,t)=>{e.props.fontStyle=t,e.fontInfo=void 0,this.invalidateLayoutCache(e)},fontStretch:(e,t)=>{e.props.fontStretch=t,e.fontInfo=void 0,this.invalidateLayoutCache(e)},fontSize:(e,t)=>{e.props.fontSize=t,e.fontInfo=void 0,this.invalidateLayoutCache(e)},text:(e,t)=>{e.props.text=t,this.invalidateLayoutCache(e)},textAlign:(e,t)=>{e.props.textAlign=t,this.invalidateLayoutCache(e)},color:(e,t)=>{e.props.color=t,this.invalidateLayoutCache(e)},x:(e,t)=>{e.props.x=t},y:(e,t)=>{e.props.y=t},contain:(e,t)=>{e.props.contain=t,this.invalidateLayoutCache(e)},width:(e,t)=>{e.props.width=t,"none"!==e.props.contain&&this.invalidateLayoutCache(e)},height:(e,t)=>{e.props.height=t,"both"===e.props.contain&&this.invalidateLayoutCache(e)},offsetY:(e,t)=>{e.props.offsetY=t,this.invalidateLayoutCache(e)},scrollY:(e,t)=>{e.props.scrollY=t},letterSpacing:(e,t)=>{e.props.letterSpacing=t,this.invalidateLayoutCache(e)},lineHeight:(e,t)=>{e.props.lineHeight=t,this.invalidateLayoutCache(e)},maxLines:(e,t)=>{e.props.maxLines=t,this.invalidateLayoutCache(e)},textBaseline:(e,t)=>{e.props.textBaseline=t,this.invalidateLayoutCache(e)},verticalAlign:(e,t)=>{e.props.verticalAlign=t,this.invalidateLayoutCache(e)},overflowSuffix:(e,t)=>{e.props.overflowSuffix=t,this.invalidateLayoutCache(e)}}}canRenderFont(e){return!0}isFontFaceSupported(e){return e instanceof Zt}addFontFace(e){G(e instanceof Zt),"sans-serif"!==e.fontFamily&&tr.add(e.fontFace);const{fontFamilies:t}=this,r=e.fontFace.family;let s=t[r];s||(s=new Set,t[r]=s),s.add(e)}createState(e,t){return{node:t,props:e,status:"initialState",updateScheduled:!1,emitter:new q,textureNode:void 0,lightning2TextRenderer:new Jt(this.canvas,this.context),renderInfo:void 0,forceFullLayoutCalc:!1,textW:0,textH:0,fontInfo:void 0,isRenderable:!1,debugData:{updateCount:0,layoutCount:0,drawCount:0,lastLayoutNumCharacters:0,layoutSum:0,drawSum:0,bufferSize:0}}}updateState(e){if("initialState"===e.status&&this.setStatus(e,"loading"),"loaded"!==e.status)return e.fontInfo?void(e.fontInfo.loaded&&(e.renderInfo||(e.renderInfo=this.calculateRenderInfo(e),e.textH=e.renderInfo.lineHeight*e.renderInfo.lines.length,e.textW=e.renderInfo.width,this.renderSingleCanvasPage(e)))):this.loadFont(e)}renderSingleCanvasPage(e){G(e.renderInfo);const t=e.node,r=this.stage.txManager.loadTexture("ImageTexture",{src:function(e,t){return G(t),e.draw(t,{lines:t.lines,lineWidths:t.lineWidths}),0===this.canvas.width||0===this.canvas.height?null:this.context.getImageData(0,0,this.canvas.width,this.canvas.height)}.bind(this,e.lightning2TextRenderer,e.renderInfo)});if(e.textureNode)e.textureNode.texture=r;else{const s=this.stage.createNode({parent:t,texture:r,autosize:!0,alpha:J(e.props.color)});e.textureNode=s}this.setStatus(e,"loaded")}loadFont=e=>{const t=function(e){const{fontFamily:t,fontStyle:r,fontWeight:s,fontStretch:n,fontSize:i}=e;return[r,s,n,`${i}px`,t].join(" ")}(e.props),r=Ut.resolveFontFace(this.fontFamilyArray,e.props);G(r,`Could not resolve font face for ${t}`),e.fontInfo={fontFace:r,cssString:t,loaded:!1},e.fontInfo.loaded||tr.load(t).then(this.onFontLoaded.bind(this,e,t)).catch(this.onFontLoadError.bind(this,e,t))};calculateRenderInfo(e){return e.lightning2TextRenderer.settings={text:e.props.text,textAlign:e.props.textAlign,fontFamily:e.props.fontFamily,trFontFace:e.fontInfo?.fontFace,fontSize:e.props.fontSize,fontStyle:[e.props.fontStretch,e.props.fontStyle,e.props.fontWeight].join(" "),textColor:Q(e.props.color),offsetY:e.props.offsetY,wordWrap:"none"!==e.props.contain,wordWrapWidth:"none"===e.props.contain?void 0:e.props.width,letterSpacing:e.props.letterSpacing,lineHeight:e.props.lineHeight??null,maxLines:e.props.maxLines,maxHeight:"both"===e.props.contain?e.props.height-e.props.offsetY:null,textBaseline:e.props.textBaseline,verticalAlign:e.props.verticalAlign,overflowSuffix:e.props.overflowSuffix,w:"none"!==e.props.contain?e.props.width:void 0},e.renderInfo=e.lightning2TextRenderer.calculateRenderInfo(),e.renderInfo}renderQuads(){}destroyState(e){"destroyed"!==e.status&&(super.destroyState(e),e.textureNode&&(e.textureNode.destroy(),delete e.textureNode),delete e.renderInfo)}invalidateLayoutCache(e){e.renderInfo=void 0,this.setStatus(e,"loading"),this.scheduleUpdateState(e)}onFontLoaded(e,t){t===e.fontInfo?.cssString&&e.fontInfo&&(e.fontInfo.loaded=!0,this.scheduleUpdateState(e))}onFontLoadError(e,t,r){t===e.fontInfo?.cssString&&e.fontInfo&&(e.fontInfo.loaded=!0,console.error(`CanvasTextRenderer: Error loading font '${e.fontInfo.cssString}'`,r),this.scheduleUpdateState(e))}}class sr{data={};reset(){this.data={}}increment(e){this.data[e]||(this.data[e]=0),this.data[e]++}getData(){return{...this.data}}}class nr{stage;memUsed=0;loadedTextures=new Map;criticalThreshold;targetThreshold;cleanupInterval;debugLogging;lastCleanupTime=0;criticalCleanupRequested=!1;frameTime=0;constructor(e,t){this.stage=e;const{criticalThreshold:r}=t;this.criticalThreshold=Math.round(r);const s=Math.max(0,Math.min(1,t.targetThresholdLevel));if(this.targetThreshold=Math.round(r*s),this.cleanupInterval=t.cleanupInterval,this.debugLogging=t.debugLogging,t.debugLogging){let e=0;setInterval((()=>{e!==this.memUsed&&(e=this.memUsed,console.log(`[TextureMemoryManager] Memory used: ${me(this.memUsed)} mb / ${me(this.criticalThreshold)} mb (${(this.memUsed/this.criticalThreshold*100).toFixed(1)}%)`))}),1e3)}0===r&&(this.setTextureMemUse=()=>{})}setTextureMemUse(e,t){this.loadedTextures.has(e)&&(this.memUsed-=this.loadedTextures.get(e)),0!==t?(this.memUsed+=t,this.loadedTextures.set(e,t),this.memUsed>this.criticalThreshold&&(this.criticalCleanupRequested=!0)):this.loadedTextures.delete(e)}checkCleanup(){return this.criticalCleanupRequested||this.memUsed>this.targetThreshold&&this.frameTime-this.lastCleanupTime>=this.cleanupInterval}cleanup(){const e=this.criticalCleanupRequested;this.lastCleanupTime=this.frameTime,this.criticalCleanupRequested=!1,e&&this.stage.queueFrameEvent("criticalCleanup",{memUsed:this.memUsed,criticalThreshold:this.criticalThreshold}),this.debugLogging&&console.log(`[TextureMemoryManager] Cleaning up textures. Critical: ${e}`);const t=[...this.loadedTextures.keys()].sort(((e,t)=>{const r=e.renderable,s=t.renderable;return r===s?e.lastRenderableChangeTime-t.lastRenderableChangeTime:r?1:s?-1:0})),r=this.targetThreshold,s=this.stage.txManager;for(const e of t){if(e.renderable)break;if(e.ctxTexture.free(),s.removeTextureFromCache(e),this.memUsed<=r)break}this.memUsed>=this.criticalThreshold&&(this.stage.queueFrameEvent("criticalCleanupFailed",{memUsed:this.memUsed,criticalThreshold:this.criticalThreshold}),console.warn(`[TextureMemoryManager] Memory usage above critical threshold after cleanup: ${this.memUsed}`))}getMemoryInfo(){let e=0;const t=[...this.loadedTextures.keys()].reduce(((t,r)=>(e+=r.renderable?1:0,t+(r.renderable?this.loadedTextures.get(r):0))),0);return{criticalThreshold:this.criticalThreshold,targetThreshold:this.targetThreshold,renderableMemUsed:t,memUsed:this.memUsed,renderableTexturesLoaded:e,loadedTextures:this.loadedTextures.size}}}const ir={isWhite:!0,a:1,r:255,g:255,b:255};function or(e){if(4294967295===e)return ir;return{isWhite:!1,a:(e>>>24&255)/255,r:255&e,g:255&e>>>8,b:255&e>>>16}}function ar({a:e,r:t,g:r,b:s}){return`rgba(${t},${r},${s},${e})`}class lr extends Ee{image;tintCache;load(){"freed"===this.textureSource.state&&(this.textureSource.setState("loading"),this.onLoadRequest().then((e=>{this.textureSource.setState("loaded",e),this.updateMemSize()})).catch((e=>{this.textureSource.setState("failed",e)})))}free(){this.image=void 0,this.tintCache=void 0,this.textureSource.setState("freed"),this.setTextureMemUse(0)}updateMemSize(){const e=this.tintCache?8:4;if(this.textureSource.dimensions){const{width:t,height:r}=this.textureSource.dimensions;this.setTextureMemUse(t*r*e)}}hasImage(){return void 0!==this.image}getImage(e){const t=this.image;if(G(t,"Attempt to get unloaded image texture"),e.isWhite)return this.tintCache&&(this.tintCache=void 0,this.updateMemSize()),t;const r=ar(e);if(this.tintCache?.key===r)return this.tintCache.image;const s=this.tintTexture(t,r);return this.tintCache={key:r,image:s},this.updateMemSize(),s}tintTexture(e,t){const{width:r,height:s}=e,n=document.createElement("canvas");n.width=r,n.height=s;const i=n.getContext("2d");return i&&(i.fillStyle=t,i.globalCompositeOperation="copy",i.fillRect(0,0,r,s),i.globalCompositeOperation="multiply",i.drawImage(e,0,0,r,s,0,0,r,s),i.globalCompositeOperation="destination-in",i.drawImage(e,0,0,r,s,0,0,r,s)),n}async onLoadRequest(){const{data:e}=await this.textureSource.getTextureData();if(e instanceof ImageData){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const r=t.getContext("2d");return r&&r.putImageData(e,0,0),this.image=t,{width:e.width,height:e.height}}return e instanceof ImageBitmap?(this.image=e,{width:e.width,height:e.height}):{width:0,height:0}}}class hr extends Ce{context;canvas;pixelRatio;clearColor;renderToTextureActive=!1;activeRttNode=null;defShaderCtr;constructor(e){super(e),this.mode="canvas",this.shManager.renderer=this;const{canvas:t,pixelRatio:r,clearColor:s}=e;this.canvas=t,this.context=t.getContext("2d"),this.pixelRatio=r,this.clearColor=s?(e=>[e>>>24,e>>>16&255,e>>>8&255,255&e])(s):void 0,this.defShaderCtr={type:"DefaultShader",props:{},shader:new gt("DefaultShader"),getResolvedProps:()=>()=>({})}}reset(){this.canvas.width=this.canvas.width;const e=this.context;if(this.clearColor){const[t,r,s,n]=this.clearColor;e.fillStyle=`rgba(${t}, ${r}, ${s}, ${n/255})`,e.fillRect(0,0,this.canvas.width,this.canvas.height)}e.scale(this.pixelRatio,this.pixelRatio)}render(){}addQuad(e){const t=this.context,{tx:r,ty:s,width:n,height:i,alpha:o,colorTl:a,colorTr:l,colorBr:h,ta:c,tb:d,tc:u,td:p,clippingRect:f}=e;let m,g,x=e.texture;if(x){if(x instanceof De&&(g=x.props,x=x.parentTexture),m=x.ctxTexture,"freed"===x.state)return void m.load();if("loaded"!==x.state||!m.hasImage())return}const y=or(a),v=1!==c,T=0!==f.width&&0!==f.height,b=a!==l||a!==h,w=e.shader?function(e){if(e.shader instanceof gt&&e.shader.shType===mt)return e.shaderProps?.radius??0;return 0}(e):0;if((v||T||w)&&t.save(),T){const e=new Path2D,{x:r,y:s,width:n,height:i}=f;e.rect(r,s,n,i),t.clip(e)}if(v){const e=this.pixelRatio;t.setTransform(c,u,d,p,r*e,s*e),t.scale(e,e),t.translate(-r,-s)}if(w){const e=new Path2D;e.roundRect(r,s,n,i,w),t.clip(e)}if(m){const e=m.getImage(y);t.globalAlpha=o,g?t.drawImage(e,g.x,g.y,g.width,g.height,r,s,n,i):t.drawImage(e,r,s,n,i),t.globalAlpha=1}else if(b){let e,o=r,c=s;a===l?(o=r,c=s+i,e=or(h)):(o=r+n,c=s,e=or(l));const d=t.createLinearGradient(r,s,o,c);d.addColorStop(0,ar(y)),d.addColorStop(1,ar(e)),t.fillStyle=d,t.fillRect(r,s,n,i)}else t.fillStyle=ar(y),t.fillRect(r,s,n,i);(v||T||w)&&t.restore()}createCtxTexture(e){return new lr(this.txMemManager,e)}getShaderManager(){return this.shManager}getDefShaderCtr(){return this.defShaderCtr}renderRTTNodes(){}removeRTTNode(e){}renderToTexture(e){}}class cr extends be{textRenderer;trState;_textRendererOverride=null;constructor(e,t){super(e,t),this._textRendererOverride=t.textRendererOverride;const{resolvedTextRenderer:r,textRendererState:s}=this.resolveTextRendererAndState({x:this.absX,y:this.absY,width:t.width,height:t.height,textAlign:t.textAlign,color:t.color,zIndex:t.zIndex,contain:t.contain,scrollable:t.scrollable,scrollY:t.scrollY,offsetY:t.offsetY,letterSpacing:t.letterSpacing,debug:t.debug,fontFamily:t.fontFamily,fontSize:t.fontSize,fontStretch:t.fontStretch,fontStyle:t.fontStyle,fontWeight:t.fontWeight,text:t.text,lineHeight:t.lineHeight,maxLines:t.maxLines,textBaseline:t.textBaseline,verticalAlign:t.verticalAlign,overflowSuffix:t.overflowSuffix});this.textRenderer=r,this.trState=s}onTextLoaded=()=>{const{contain:e}=this,t=this.trState.props.width,r=this.trState.props.height,s=this.trState.textW||0,n=this.trState.textH||0;"both"===e?(this.props.width=t,this.props.height=r):"width"===e?(this.props.width=t,this.props.height=n):"none"===e&&(this.props.width=s,this.props.height=n),this.updateLocalTransform(),this.stage.requestRender(),this.emit("loaded",{type:"text",dimensions:{width:this.trState.textW||0,height:this.trState.textH||0}})};onTextFailed=(e,t)=>{this.emit("failed",{type:"text",error:t})};get width(){return this.props.width}set width(e){this.props.width=e,this.textRenderer.set.width(this.trState,e),"none"===this.contain&&this.setUpdateType(Te.Local)}get height(){return this.props.height}set height(e){this.props.height=e,this.textRenderer.set.height(this.trState,e),"both"!==this.contain&&this.setUpdateType(Te.Local)}get color(){return this.trState.props.color}set color(e){this.textRenderer.set.color(this.trState,e)}get text(){return this.trState.props.text}set text(e){this.textRenderer.set.text(this.trState,e)}get textRendererOverride(){return this._textRendererOverride}set textRendererOverride(e){this._textRendererOverride=e,this.textRenderer.destroyState(this.trState);const{resolvedTextRenderer:t,textRendererState:r}=this.resolveTextRendererAndState(this.trState.props);this.textRenderer=t,this.trState=r}get fontSize(){return this.trState.props.fontSize}set fontSize(e){this.textRenderer.set.fontSize(this.trState,e)}get fontFamily(){return this.trState.props.fontFamily}set fontFamily(e){this.textRenderer.set.fontFamily(this.trState,e)}get fontStretch(){return this.trState.props.fontStretch}set fontStretch(e){this.textRenderer.set.fontStretch(this.trState,e)}get fontStyle(){return this.trState.props.fontStyle}set fontStyle(e){this.textRenderer.set.fontStyle(this.trState,e)}get fontWeight(){return this.trState.props.fontWeight}set fontWeight(e){this.textRenderer.set.fontWeight(this.trState,e)}get textAlign(){return this.trState.props.textAlign}set textAlign(e){this.textRenderer.set.textAlign(this.trState,e)}get contain(){return this.trState.props.contain}set contain(e){this.textRenderer.set.contain(this.trState,e)}get scrollable(){return this.trState.props.scrollable}set scrollable(e){this.textRenderer.set.scrollable(this.trState,e)}get scrollY(){return this.trState.props.scrollY}set scrollY(e){this.textRenderer.set.scrollY(this.trState,e)}get offsetY(){return this.trState.props.offsetY}set offsetY(e){this.textRenderer.set.offsetY(this.trState,e)}get letterSpacing(){return this.trState.props.letterSpacing}set letterSpacing(e){this.textRenderer.set.letterSpacing(this.trState,e)}get lineHeight(){return this.trState.props.lineHeight}set lineHeight(e){this.textRenderer.set.lineHeight&&this.textRenderer.set.lineHeight(this.trState,e)}get maxLines(){return this.trState.props.maxLines}set maxLines(e){this.textRenderer.set.maxLines&&this.textRenderer.set.maxLines(this.trState,e)}get textBaseline(){return this.trState.props.textBaseline}set textBaseline(e){this.textRenderer.set.textBaseline&&this.textRenderer.set.textBaseline(this.trState,e)}get verticalAlign(){return this.trState.props.verticalAlign}set verticalAlign(e){this.textRenderer.set.verticalAlign&&this.textRenderer.set.verticalAlign(this.trState,e)}get overflowSuffix(){return this.trState.props.overflowSuffix}set overflowSuffix(e){this.textRenderer.set.overflowSuffix&&this.textRenderer.set.overflowSuffix(this.trState,e)}get debug(){return this.trState.props.debug}set debug(e){this.textRenderer.set.debug(this.trState,e)}update(e,t){super.update(e,t),G(this.globalTransform),this.textRenderer.set.x(this.trState,this.globalTransform.tx),this.textRenderer.set.y(this.trState,this.globalTransform.ty)}checkRenderProps(){return""!==this.trState.props.text||super.checkRenderProps()}onChangeIsRenderable(e){super.onChangeIsRenderable(e),this.textRenderer.setIsRenderable(this.trState,e)}renderQuads(e){if(G(this.globalTransform),this.textRenderer.renderQuads){if(this.parentHasRenderTexture){if(!e.renderToTextureActive)return;if(this.parentRenderTexture!==e.activeRttNode)return}this.parentHasRenderTexture&&this.props.parent?.rtt&&(this.globalTransform=oe.identity(),this.localTransform&&this.globalTransform.multiply(this.localTransform)),G(this.globalTransform),this.textRenderer.renderQuads(this.trState,this.globalTransform,this.clippingRect,this.worldAlpha,this.parentHasRenderTexture,this.framebufferDimensions)}else super.renderQuads(e)}destroy(){super.destroy(),this.textRenderer.destroyState(this.trState)}resolveTextRendererAndState(e){const t=this.stage.resolveTextRenderer(e,this._textRendererOverride),r=t.createState(e,this);return r.emitter.on("loaded",this.onTextLoaded),r.emitter.on("failed",this.onTextFailed),t.scheduleUpdateState(r),{resolvedTextRenderer:t,textRendererState:r}}}class dr{options;animationManager;txManager;txMemManager;fontManager;textRenderers;shManager;renderer;root;boundsMargin;defShaderCtr;eventBus;deltaTime=0;lastFrameTime=0;currentFrameTime=0;fpsNumFrames=0;fpsElapsedTime=0;renderRequested=!1;frameEventQueue=[];contextSpy=null;constructor(e){this.options=e;const{canvas:t,clearColor:r,appWidth:s,appHeight:n,boundsMargin:i,enableContextSpy:o,numImageWorkers:a,textureMemory:l,renderMode:h}=e;this.eventBus=e.eventBus,this.txManager=new Lt(a),this.txMemManager=new nr(this,l),this.shManager=new vt,this.animationManager=new At,this.contextSpy=o?new sr:null;let c=[0,0,0,0];i&&(c=Array.isArray(i)?i:[i,i,i,i]),this.boundsMargin=c;const d={stage:this,canvas:t,pixelRatio:e.devicePhysicalPixelRatio*e.deviceLogicalPixelRatio,clearColor:r??4278190080,bufferMemory:2e6,txManager:this.txManager,txMemManager:this.txMemManager,shManager:this.shManager,contextSpy:this.contextSpy};this.renderer="canvas"===h?new hr(d):new Ct(d),this.defShaderCtr=this.renderer.getDefShaderCtr(),W="webgl"===h,this.txManager.renderer=this.renderer,this.textRenderers="webgl"===h?{canvas:new rr(this),sdf:new qt(this)}:{canvas:new rr(this)},this.fontManager=new Ut(this.textRenderers);const u=new be(this,{x:0,y:0,width:s,height:n,alpha:1,autosize:!1,clipping:!1,color:0,colorTop:0,colorBottom:0,colorLeft:0,colorRight:0,colorTl:0,colorTr:0,colorBl:0,colorBr:0,zIndex:0,zIndexLocked:0,scaleX:1,scaleY:1,mountX:0,mountY:0,mount:0,pivot:.5,pivotX:.5,pivotY:.5,rotation:0,parent:null,texture:null,textureOptions:{},shader:this.defShaderCtr,rtt:!1,src:null,scale:1});this.root=u,(e=>{let t=!1;const r=()=>{if(e.updateFrameTime(),e.updateAnimations(),!e.hasSceneUpdates())return e.calculateFps(),setTimeout(r,16.666666666666668),t||(e.txMemManager.checkCleanup()&&e.txMemManager.cleanup(),e.eventBus.emit("idle"),t=!0),void e.flushFrameEvents();t=!1,e.drawFrame(),e.flushFrameEvents(),requestAnimationFrame(r)};requestAnimationFrame(r)})(this)}updateFrameTime(){const e=performance?performance.now():Date.now();this.lastFrameTime=this.currentFrameTime,this.currentFrameTime=e,this.deltaTime=this.lastFrameTime?e-this.lastFrameTime:100/6,this.txManager.frameTime=e,this.txMemManager.frameTime=e,this.eventBus.emit("frameTick",{time:this.currentFrameTime,delta:this.deltaTime})}updateAnimations(){const{animationManager:e}=this;this.root&&e.update(this.deltaTime)}hasSceneUpdates(){return!!this.root.updateType||this.renderRequested}drawFrame(){const{renderer:e,renderRequested:t}=this;G(e),0!==this.root.updateType&&this.root.update(this.deltaTime,this.root.clippingRect),e.reset(),this.txMemManager.criticalCleanupRequested&&this.txMemManager.cleanup(),e.rttNodes.length>0&&e.renderRTTNodes(),this.addQuads(this.root),e?.render(),this.calculateFps(),t&&(this.renderRequested=!1)}queueFrameEvent(e,t){this.frameEventQueue.push([e,t])}flushFrameEvents(){for(const[e,t]of this.frameEventQueue)this.eventBus.emit(e,t);this.frameEventQueue=[]}calculateFps(){const{fpsUpdateInterval:e}=this.options;if(e&&(this.fpsNumFrames++,this.fpsElapsedTime+=this.deltaTime,this.fpsElapsedTime>=e)){const e=Math.round(1e3*this.fpsNumFrames/this.fpsElapsedTime);this.fpsNumFrames=0,this.fpsElapsedTime=0,this.queueFrameEvent("fpsUpdate",{fps:e,contextSpyData:this.contextSpy?.getData()??null}),this.contextSpy?.reset()}}addQuads(e){G(this.renderer&&e.globalTransform),e.isRenderable&&e.renderQuads(this.renderer);for(let t=0;t<e.children.length;t++){const r=e.children[t];r&&(0!==r?.worldAlpha&&this.addQuads(r))}}requestRender(){this.renderRequested=!0}resolveTextRenderer(e,t=null){let r=t,s=!1;if(r){const t=this.textRenderers[r];t?t.canRenderFont(e)||(console.warn(`Cannot use override text renderer '${r}' for font`,e),r=null,s=!0):(console.warn(`Text renderer override '${r}' not found.`),r=null,s=!0)}if(!r){for(const[t,s]of Object.entries(this.textRenderers))if("canvas"!==t&&s.canRenderFont(e)){r=t;break}r||(r="canvas")}s&&console.warn(`Falling back to text renderer ${String(r)}`);const n=this.textRenderers[r];return G(n,"resolvedTextRenderer undefined"),n}createShaderCtr(e,t){return this.shManager.loadShader(e,t)}createNode(e){const t=this.resolveNodeDefaults(e);return new be(this,t)}createTextNode(e){const t=e.fontSize??16,r={...this.resolveNodeDefaults(e),text:e.text??"",textRendererOverride:e.textRendererOverride??null,fontSize:t,fontFamily:e.fontFamily??"sans-serif",fontStyle:e.fontStyle??"normal",fontWeight:e.fontWeight??"normal",fontStretch:e.fontStretch??"normal",textAlign:e.textAlign??"left",contain:e.contain??"none",scrollable:e.scrollable??!1,scrollY:e.scrollY??0,offsetY:e.offsetY??0,letterSpacing:e.letterSpacing??0,lineHeight:e.lineHeight,maxLines:e.maxLines??0,textBaseline:e.textBaseline??"alphabetic",verticalAlign:e.verticalAlign??"middle",overflowSuffix:e.overflowSuffix??"...",debug:e.debug??{},shaderProps:null};return new cr(this,r)}resolveNodeDefaults(e){const t=e.color??4294967295,r=e.colorTl??e.colorTop??e.colorLeft??t,s=e.colorTr??e.colorTop??e.colorRight??t,n=e.colorBl??e.colorBottom??e.colorLeft??t,i=e.colorBr??e.colorBottom??e.colorRight??t,o=function(e){const t={boolean:!0,string:!0,number:!0,undefined:!0},r=Object.keys(e);for(let s=0;s<r.length;s++){const n=r[s];if(!n)continue;const i=e[n],o=typeof i;"string"===o&&i.length>2048&&(console.warn(`Custom Data value for ${n} is too long, it will be truncated to 2048 characters`),e[n]=i.substring(0,2048)),t[o]||(console.warn(`Custom Data value for ${n} is not a boolean, string, or number, it will be ignored`),delete e[n])}return e}(e.data??{});return{x:e.x??0,y:e.y??0,width:e.width??0,height:e.height??0,alpha:e.alpha??1,autosize:e.autosize??!1,clipping:e.clipping??!1,color:t,colorTop:e.colorTop??t,colorBottom:e.colorBottom??t,colorLeft:e.colorLeft??t,colorRight:e.colorRight??t,colorBl:n,colorBr:i,colorTl:r,colorTr:s,zIndex:e.zIndex??0,zIndexLocked:e.zIndexLocked??0,parent:e.parent??null,texture:e.texture??null,textureOptions:e.textureOptions??{},shader:e.shader??this.defShaderCtr,src:e.src??null,scale:e.scale??null,scaleX:e.scaleX??e.scale??1,scaleY:e.scaleY??e.scale??1,mount:e.mount??0,mountX:e.mountX??e.mount??0,mountY:e.mountY??e.mount??0,pivot:e.pivot??.5,pivotX:e.pivotX??e.pivot??.5,pivotY:e.pivotY??e.pivot??.5,rotation:e.rotation??0,rtt:e.rtt??!1,data:o}}}class ur extends q{root;canvas;settings;stage;inspector=null;constructor(e,t){super();const r={criticalThreshold:e.textureMemory?.criticalThreshold||124e6,targetThresholdLevel:e.textureMemory?.targetThresholdLevel||.5,cleanupInterval:e.textureMemory?.cleanupInterval||3e4,debugLogging:e.textureMemory?.debugLogging||!1},s={appWidth:e.appWidth||1920,appHeight:e.appHeight||1080,textureMemory:r,boundsMargin:e.boundsMargin||0,deviceLogicalPixelRatio:e.deviceLogicalPixelRatio||1,devicePhysicalPixelRatio:e.devicePhysicalPixelRatio||window.devicePixelRatio,clearColor:e.clearColor??0,fpsUpdateInterval:e.fpsUpdateInterval||0,numImageWorkers:void 0!==e.numImageWorkers?e.numImageWorkers:2,enableContextSpy:e.enableContextSpy??!1,enableInspector:e.enableInspector??!1,renderMode:e.renderMode??"webgl"};this.settings=s;const{appWidth:n,appHeight:i,deviceLogicalPixelRatio:o,devicePhysicalPixelRatio:a,enableInspector:l}=s,h=n*o,c=i*o,d=document.createElement("canvas");let u;if(this.canvas=d,d.width=h*a,d.height=c*a,d.style.width=`${h}px`,d.style.height=`${c}px`,this.stage=new dr({appWidth:this.settings.appWidth,appHeight:this.settings.appHeight,boundsMargin:this.settings.boundsMargin,clearColor:this.settings.clearColor,canvas:this.canvas,deviceLogicalPixelRatio:this.settings.deviceLogicalPixelRatio,devicePhysicalPixelRatio:this.settings.devicePhysicalPixelRatio,enableContextSpy:this.settings.enableContextSpy,fpsUpdateInterval:this.settings.fpsUpdateInterval,numImageWorkers:this.settings.numImageWorkers,renderMode:this.settings.renderMode,textureMemory:r,eventBus:this}),this.root=this.stage.root,u="string"==typeof t?document.getElementById(t):t,!u)throw new Error("Could not find target element");u.appendChild(d),l&&!j()&&(this.inspector=new Re(d,s))}createNode(e){G(this.stage,"Stage is not initialized");const t=this.stage.createNode(e);return this.inspector?this.inspector.createNode(t):t}createTextNode(e){const t=this.stage.createTextNode(e);return this.inspector?this.inspector.createTextNode(t):t}destroyNode(e){return this.inspector&&this.inspector.destroyNode(e.id),e.destroy()}createTexture(e,t){return this.stage.txManager.loadTexture(e,t)}createShader(e,t){return this.stage.shManager.loadShader(e,t)}createDynamicShader(e){return this.stage.shManager.loadDynamicShader({effects:e})}createEffect(e,t,r){return{name:r,type:e,props:t}}getNodeById(e){const t=this.stage?.root;if(!t)return null;const r=t=>{if(t.id===e)return t;for(const e of t.children){const t=r(e);if(t)return t}return null};return r(t)}toggleFreeze(){throw new Error("Not implemented")}advanceFrame(){throw new Error("Not implemented")}rerender(){throw new Error("Not implemented")}}const pr={hd:.66666667,"720p":.66666667,720:.66666667,fhd:1,fullhd:1,"1080p":1,1080:1,"4k":2,"2160p":2,2160:2};var fr=()=>{const e=gr.stage;t.get("fonts",[]).forEach((t=>{"sdf"===t.type||"msdf"===t.type?(!t.png&&t.file&&(t.png=t.file.replace(/\.[^.]+$/,`.${t.type}.png`)),!t.json&&t.file&&(t.json=t.file.replace(/\.[^.]+$/,`.${t.type}.json`)),e.fontManager.addFontFace(new Xt(t.type,{fontFamily:t.family,descriptors:{},atlasUrl:t.png,atlasDataUrl:t.json,stage:e,metrics:t.metrics}))):"web"===t.type&&e.fontManager.addFontFace(new Zt({fontFamily:t.family,fontUrl:t.file,descriptors:{},metrics:t.metrics}))}))},mr=()=>{const e=gr.stage;t.get("shaders",[]).forEach((t=>{e.shManager.registerShaderType(t.name,t.type)})),t.get("effects",[]).forEach((t=>{e.shManager.registerShaderType(t.name,t.type)}))};let gr;const xr=e=>null!==e&&"object"==typeof e&&"transition"in e,yr=e=>"string"==typeof e&&e.startsWith("{")&&e.endsWith("}"),vr=e=>JSON.parse(e.replace(/'/g,'"').replace(/([\w-_]+)\s*:/g,'"$1":')),Tr=function(e,t){return"string"!=typeof e?e:e.indexOf("%")===e.length-1?this.element.parent&&this.element.parent[t]&&this.element.parent[t]*(parseFloat(e)/100):e},br=e=>{if(null===e)return e;if("string"==typeof e)return e;if("number"==typeof e)return e;if("object"==typeof e&&e.constructor===Object){if("value"in e)return e.value;if("transition"in e)return br(e.transition)}return e},wr={top:"colorTop",bottom:"colorBottom",left:"colorLeft",right:"colorRight"};let Sr;const _r={set parent(e){this.props.parent="root"===e?gr.root:e.node},set rotation(e){this.props.rotation=e*(Math.PI/180)},set w(e){this.props.width=Tr.call(this,e,"width")},set width(e){this.props.width=Tr.call(this,e,"width")},set h(e){this.props.height=Tr.call(this,e,"height")},set height(e){this.props.height=Tr.call(this,e,"height")},set x(e){this.props.x=Tr.call(this,e,"width")},set y(e){this.props.y=Tr.call(this,e,"height")},set z(e){this.props.zIndex=e},set zIndex(e){this.props.zIndex=e},set color(e){"string"==typeof e&&-1===e.indexOf("{")?this.props.color=u(e):("object"==typeof e||yr(e)&&(e=vr(e)))&&(this.props.color=0,Object.entries(e).forEach((e=>{this.props[wr[e[0]]]=u(e[1])})))},set src(e){this.props.src=e,void 0===this.raw.get("color")&&(this.props.color=4294967295)},set texture(e){this.props.texture=e,void 0===this.raw.get("color")&&null==e?this.props.color=0:void 0===this.raw.get("color")&&(this.props.color=4294967295)},set rtt(e){this.props.rtt=e,!0===e&&void 0===this.raw.get("color")&&(this.props.color=4294967295)},set mount(e){"object"==typeof e||yr(e)&&(e=vr(e))?("x"in e&&(this.props.mountX=e.x),"y"in e&&(this.props.mountY=e.y)):(this.props.mountX=e,this.props.mountY=e)},set pivot(e){"object"==typeof e||yr(e)&&(e=vr(e))?("x"in e&&(this.props.pivotX=e.x),"y"in e&&(this.props.pivotY=e.y)):(this.props.pivotX=e,this.props.pivotY=e)},set scale(e){"object"==typeof e||yr(e)&&(e=vr(e))?("x"in e&&(this.props.scaleX=e.x),"y"in e&&(this.props.scaleY=e.y)):this.props.scale=e},set show(e){this.props.alpha=e?1:0},set alpha(e){this.props.alpha=e},set shader(e){this.props.shader=null!==e?gr.createShader(e.type,e.props):gr.createShader("DefaultShader")},set effects(e){this.props.shader=gr.createShader("DynamicShader",{effects:e.map((e=>(e.props&&e.props.color&&(e.props.color=u(e.props.color)),e)))})},set clipping(e){this.props.clipping=e},set overflow(e){this.props.clipping=!e},set font(e){this.props.fontFamily=e},set size(e){this.props.fontSize=e},set wordwrap(e){this.props.width=e,this.props.contain="width"},set maxheight(e){this.props.height=e,this.props.contain="both"},set contain(e){this.props.contain=e},set maxlines(e){this.props.maxLines=e},set textoverflow(e){this.props.overflowSuffix=!1===e?" ":!0===e?void 0:e},set letterspacing(e){this.props.letterSpacing=e||1},set lineheight(e){this.props.lineHeight=e},set align(e){this.props.textAlign=e},set content(e){this.props.text=""+e}},Rr={populate(t){const r={...this.config,...t};r[e.isSlot]&&(this[e.isSlot]=!0),this.props.element=this;const s=Object.keys(r),n=s.length;this.props.parent=r.parent,delete r.parent,this.props.raw=new Map(Object.entries(r));for(let e=0;e<n;e++){const t=s[e],n=r[t];void 0!==n&&(this.props[t]=br(n))}void 0!==this.props.props.color||"__textnode"in r||(this.props.props.color=0),this.node=r.__textnode?gr.createTextNode({...Sr,...this.props.props}):this.node=gr.createNode(this.props.props),r["@loaded"]&&this.node.on("loaded",((e,{type:t,dimensions:s})=>{r["@loaded"]({w:s.width,h:s.height,type:t},this)})),r["@error"]&&this.node.on("failed",((e,t)=>{r["@error"](t,this)})),this.component&&this.component.___layout&&this.node.on("loaded",(()=>{this.component.___layout()}))},set(e,t){if(void 0===t)return;if(this.props.raw.get(e)===t)return;this.props.raw.set(e,t),this.props.props={},this.props[e]=br(t);const r=Object.entries(this.props.props);if(1===r.length){const[e,s]=r[0];if(xr(t))return this.animate(e,s,t.transition);this.node[e]=s}else for(let e=0;e<r.length;e++){const[s,n]=r[e];if(xr(t))return this.animate(s,n,t.transition);this.node[s]=n}this.component&&this.component.___layout&&this.component.___layout()},animate(e,t,r){if(this.node[e]===t)return;this.scheduledTransitions[e]&&"running"===this.scheduledTransitions[e].f.state&&(this.node[e]=this.scheduledTransitions[e].v);const s={};s[e]=t;const n=this.node.animate(s,{duration:"object"==typeof r&&"duration"in r?r.duration:300,easing:"object"==typeof r&&"easing"in r?r.easing:"ease",delay:"object"==typeof r&&"delay"in r?r.delay:0}),i=this.node[e];this.scheduledTransitions[e]={v:s[e],cancel:!1,f:n},r.start&&"function"==typeof r.start&&n.once("animating",(()=>{r.start.call(this.component,this,e,i)})),n.once("stopped",(()=>{this.scheduledTransitions[e]=null,r.end&&"function"==typeof r.end&&r.end.call(this.component,this,e,this.node[e])})),n.start()},destroy(){i.debug("Deleting  Node",this.nodeId),this.node.destroy()},get nodeId(){return this.node&&this.node.id},get ref(){return this.props.ref||null},get parent(){return this.node&&this.node.parent},get children(){return this.component[e.getChildren]().filter((t=>t.parent===(this[e.isSlot]?this.node.children[0]:this.node)))}};var Er=(e,r)=>(Sr||(Sr={fontSize:32,fontFamily:t.get("defaultFont","sans-serif")}),Object.assign(Object.create(Rr),{props:Object.assign(Object.create(_r),{props:{}}),scheduledTransitions:{},config:e,component:r})),Cr=(e,t,r={})=>{"fontLoader"in r&&i.warn("\n\nStarting version 0.9.0 of Blits, the Launch setting `fontLoader` is not supported / required anymore.\nYou can remove the option from your `src/index.js`-file. And you can safely remove the file `src/fontLoader.js` from your project.\n      "),gr=new ur({appWidth:r.w||1920,appHeight:r.h||1080,fpsUpdateInterval:r.fpsInterval||1e3,deviceLogicalPixelRatio:r.pixelRatio||pr[r.screenResolution]||pr[window.innerHeight]||1,numImageWorkers:"webWorkersLimit"in r?r.webWorkersLimit:window.navigator.hardwareConcurrency||2,clearColor:r.canvasColor&&u(r.canvasColor)||0,enableInspector:r.inspector||!1,boundsMargin:r.viewportMargin||0,txMemByteThreshold:"gpuMemoryLimit"in r?1024*r.gpuMemoryLimit*1024:209715200,renderMode:"renderMode"in r?r.renderMode:"webgl"},t);return mr(),fr(),(()=>{let t=e();t.quit=()=>{i.info("Closing App"),t.destroy(),t=null,gr=null}})(),gr};let Ar;const Mr={};var Ir={before:{prop:"alpha",value:0},in:{prop:"alpha",value:1,duration:200},out:{prop:"alpha",value:0,duration:100}};const Fr=window.speechSynthesis,Lr=()=>/android/i.test((window.navigator||{}).userAgent||"");let Pr=!1,kr=null;const Br=()=>kr&&clearTimeout(kr),Ur=e=>{if(!e||kr)return Br();Fr.pause(),Fr.resume(),kr=setTimeout((()=>{Ur(e)}),5e3)},Or={lang:"en-US",pitch:1,rate:1,voice:null,volume:1};var $r={speak(e){Pr||(Or.voice=Fr.getVoices()[0],Pr=!0),this.cancel(),((e,t)=>{const r=new SpeechSynthesisUtterance(t.value);r.lang=t.lang||Or.lang,r.pitch=t.pitch||Or.pitch,r.rate=t.rate||Or.rate,r.voice=t.voice||Or.voice,r.volume=t.volume||Or.volume,r.onstart=()=>{Lr()||Ur(r),e.onstart()},r.onresume=()=>{Lr()||Ur(r),e.onresume()},r.onpause=()=>{e.onpause()},r.onend=()=>{e.onend()},r.onerror=()=>{Br(),e.onerror()},Fr.speak(r)})(this,e)},resume(){Fr.resume()},pause(){Fr.pause()},cancel(){Fr.cancel(),Br()},getVoices:()=>Fr.getVoices(),onend(){},onerror(){},onstart(){},onresume(){},onpause(){}};let Dr;const Nr=(e,t="off")=>{clearTimeout(Dr),$r.cancel(),"assertive"===t?$r.speak({value:e}):Dr=setTimeout((()=>{$r.speak({value:e})}),400)};var zr={speak:Nr,polite:e=>Nr(e,"polite"),assertive:e=>Nr(e,"assertive"),stop:()=>{$r.cancel()}};let Gr,Xr=!1;const Vr=new WeakMap,Wr=[];let Yr,Hr={},jr={},Kr=!1;const qr=e=>e.replace(/^\/+|\/+$/g,"").toLowerCase(),Zr=async(t,r,s)=>{if(s)if(Array.isArray(s))for(let t=0;t<s.length;t++)t===s.length-1?await Qr(r[e.holder],s[t]):Qr(r[e.holder],s[t]);else await Qr(r[e.holder],s);t.options&&!0===t.options.keepAlive?Vr.set(t,{view:r,focus:Yr}):(r.destroy(),r=null)},Qr=(e,t,r=!0)=>new Promise((s=>{if(r){const r=t.end;t.end=r?(...e)=>{r(...e),s()}:s,e.set(t.prop,{transition:t})}else e.set(t.prop,t.value),s()})),Jr=(e,t={},r={})=>{jr=t,Hr=r,window.location.hash=`#${e}`},es=()=>{const e=Wr.pop();if(e){Kr=!0;let t=e.path;return t.indexOf(":")>-1&&Object.keys(e.params).forEach((r=>{t=t.replace(`:${r}`,e.params[r])})),Jr(t),!0}return!1};var ts={navigate:async function(){if(Xr=!0,this.parent[e.routes]){const t=Gr,r=(document.location.hash||"/").replace(/^#/,"");let s,n=((e,t=[])=>{const r=e;e=qr(e);let s=!1,n=0;for(;!s&&n<t.length;){const i=t[n];if(i.path=qr(i.path),i.path===e)i.params={},s=i;else if(i.path.indexOf(":")>-1){const e=[...i.path.matchAll(/:([^\s/]+)/gi)];let t=i.path;e.reverse().forEach((e=>{t=t.substring(0,e.index)+"([^\\s/]+)"+t.substring(e.index+e[0].length)}));const n=r.match(new RegExp(`${t}`,"i"));n&&(i.params=e.reverse().reduce(((e,t,r)=>(e[t[1]]=n[r+1],e)),{}),s=i)}else if(i.path.endsWith("*")){const t=new RegExp(i.path.replace(/\/?\*/,"/?([^\\s]*)"),"i"),r=e.match(t);r&&(r[1]&&(i.params={path:r[1]}),s=i)}n++}return s&&(s.options={...s.options,...Hr},s.data||(s.data={}),Gr=s),s})(r,this.parent[e.routes]);if(n){if(n.hooks&&n.hooks.before&&(s=await n.hooks.before(n,t),"string"==typeof s))return Gr=t,void Jr(s);let r;n=(e=>"object"==typeof e&&null!==e)(s)?s:n,!1===Kr&&t&&!0===t.options.inHistory&&Wr.push(t),"transition"in n||(n.transition=Ir),"function"==typeof n.transition&&(n.transition=n.transition(t,n));let{view:o,focus:a}=Vr.get(n)||{};if(o)r=o[e.holder];else{r=Mr.element({parent:this[e.children][0]}),r.populate({}),r.set("w","100%"),r.set("h","100%");const t={...this[e.props],...n.params,...jr,...n.data};o=await n.component({props:t},r,this),"Module"===o[Symbol.toStringTag]&&(o.default&&"function"==typeof o.default?o=o.default({props:t},r,this):i.error("Dynamic import doesn't have a default export or default is not a function")),"function"==typeof o&&(o=o({props:t},r,this))}if(this[e.children].push(o),Yr=is.get(),a?is.set(a):is.set(o),n.transition.before)if(Array.isArray(n.transition.before))for(let e=0;e<n.transition.before.length;e++)r.set(n.transition.before[e].prop,n.transition.before[e].value);else r.set(n.transition.before.prop,n.transition.before.value);let l=!1;if(t){l=!0;const r=this[e.children].splice(1,1).pop();r&&Zr(t,r,n.transition.out)}if(n.transition.in)if(Array.isArray(n.transition.in))for(let e=0;e<n.transition.in.length;e++)e===n.transition.length-1?await Qr(r,n.transition.in[e],l):Qr(r,n.transition.in[e],l);else await Qr(r,n.transition.in,l);n.announce&&("string"==typeof n.announce&&(n.announce={message:n.announce}),zr.speak(n.announce.message,n.announce.politeness)),this.activeView=this[e.children][this[e.children].length-1]}else i.error(`Route ${r} not found`)}Kr=!1,Xr=!1},to:Jr,back:es};let rs,ss=null,ns=[];var is={_hold:!1,set hold(e){this._hold=e},get hold(){return this._hold},get:()=>ss,set(e,t){clearTimeout(rs),ss&&ss!==e.parent&&ss.unfocus(),ns.reverse().forEach((e=>e.unfocus())),e!==ss&&(rs=setTimeout((()=>{ss=e,ss.lifecycle.state="focus",t instanceof KeyboardEvent?document.dispatchEvent(new KeyboardEvent("keydown",t)):ns=[]}),this.hold?50:0))},input(t,r){if(!0===Xr)return;ns=os([ss],t);const s=ns.shift();s&&(s[e.inputEvents][t]?s[e.inputEvents][t].call(s,r):s[e.inputEvents].any&&s[e.inputEvents].any.call(s,r))}};const os=(t,r)=>!t[0][e.inputEvents]||"function"!=typeof t[0][e.inputEvents][r]&&"function"!=typeof t[0][e.inputEvents].any?t[0].parent?(t.unshift(t[0].parent),os(t,r)):[]:t,as=new Map;var ls={registerListener(e,t,r){let s=as.get(t);s||(s=new Map,as.set(t,s));let n=s.get(e);n||(n=new Set,s.set(e,n)),n.add(r)},executeListeners(e,t){const r=as.get(e);r&&r.forEach((e=>{e.forEach((e=>{e(t)}))}))},removeListeners(e){as.forEach((t=>{const r=t.get(e);r&&(r.clear(),t.delete(r))}))}},hs={focus:{value:function(t){this[e.state].hasFocus=!0,is.set(this,t)},writable:!1,enumerable:!0,configurable:!1},unfocus:{value:function(){this[e.state].hasFocus=!1,this.lifecycle.state="unfocus"},writable:!1,enumerable:!0,configurable:!1},destroy:{value:function(){this.lifecycle.state="destroy",this.$clearTimeouts(),this.$clearIntervals(),ls.removeListeners(this),cs(this[e.children]),i.debug(`Destroyed component ${this.componentId}`)},writable:!1,enumerable:!0,configurable:!1},select:{value:function(t){let r=null;return this[e.children].forEach((e=>{Array.isArray(e)?e.forEach((e=>{e.ref===t&&(r=e)})):Object.getPrototypeOf(e)===Object.prototype?Object.keys(e).forEach((s=>{e[s].ref===t&&(r=e[s])})):e.ref===t&&(r=e)})),r},writable:!1,enumerable:!0,configurable:!1},trigger:{value:function(t){L(this[e.originalState],t,!0)},writable:!1,enumerable:!0,configurable:!1},$trigger:{value:function(e){return i.warn("this.$trigger is deprecated, use this.trigger instead"),this.trigger(e)},writable:!1,enumerable:!0,configurable:!1},shader:{value:function(e,t){return{type:e,props:t}},writable:!1,enumerable:!0,configurable:!1}};const cs=function(e){for(let t=0;t<e.length;t++){if(!e[t])return;e[t].destroy&&"function"==typeof e[t].destroy?e[t].destroy():Object.getPrototypeOf(e[t])===Object.prototype&&cs(Object.values(e[t])),e[t]=null}e.length=0};var ds={$setTimeout:{value:function(t,r,...s){const n=setTimeout((()=>{this[e.timeouts]=this[e.timeouts].filter((e=>e!==n)),t.apply(null,s)}),r,s);return this[e.timeouts].push(n),n},writable:!1,enumerable:!0,configurable:!1},$clearTimeout:{value:function(t){this[e.timeouts].indexOf(t)>-1&&(this[e.timeouts]=this[e.timeouts].filter((e=>e!==t)),clearTimeout(t))},writable:!1,enumerable:!0,configurable:!1},$clearTimeouts:{value:function(){for(let t=0;t<this[e.timeouts].length;t++)clearTimeout(this[e.timeouts][t]);this[e.timeouts]=[]},writable:!1,enumerable:!0,configurable:!1},$setInterval:{value:function(t,r,...s){const n=setInterval((()=>t.apply(null,s)),r,s);return this[e.intervals].push(n),n},writable:!1,enumerable:!0,configurable:!1},$clearInterval:{value:function(t){this[e.intervals].indexOf(t)>-1&&(this[e.intervals]=this[e.intervals].filter((e=>e!==t)),clearInterval(t))},writable:!1,enumerable:!0,configurable:!1},$clearIntervals:{value:function(){for(let t=0;t<this[e.intervals].length;t++)clearInterval(this[e.intervals][t]);this[e.intervals]=[]},writable:!1,enumerable:!0,configurable:!1}},us={$emit:{value:function(e,t){ls.executeListeners(e,t)},writable:!1,enumerable:!0,configurable:!1},$listen:{value:function(e,t){ls.registerListener(this,e,t)},writable:!1,enumerable:!0,configurable:!1}},ps={$log:{value:n("App"),writable:!1,enumerable:!1,configurable:!1}},fs={$router:{value:{to:Jr,back:es,get currentRoute(){return Gr},get routes(){return this[e.routes]},get navigating(){return Xr}},writable:!1,enumerable:!0,configurable:!1}},ms={$announcer:{value:zr,writable:!1,enumerable:!0,configurable:!1}},gs={[e.renderer]:{value:()=>Ar,writable:!1,enumerable:!0,configurable:!1},[e.getChildren]:{value(){const t=this.rootParent||this.parent;return(this[e.children]||[]).concat(t&&t[e.getChildren]().map((e=>Object.getPrototypeOf(e)===Object.prototype?Object.values(e).map((e=>(e.forComponent=e.config&&e.config.parent.component,e))):e)).flat().filter((e=>{if(e&&e.component)return e.component&&e.component.componentId===this.componentId||e.forComponent&&e.forComponent.componentId===this.componentId}))||[])},writable:!1,enumerable:!0,configurable:!1}},xs=Object.defineProperties({},{...hs,...ds,...us,...ps,...fs,...ms,...gs});const ys={cast:e=>e,required:!1};var vs=(t,r=[])=>{-1===r.indexOf("ref")&&r.push("ref"),t[e.propKeys]=[],r.forEach((r=>{r={...ys,..."object"==typeof r?r:{key:r}},t[e.propKeys].push(r.key),Object.defineProperty(t,r.key,{get(){const t=r.cast(this[e.props]&&r.key in this[e.props]?this[e.props][r.key]:"default"in r?r.default:void 0);return r.required&&void 0===t&&i.warn(`${r.key} is required`),t},set(t){i.warn(`Warning! Avoid mutating props directly (${r.key})`),this[e.props][r.key]=t}})}))},Ts=(t,r=()=>{})=>{Object.defineProperty(t,e.stateKeys,{value:[],enumerable:!1,configurable:!1,writable:!1});Object.keys(r.apply(t)||{}).concat(["hasFocus"]).forEach((r=>{t[e.propKeys]&&t[e.propKeys].indexOf(r)>-1&&i.error(`State ${r} already exists as a prop`),t[e.methodKeys]&&t[e.methodKeys].indexOf(r)>-1&&i.error(`State ${r} already exists as a method`),t[e.stateKeys].push(r);try{Object.defineProperty(t,r,{get(){return this[e.state]&&r in this[e.state]&&this[e.state][r]},set(t){this[e.state]&&(this[e.state][r]=t)}})}catch(e){i.error(e)}}))},bs=(t,r)=>{t[e.computedKeys]=[];for(let s in r)t[e.stateKeys]&&t[e.stateKeys].indexOf(s)>-1?i.error(`${s} already exists as a state variable`):t[e.propKeys]&&t[e.propKeys].indexOf(s)>-1?i.error(`${s} already exists as a prop`):t[e.methodKeys]&&t[e.methodKeys].indexOf(s)>-1?i.error(`${s} already exists as a method`):("function"!=typeof r[s]&&i.warn(`${s} is not a function`),t[e.computedKeys].push(s),Object.defineProperty(t,s,{get(){return r[s].apply(this)}}))},ws=(t,r)=>{t[e.watchKeys]=[],t[e.watchers]={};for(let s in r)"function"!=typeof r[s]&&console.warn(`${s} is not a function`),t[e.watchKeys].push(s),t[e.watchers][s]=function(e,t){r[s].call(this,e,t)}};let Ss=0;function _s(t,r){return t[e.identifier]=++Ss,((e={},t)=>{R[t]={},[...Object.keys(e),...Object.getOwnPropertySymbols(e)].forEach((r=>{"function"==typeof e[r]&&(R[t][r]=e[r])}))})(r.hooks,t[e.identifier]),vs(t,r.props),r.methods&&((t,r)=>{t[e.methodKeys]=[];for(let s in r)t[e.propKeys]&&t[e.propKeys].indexOf(s)>-1?i.error(`${s} already exists as a prop`):("function"!=typeof r[s]&&i.warn(`${s} is not a function`),t[e.methodKeys].push(s),t[s]=r[s])})(t,r.methods),Ts(t,r.state),r.computed&&bs(t,r.computed),r.watch&&ws(t,r.watch),r.routes&&((t,r)=>{t[e.routes]=[],Object.keys(r).forEach((s=>{t[e.routes][s]={...r[s],options:{inHistory:!0,...r[s].options}}}))})(t,r.routes),r.input&&((t,r)=>{t[e.inputEvents]=[],Object.keys(r).forEach((s=>{"function"!=typeof r[s]&&i.warn(`${r[s]} is not a function`),t[e.inputEvents][s]=r[s]}))})(t,r.input),t}var Rs=()=>ks("Image",{template:'\n      <Element :imageSource="$imageSource" />',props:["src"],computed:{imageSource(){return/^(?:https?:)?\/\//i.test(this.src)?this.src:`${window.location.protocol}//${window.location.host}/${this.src}`}}}),Es=()=>ks("Circle",{template:'\n      <Element :color="$color" :w="$size" :h="$size" :effects="[$shader(\'radius\', {radius: $radius})]"></Element>\n    ',props:[{key:"size",default:40},"color"],computed:{radius(){return this.size/2}}});let Cs;var As=()=>ks("RouterView",{template:'\n      <Element w="100%" height="100%"></Element>\n    ',state:()=>({activeView:null}),hooks:{ready(){Cs=()=>ts.navigate.apply(this),ts.navigate.apply(this),window.addEventListener("hashchange",Cs)},destroy(){window.removeEventListener("hashchange",Cs,!1)},focus(){this.activeView&&this.activeView.focus()}},input:{back(){ts.back()}}}),Ms=()=>ks("Sprite",{template:'\n      <Element w="100%" h="100%" :texture="$texture" :color="$color" />\n    ',props:["image","map","frame","color"],state:()=>({spriteTexture:!1}),computed:{texture(){const t="frames"in this.map?Object.assign({},this.map.defaults||{},this.map.frames[this.frame]):this.map[this.frame];if(this.spriteTexture&&t)return this[e.renderer]().createTexture("SubTexture",{texture:this.spriteTexture,x:t.x,y:t.y,width:t.w,height:t.h})}},hooks:{ready(){this.spriteTexture=this[e.renderer]().createTexture("ImageTexture",{src:this.image})}}}),Is=()=>ks("FPScounter",{template:'\n      <Element>\n        <Element y="15" x="20">\n          <Element>\n            <Sprite image="$image" w="43" h="25" map="$sprite" frame="fps" />\n            <Element x="58" y="2">\n              <Sprite image="$image" x="0" h="20" w="20" map="$sprite" :frame="$fps[0]" />\n              <Sprite image="$image" x="18" h="20" w="20" map="$sprite" :frame="$fps[1]" />\n              <Sprite image="$image" x="36" h="20" w="20" map="$sprite" :frame="$fps[2]" />\n            </Element>\n          </Element>\n\n          <Element x="150">\n            <Sprite image="$image" y="2" w="48" h="25" map="$sprite" frame="avg" />\n            <Element x="63" y="2">\n              <Sprite image="$image" x="0" h="20" w="20" map="$sprite" :frame="$avgFps[0]" />\n              <Sprite image="$image" x="18" h="20" w="20" map="$sprite" :frame="$avgFps[1]" />\n              <Sprite image="$image" x="36" h="20" w="20" map="$sprite" :frame="$avgFps[2]" />\n            </Element>\n          </Element>\n\n          <Element x="0" y="40" >\n            <Sprite image="$image" x="-2" w="47" h="25" map="$sprite" frame="min" />\n            <Element x="58" y="2">\n              <Sprite image="$image" x="0" h="20" w="20" map="$sprite" :frame="$minFps[0]" />\n              <Sprite image="$image" x="18" h="20" w="20" map="$sprite" :frame="$minFps[1]" />\n              <Sprite image="$image" x="36" h="20" w="20" map="$sprite" :frame="$minFps[2]" />\n            </Element>\n          </Element>\n\n          <Element x="150" y="40">\n            <Sprite image="$image" w="53" h="25" map="$sprite" frame="max" />\n            <Element x="63" y="2">\n              <Sprite image="$image" x="0" h="20" w="20" map="$sprite" :frame="$maxFps[0]" />\n              <Sprite image="$image" x="18" h="20" w="20" map="$sprite" :frame="$maxFps[1]" />\n              <Sprite image="$image" x="36" h="20" w="20" map="$sprite" :frame="$maxFps[2]" />\n            </Element>\n          </Element>\n        </Element>\n      </Element>\n    ',state:()=>({image:"data:image/png;base64,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",sprite:{defaults:{y:1,w:20,h:20},frames:{"-":{x:-1e3},0:{x:1},1:{x:23},2:{x:45},3:{x:67},4:{x:89},5:{x:111},6:{x:133},7:{x:155},8:{x:177},9:{x:199},avg:{x:221,w:48,h:25},fps:{x:271,w:43,h:25},max:{x:316,w:53,h:25},min:{x:371,w:47,h:25}}},fps:"---",avgFps:"---",minFps:"---",maxFps:"---"}),hooks:{ready(){let e=1e4,t=0,r=0,s=0,n=0;Ar.on("fpsUpdate",((i,{fps:o})=>{e=Math.min(o,e),t=Math.max(o,t),s+=o,n++,r=Math.round(s/n),this.fps=o.toString().padStart(3,"0"),this.avgFps=r.toString().padStart(3,"0"),this.minFps=e.toString().padStart(3,"0"),this.maxFps=t.toString().padStart(3,"0")}))}}}),Fs=()=>ks("Layout",{template:'\n      <Slot ref="slot" />\n    ',props:["direction",{key:"gap",default:0}],hooks:{ready(){this.___layout()}},methods:{___layout(){let e=0;this.select("slot").children.forEach((t=>{t.set("vertical"===this.direction?"y":"x",e),e+=(t.node["vertical"===this.direction?"height":"width"]||0)+(this.gap||0)}))}}});let Ls;const Ps=e=>{throw new Error(`Parameter ${e} is required`)},ks=(r=Ps("name"),s=Ps("config"))=>{let n;const o=function(n,i,o,a){this.componentId=(e=>`BlitsComponent::${e}_${S[e]=(S[e]||0)+1}`)(r),this.lifecycle=Object.assign(Object.create(z),{component:this,previous:null,current:null}),this.parent=o,this.rootParent=a,this[e.holder]=i,this[e.id]=++_,this[e.props]=D(n.props||{},t.get("reactivityMode")),this[e.timeouts]=[],this[e.intervals]=[],this[e.originalState]={...s.state&&"function"==typeof s.state&&s.state.apply(this)||{},hasFocus:!1},this[e.state]=D(this[e.originalState],t.get("reactivityMode")),this.lifecycle.state="init",this[e.children]=s.code.render.apply(Mr,[i,this,s,Ls])||[],this[e.wrapper]=this[e.children][0],this[e.slots]=this[e.children].filter((t=>t[e.isSlot])),s.hooks&&(s.hooks.frameTick&&Ar.on("frameTick",((t,r)=>E("frameTick",this[e.identifier],this,[r]))),s.hooks.idle&&Ar.on("idle",(()=>{E("idle",this[e.identifier],this)})),s.hooks.attach&&this[e.wrapper].node.on("inBounds",(()=>{this.lifecycle.state="attach"})),s.hooks.detach&&this[e.wrapper].node.on("outOfBounds",((e,{previous:t})=>{t>0&&(this.lifecycle.state="detach")})),s.hooks.enter&&this[e.wrapper].node.on("inViewport",(()=>{this.lifecycle.state="enter"})),s.hooks.exit&&this[e.wrapper].node.on("outOfViewport",(()=>{this.lifecycle.state="exit"})));for(let t=0;t<s.code.effects.length;t++)P((()=>{s.code.effects[t].apply(Mr,[this,this[e.children],s,Ls,a,P])}));return this[e.watchers]&&Object.keys(this[e.watchers]).forEach((t=>{let r=this[t];P(((s=!1)=>{r===this[t]&&!0!==s||(this[e.watchers][t].apply(this,[this[t],r]),r=this[t])}))})),Object.getOwnPropertySymbols(this).forEach((e=>{Object.defineProperties(this,{[e]:{enumerable:!1,configurable:!1}})})),setTimeout((()=>this.lifecycle.state="ready")),this},a=(t={},a,l,h)=>(n||(i.debug(`Setting up ${r} component`),n=_s(Object.create(xs),s)),s.code||(i.debug(`Generating code for ${r} component`),s.code=f.call(s,((t="",r,s,n=null)=>{let i=0,o=0,a=[],l=null,h=0;const c=/^<\/?([a-zA-Z0-9_\-.]+)\s*/,d=/^\s*(\/?>)\s*/,p=/^([A-Za-z0-9:.\-_@]+)=\s*(["'])/,f=/^<>\s*/,m=/^\s*(<\/>)\s*/,g=e=>{i>=t.length||e()},x=e=>e.replace(/<!--.*?-->/gms,"").replace(/\r?\n\s*\r\n/gm," ").replace(/\r?\n\s*(\S)/gm," $1").replace(/\r?\n/g,"").trim(),y=e=>{const r=t.slice(i).match(e);return r&&(o=i,i+=r[0].length),r},v=()=>{y(f)?(a.push({[Symbol.for("componentType")]:null,[e.type]:"opening",[e.level]:h,[e.cursorTagStart]:o}),h++,g(v)):g(T)},T=()=>{y(m)?(h--,a.push({[Symbol.for("componentType")]:null,[e.type]:"closing",[e.level]:h}),g(v)):g(b)},b=()=>{const t=y(c);if(!t)throw C("InvalidTag");l={[Symbol.for("componentType")]:t[1],[e.level]:h,[e.cursorTagStart]:o},t[0].startsWith("</")?(h--,l[e.type]="closing",l[e.level]=h):(l[e.type]="opening",h++),g(w)},w=()=>{const r=y(d);if(r){if("/>"===r[1]){if("closing"===l[e.type])throw C("InvalidClosingTag");l[e.type]="self-closing",h--}if("opening"===l[e.type]){const e=t.slice(i,t.indexOf("<",i));e&&(l.content=e,i+=e.length)}a.push(l),g(v)}else g(S)},S=()=>{const t=y(p);if(!t)throw C("InvalidAttribute");{if("closing"===l[e.type])throw C("AttributesInClosingTag");const r=t[2],s=new RegExp(`^(.*?)${r}\\s*`),n=y(s);if(!n)throw C("MissingOrInvalidAttributeValue");{const e=_(t[1],n[1]);l[e.name]=e.value,g(w)}}},_=(e,t)=>{if(e.includes(".")){const[r,s]=e.split(".");return{name:r,value:`{${s}: ${t}}`}}return["color",":color",":effects","effects"].includes(e)?R(e,t):{name:e,value:t}},R=(e,t)=>{let r=t,s=u(r,null);if(null===s){const e=/'([^']+)'/g;let n,i=0,o="";for(;null!==(n=e.exec(t));){const e=n[1],r=n.index,a=n[0].length;o+=t.slice(i,r),s=u(e,null),o+=null===s?t.slice(r,r+a):`'${s}'`,i=r+a}o+=t.slice(i),r=o}else r=s;return{name:e,value:r}},E=t=>{let r=[],s=!1,n={children:[]},i=n;for(let n=0;n<t.length;n++){let o=t[n];if(0===o[e.level]&&"closing"!==o[e.type]){if(s)throw A("MultipleTopLevelTags",o);s=!0}if("opening"===o[e.type])r.push({[e.level]:o[e.level],[e.type]:o[e.type],[e.cursorTagStart]:o[e.cursorTagStart],[Symbol.for("componentType")]:o[Symbol.for("componentType")],parent:i});else if("closing"===o[e.type]){const t=0===r.length;let s=!1,n=!1;if(t||(s=r[r.length-1][e.level]!==o[e.level],n=r[r.length-1][Symbol.for("componentType")]!==o[Symbol.for("componentType")]),t||s||n)throw A("MismatchedClosingTag",o);i=r.pop().parent}const a={...o};delete a[e.type],delete a[e.level],delete a[e.cursorTagStart],"opening"===o[e.type]?(n+1<t.length&&"closing"!==t[n+1][e.type]&&(a.children=[]),i.children.push(a),i=a):"self-closing"===o[e.type]&&i.children.push(a)}if(r.length>0)throw A("UnclosedTags",r);return n},C=e=>{e=`${e} in ${I()}`;const r=new Error(e);r.name="TemplateParseError";const s=Math.max(0,o-10),n=Math.min(t.length,i+50),a=t.slice(s,n),l=i-s;return r.context=M(l,a),r},A=(r,s)=>{r=`${r} in ${I()}`;const n=new Error(r);function i(r){const s=Math.max(0,r[e.cursorTagStart]-10),n=t.slice(s,s+50);return M(10,n)}return n.name="TemplateStructureError",Array.isArray(s)?n.context=s.map((e=>i(e))).join("\n"):n.context=i(s),n},M=(e,t)=>`\n${t}\n${" ".repeat(e)+"^"}\n`,I=()=>n||"Blits.Application";return(()=>{t=x(t);try{return g(v),E(a)}catch(e){throw"TemplateParseError"!=e.name&&"TemplateStructureError"!=e.name||(e.message=`${e.message}\n${e.context}`),e}})()})(s.template))),Ls||(Ls={Image:Rs(),Circle:Es(),RouterView:As(),Sprite:Ms(),FPScounter:Is(),Layout:Fs()}),o.call(Object.create(n),t,a,l,h));return a.config=s,a};var Bs={Component:ks,Application:r=>{const s={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down",Enter:"enter"," ":"space",Backspace:"back",Escape:"escape",37:"left",39:"right",38:"up",40:"down",13:"enter",32:"space",8:"back",27:"escape"};let n,i,o;return r.hooks=r.hooks||{},r.hooks[e.destroy]=function(){document.removeEventListener("keydown",n),document.removeEventListener("keyup",i)},r.hooks[e.init]=function(){const e={...s,...t.get("keymap",{})};n=t=>{const r=e[t.key]||e[t.keyCode]||t.key||t.keyCode;is.input(r,t),clearTimeout(o),o=setTimeout((()=>{is.hold=!0}),50)},i=()=>{clearTimeout(o),is.hold=!1},document.addEventListener("keydown",n),document.addEventListener("keyup",i),setTimeout((()=>is.set(this)))},ks("App",r)},Launch:(e,r,s)=>{t.set(s),i=n("Blits"),Mr.element=Er,Ar=Cr(e,r,s)}};export{Bs as default};
//# sourceMappingURL=blits.min.js.map
